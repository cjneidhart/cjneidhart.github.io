window.storyFormat({"name":"Brick","version":"0.1","author":"OrangeChris","image":"icon.svg","description":"A fully featured, highly customizable story format with numerous programming features and a rich passage editor. No Harlowe experience required. <a href=\"https://github.com/cjneidhart/brick\">Homepage</a>","source":"<!DOCTYPE html>\n<html lang=\"en-US\" data-bs-theme=\"dark\">\n\n<head>\n  <meta charset=\"utf-8\">\n  <title>{{STORY_NAME}}</title>\n  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\n  <style id=\"style-bootstrap\">\n    /*!\n * Bootstrap Reboot v5.3.3 (https://getbootstrap.com/)\n * Copyright 2011-2024 The Bootstrap Authors\n * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)\n */:root,[data-bs-theme=light]{--bs-blue:#0d6efd;--bs-indigo:#6610f2;--bs-purple:#6f42c1;--bs-pink:#d63384;--bs-red:#dc3545;--bs-orange:#fd7e14;--bs-yellow:#ffc107;--bs-green:#198754;--bs-teal:#20c997;--bs-cyan:#0dcaf0;--bs-black:#000;--bs-white:#fff;--bs-gray:#6c757d;--bs-gray-dark:#343a40;--bs-gray-100:#f8f9fa;--bs-gray-200:#e9ecef;--bs-gray-300:#dee2e6;--bs-gray-400:#ced4da;--bs-gray-500:#adb5bd;--bs-gray-600:#6c757d;--bs-gray-700:#495057;--bs-gray-800:#343a40;--bs-gray-900:#212529;--bs-primary:#0d6efd;--bs-secondary:#6c757d;--bs-success:#198754;--bs-info:#0dcaf0;--bs-warning:#ffc107;--bs-danger:#dc3545;--bs-light:#f8f9fa;--bs-dark:#212529;--bs-primary-rgb:13,110,253;--bs-secondary-rgb:108,117,125;--bs-success-rgb:25,135,84;--bs-info-rgb:13,202,240;--bs-warning-rgb:255,193,7;--bs-danger-rgb:220,53,69;--bs-light-rgb:248,249,250;--bs-dark-rgb:33,37,41;--bs-primary-text-emphasis:#052c65;--bs-secondary-text-emphasis:#2b2f32;--bs-success-text-emphasis:#0a3622;--bs-info-text-emphasis:#055160;--bs-warning-text-emphasis:#664d03;--bs-danger-text-emphasis:#58151c;--bs-light-text-emphasis:#495057;--bs-dark-text-emphasis:#495057;--bs-primary-bg-subtle:#cfe2ff;--bs-secondary-bg-subtle:#e2e3e5;--bs-success-bg-subtle:#d1e7dd;--bs-info-bg-subtle:#cff4fc;--bs-warning-bg-subtle:#fff3cd;--bs-danger-bg-subtle:#f8d7da;--bs-light-bg-subtle:#fcfcfd;--bs-dark-bg-subtle:#ced4da;--bs-primary-border-subtle:#9ec5fe;--bs-secondary-border-subtle:#c4c8cb;--bs-success-border-subtle:#a3cfbb;--bs-info-border-subtle:#9eeaf9;--bs-warning-border-subtle:#ffe69c;--bs-danger-border-subtle:#f1aeb5;--bs-light-border-subtle:#e9ecef;--bs-dark-border-subtle:#adb5bd;--bs-white-rgb:255,255,255;--bs-black-rgb:0,0,0;--bs-font-sans-serif:system-ui,-apple-system,\"Segoe UI\",Roboto,\"Helvetica Neue\",\"Noto Sans\",\"Liberation Sans\",Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\",\"Segoe UI Symbol\",\"Noto Color Emoji\";--bs-font-monospace:SFMono-Regular,Menlo,Monaco,Consolas,\"Liberation Mono\",\"Courier New\",monospace;--bs-gradient:linear-gradient(180deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0));--bs-body-font-family:var(--bs-font-sans-serif);--bs-body-font-size:1rem;--bs-body-font-weight:400;--bs-body-line-height:1.5;--bs-body-color:#212529;--bs-body-color-rgb:33,37,41;--bs-body-bg:#fff;--bs-body-bg-rgb:255,255,255;--bs-emphasis-color:#000;--bs-emphasis-color-rgb:0,0,0;--bs-secondary-color:rgba(33, 37, 41, 0.75);--bs-secondary-color-rgb:33,37,41;--bs-secondary-bg:#e9ecef;--bs-secondary-bg-rgb:233,236,239;--bs-tertiary-color:rgba(33, 37, 41, 0.5);--bs-tertiary-color-rgb:33,37,41;--bs-tertiary-bg:#f8f9fa;--bs-tertiary-bg-rgb:248,249,250;--bs-heading-color:inherit;--bs-link-color:#0d6efd;--bs-link-color-rgb:13,110,253;--bs-link-decoration:underline;--bs-link-hover-color:#0a58ca;--bs-link-hover-color-rgb:10,88,202;--bs-code-color:#d63384;--bs-highlight-color:#212529;--bs-highlight-bg:#fff3cd;--bs-border-width:1px;--bs-border-style:solid;--bs-border-color:#dee2e6;--bs-border-color-translucent:rgba(0, 0, 0, 0.175);--bs-border-radius:0.375rem;--bs-border-radius-sm:0.25rem;--bs-border-radius-lg:0.5rem;--bs-border-radius-xl:1rem;--bs-border-radius-xxl:2rem;--bs-border-radius-2xl:var(--bs-border-radius-xxl);--bs-border-radius-pill:50rem;--bs-box-shadow:0 0.5rem 1rem rgba(0, 0, 0, 0.15);--bs-box-shadow-sm:0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);--bs-box-shadow-lg:0 1rem 3rem rgba(0, 0, 0, 0.175);--bs-box-shadow-inset:inset 0 1px 2px rgba(0, 0, 0, 0.075);--bs-focus-ring-width:0.25rem;--bs-focus-ring-opacity:0.25;--bs-focus-ring-color:rgba(13, 110, 253, 0.25);--bs-form-valid-color:#198754;--bs-form-valid-border-color:#198754;--bs-form-invalid-color:#dc3545;--bs-form-invalid-border-color:#dc3545}[data-bs-theme=dark]{color-scheme:dark;--bs-body-color:#dee2e6;--bs-body-color-rgb:222,226,230;--bs-body-bg:#212529;--bs-body-bg-rgb:33,37,41;--bs-emphasis-color:#fff;--bs-emphasis-color-rgb:255,255,255;--bs-secondary-color:rgba(222, 226, 230, 0.75);--bs-secondary-color-rgb:222,226,230;--bs-secondary-bg:#343a40;--bs-secondary-bg-rgb:52,58,64;--bs-tertiary-color:rgba(222, 226, 230, 0.5);--bs-tertiary-color-rgb:222,226,230;--bs-tertiary-bg:#2b3035;--bs-tertiary-bg-rgb:43,48,53;--bs-primary-text-emphasis:#6ea8fe;--bs-secondary-text-emphasis:#a7acb1;--bs-success-text-emphasis:#75b798;--bs-info-text-emphasis:#6edff6;--bs-warning-text-emphasis:#ffda6a;--bs-danger-text-emphasis:#ea868f;--bs-light-text-emphasis:#f8f9fa;--bs-dark-text-emphasis:#dee2e6;--bs-primary-bg-subtle:#031633;--bs-secondary-bg-subtle:#161719;--bs-success-bg-subtle:#051b11;--bs-info-bg-subtle:#032830;--bs-warning-bg-subtle:#332701;--bs-danger-bg-subtle:#2c0b0e;--bs-light-bg-subtle:#343a40;--bs-dark-bg-subtle:#1a1d20;--bs-primary-border-subtle:#084298;--bs-secondary-border-subtle:#41464b;--bs-success-border-subtle:#0f5132;--bs-info-border-subtle:#087990;--bs-warning-border-subtle:#997404;--bs-danger-border-subtle:#842029;--bs-light-border-subtle:#495057;--bs-dark-border-subtle:#343a40;--bs-heading-color:inherit;--bs-link-color:#6ea8fe;--bs-link-hover-color:#8bb9fe;--bs-link-color-rgb:110,168,254;--bs-link-hover-color-rgb:139,185,254;--bs-code-color:#e685b5;--bs-highlight-color:#dee2e6;--bs-highlight-bg:#664d03;--bs-border-color:#495057;--bs-border-color-translucent:rgba(255, 255, 255, 0.15);--bs-form-valid-color:#75b798;--bs-form-valid-border-color:#75b798;--bs-form-invalid-color:#ea868f;--bs-form-invalid-border-color:#ea868f}*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:var(--bs-body-font-family);font-size:var(--bs-body-font-size);font-weight:var(--bs-body-font-weight);line-height:var(--bs-body-line-height);color:var(--bs-body-color);text-align:var(--bs-body-text-align);background-color:var(--bs-body-bg);-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;border:0;border-top:var(--bs-border-width) solid;opacity:.25}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2;color:var(--bs-heading-color)}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.1875em;color:var(--bs-highlight-color);background-color:var(--bs-highlight-bg)}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:rgba(var(--bs-link-color-rgb),var(--bs-link-opacity,1));text-decoration:underline}a:hover{--bs-link-color-rgb:var(--bs-link-hover-color-rgb)}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:var(--bs-font-monospace);font-size:1em}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:var(--bs-code-color);word-wrap:break-word}a>code{color:inherit}kbd{padding:.1875rem .375rem;font-size:.875em;color:var(--bs-body-bg);background-color:var(--bs-body-color);border-radius:.25rem}kbd kbd{padding:0;font-size:1em}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:var(--bs-secondary-color);text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]:not([type=date]):not([type=datetime-local]):not([type=month]):not([type=week]):not([type=time])::-webkit-calendar-picker-indicator{display:none!important}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}::file-selector-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}\n/* */\n  </style>\n  <style id=\"style-brick\">\n    #brick-viewport{display:flex;flex-direction:column}#brick-viewport>*{flex:1}.brick-linkReplace,.brick-active-passage{transition:opacity .4s}.brick-transparent{opacity:0}#ui-bar{border-bottom:1px solid var(--bs-border-color);overflow-block:auto;padding:.5rem;width:100%}.brick-sidebar-btn{background:none;border:1px solid var(--bs-border-color);padding-block:.25rem;transition:color .15s ease-in-out,background-color .15s ease-in-out}.brick-sidebar-btn:hover:enabled{color:var(--bs-emphasis-color);background-color:var(--bs-secondary-bg)}.brick-sidebar-btn:disabled{color:var(--bs-secondary)}#brick-history-controls{display:flex;flex-direction:row;text-align:center;width:100%;margin-bottom:.5rem}#brick-history-controls>*{flex-grow:1}#story-title{text-align:center}#brick-menu-core{width:100%;text-align:center;list-style:none;padding:0}#brick-menu-core button{width:100%}#brick-main{max-width:60rem}.brick-passage{padding:1rem}.brick-passage:not(:last-child){border-bottom:1px solid currentColor;padding-bottom:1rem}.brick-active-passage{margin-bottom:5rem;min-height:100vh}@media (min-width: 60rem){#brick-viewport{flex-direction:row}#ui-bar{border-bottom:0;border-right:1px solid var(--bs-border-color);height:100vh;height:100dvh;max-width:24rem;position:sticky;top:0;width:auto}#brick-main{margin-inline:auto}.brick-active-passage{min-height:unset}}#brick-dialog{border-color:var(--bs-border-color);border-radius:.5rem;margin-top:2rem;max-width:min(95vw,50rem);max-width:min(95svw,50rem);min-width:min(95vw,30rem);min-width:min(95svw,30rem);overflow-x:auto}#brick-dialog::backdrop{-webkit-backdrop-filter:brightness(50%) blur(.25rem);backdrop-filter:brightness(50%) blur(.25rem)}#brick-dialog.brick-saves table{border:1px solid var(--bs-border-color);width:100%}#brick-dialog.brick-saves table :is(th,td){border:1px solid var(--bs-border-color);padding:.25rem}#brick-dialog.brick-saves table td:nth-child(3){width:100%}#brick-dialog.brick-saves table td:last-child button:enabled{background-color:var(--bs-danger)}#brick-dialog.brick-saves table td:last-child button:enabled:hover{background-color:inherit;color:var(--bs-danger)}.brick-link{padding:0;border:0;background:none;text-decoration:underline var(--bs-link-color);color:var(--bs-link-color)}.brick-link:hover:enabled{color:var(--bs-link-hover-color);text-decoration-color:var(--bs-link-hover-color)}.brick-link:disabled{color:var(--bs-secondary);cursor:not-allowed;text-decoration-color:var(--bs-secondary)}.brick-text-secondary{color:var(--bs-secondary)}.brick-error{background-color:hsl(0 80 20);border-inline:.25rem solid red;line-height:2;padding:.25rem}.brick-error code{background-color:var(--bs-body-bg);color:var(--bs-body-color);padding:.125rem}.brick-saves-menu ul{border:1px solid currentColor;list-style:none;padding:0}.brick-saves-menu li:not(:first-child){border-top:1px solid currentColor}.brick-saves-menu li{display:flex;flex-direction:row;padding:.25rem}.brick-saves-menu li>div{flex-grow:1}.brick-saves-empty{color:var(--bs-secondary)}.brick-saves-buttons{display:flex;flex-direction:row;justify-content:space-between}\n\n  </style>\n</head>\n\n<body>\n  {{STORY_DATA}}\n  <div id=\"brick-viewport\">\n    <aside id=\"ui-bar\">\n      <div id=\"brick-history-controls\">\n        <button id=\"brick-history-backward\" class=\"brick-sidebar-btn\" type=\"button\">&#x2190;</button>\n        <button id=\"brick-history-forward\" class=\"brick-sidebar-btn\" type=\"button\">&#x2192;</button>\n      </div>\n      <h1 id=\"story-title\">{{STORY_NAME}}</h1>\n      <ul id=\"brick-menu-core\">\n        <li><button id=\"brick-saves\" class=\"brick-sidebar-btn\" type=\"button\">SAVES</button></li>\n        <li><button id=\"brick-restart\" class=\"brick-sidebar-btn\" type=\"button\">RESTART</button></li>\n      </ul>\n    </aside>\n\n    <main id=\"brick-main\">\n      <noscript>JavaScript must be enabled to play this story.</noscript>\n    </main>\n  </div>\n  <dialog id=\"brick-dialog\"></dialog>\n  <script id=\"script-brick\" type=\"text/javascript\">\"use strict\";(()=>{var ut=Object.defineProperty;var mt=(e,t)=>{for(var n in t)ut(e,n,{get:t[n],enumerable:!0})};var A={maxLoopIterations:1e4,preProcessText:void 0,stream:!1};function pt(e,t,n){throw new TypeError(`${e}: expected ${t}, got ${typeof n}`)}var g={get maxLoopIterations(){return A.maxLoopIterations},set maxLoopIterations(e){if(typeof e!=\"number\"||e<=0||e%1!==0)throw new TypeError(\"Config.maxLoopIterations must be a positive integer\");A.maxLoopIterations=e},get preProcessText(){return A.preProcessText},set preProcessText(e){typeof e<\"u\"&&typeof e!=\"function\"&&pt(\"Config.preProcessText\",\"function or undefined\",e),A.preProcessText=e},get stream(){return A.stream},set stream(e){A.stream=!!e}};var R={};mt(R,{Passage:()=>P,filter:()=>Te,find:()=>kt,get:()=>S,init:()=>ae,start:()=>ce,withTag:()=>Et});var dt=new Set(\"'\\\",()[]{}.!`?\");function B(e){return Array.from(e).map(t=>t>=\"a\"&&t<=\"z\"||t>=\"0\"&&t<=\"9\"?t:t>=\"A\"&&t<=\"Z\"||t>\"\\x7F\"?t.toLowerCase():dt.has(t)?\"\":\"-\").join(\"\").replace(/-+/g,\"-\")}function ve(e,t){let n=-1,r=0;for(;n=e.indexOf(t,n+1),n!==-1;)r++;return r}function y(e){switch(typeof e){case\"bigint\":case\"boolean\":case\"number\":case\"string\":case\"undefined\":return e;case\"symbol\":throw new Error(\"Symbols cannot be cloned\");case\"function\":throw new Error(\"Functions cannot be cloned\");case\"object\":if(e===null)return e;if(\"clone\"in e&&typeof e.clone==\"function\")return e.clone();if(e instanceof Array)return e.map(y);if(e instanceof Date)return new Date(e);if(e instanceof Map){let t=new Map;for(let[n,r]of e)t.set(y(n),y(r));return t}else{if(e instanceof RegExp)return new RegExp(e);if(e instanceof Set){let t=new Set;for(let n of e)t.add(y(n));return t}else{let t=Object.getPrototypeOf(e);if(t!==null&&t!==Object.prototype)throw new Error(\"Can't clone an object with an unknown prototype and no `.clone()` method\");let n={};for(let r in e)n[r]=y(e[r]);return n}}default:throw new Error(`Unknown type: ${typeof e}`)}}function J(e){let t=document.getElementById(e);if(!t)throw new Error(`No element with id \"${e}\" found`);return t}var ft=0;function Ne(){return`brick-unique-id-${ft++}`}function c(e,t={},...n){let r=document.createElement(e);for(let s in t)r.setAttribute(s,t[s]);return r.append(...n),r}function*Se(e,t,n=1){let r;if(typeof t>\"u\"?(r=0,t=e):r=e,n>0)for(;r<t;)yield r,r+=n;else for(;r>t;)yield r,r+=n}var P=class{#e;constructor(t){let n=t.getAttribute(\"pid\");if(!n)throw new Error(\"Passage has no pid: \"+t.outerHTML);let r=t.getAttribute(\"name\");if(!r)throw new Error(`Passage ${n} has no name`);this.id=n,this.name=r,this.slug=B(r),this.tags=t.getAttribute(\"tags\")?.split(\" \").filter(s=>s.length>=0)||[],this.#e=t}get content(){return this.#e.textContent||\"\"}},gt=[\"PassageDone\",\"PassageFooter\",\"PassageHeader\",\"PassageReady\",\"StoryAuthor\",\"StoryBanner\",\"StoryCaption\",\"StoryDisplayTitle\",\"StoryInit\",\"StoryInterface\",\"StoryMenu\",\"StorySettings\",\"StorySubtitle\",\"StoryTitle\"],wt=[\"init\",\"script\",\"stylesheet\",\"Twine.audio\",\"Twine.image\",\"Twine.video\",\"Twine.vtt\",\"widget\",\"header\",\"footer\",\"startup\",\"debug-header\",\"debug-footer\",\"debug-startup\",\"nobr\"];function bt(e){if(gt.includes(e))throw new Error(`The passage name \"${e}\" is not allowed`)}function yt(e,t){for(let n of e)if(wt.includes(n))throw new Error(`The tag '${n}' on the passage \"${t} is not allowed`)}var oe=new Map,C=new Map,ie;function ae(e){let t=e.getElementsByTagName(\"tw-passagedata\");for(let r of t){let s=new P(r),{id:o,name:i}=s;if(bt(s.name),s.name.startsWith(\"::\")&&console.warn(`Found a passage named \"${i}\". Although starting a passage name with \"::\" is allowed, this is likely a mistake.`),yt(s.tags,i),oe.has(o))throw new Error(`Duplicate passage id ${o}`);if(C.has(i))throw new Error(`Duplicate passage name ${i}`);s.content.trim()||console.warn(`Passage ${i} has no text.`),oe.set(o,s),C.set(i,s)}let n=e.getAttribute(\"startnode\");if(n){let r=oe.get(n);if(!r)throw new Error(`Could not determine starting passage; no passage with ${n}`);ie=r}else{let r=C.get(\"Start\");if(!r)throw new Error('Could not find a passage named \"Start\"');ie=r}}function Te(e){let t=[];for(let n of C.values())e(n)&&t.push(n);return t}function kt(e){for(let t of C.values())if(e(t))return t}function S(e){return C.get(e)}function ce(){return ie}function Et(e){return Te(t=>t.tags.includes(e))}var W=class extends Error{constructor(t,n,r){super(`in \\u201C${n}\\u201D at line ${r}: ${t}`),this.passage=n,this.lineNumber=r}};var u={closeTag:/>/y,commentBlock:/\\*(?:[^])*?\\*\\//y,commentLine:/\\/.*\\n?/y,elementName:/([-\\p{ID_Continue}]+)(#[-\\p{ID_Continue}]+)?((?:\\.[-\\p{ID_Continue}]+)*)/uy,htmlAttr:/\\s*([-_\\p{ID_Start}][-\\p{ID_Continue}]*)=\"([^\"]*)\"/uy,htmlEvalAttr:/\\s*([-_\\p{ID_Start}][-\\p{ID_Continue}]*)=\\(/uy,js:{binaryOperator:/[%&*<=>^|]+/y,closingParen:/\\s*\\)/y,closingSquareBracket:/\\s*\\]/y,field:/\\.\\p{ID_Start}[$\\p{ID_Continue}]*/uy,identifier:/\\p{ID_Start}[$\\p{ID_Continue}]*/uy,number:/[0-9]+/y,operator:/[!%&*+-<=>^|~]+/y,regexp:/(?:[^\\\\[/]|\\\\[^]|\\[(?:[^\\\\\\]]|\\\\[^])*\\])*\\/(?:$|\\p{ID_Continue})*/uy,stringDouble:/\"(?:[^\\\\\"]|\\\\[^])*\"/y,stringSingle:/'(?:[^\\\\']|\\\\[^])*'/y,normalInTemplateString:/(?:[^`$\\\\]|\\\\[^]|\\$(?!\\{))*/y},macroArgsStart:/ *\\(/y,macroBodyStart:/\\s*\\{/y,macroName:/[-_=<>\\p{ID_Start}][-=<>\\p{ID_Continue}]*/uy,normalChars:/[^[\\]{}\\\\($_?<@/]+/y,singleChar:/[^]/y,whitespace:/\\s*/y},xt=[\"base\",\"body\",\"link\",\"head\",\"html\",\"meta\",\"script\",\"style\",\"title\"],vt=[\"area\",\"base\",\"br\",\"col\",\"embed\",\"hr\",\"img\",\"input\",\"link\",\"meta\",\"param\",\"source\",\"track\",\"wbr\"];function z(e){return typeof e==\"object\"&&e.type===\"macro\"}var $=class{constructor(t,n,r){this.input=t,this.index=0,this.passageName=n,this.lineNumber=r||1}consume(t){t.lastIndex=this.index;let n=t.exec(this.input);return n&&(this.lineNumber+=ve(n[0],`\n`),this.index=t.lastIndex),n}lookahead(){return this.input[this.index]||null}locationSample(){if(this.input[this.index]===`\n`){let r=this.input.lastIndexOf(`\n`,this.index-1)+1;return this.input.slice(r,this.index)}let t=this.input.lastIndexOf(`\n`,this.index-1)+1,n=this.input.indexOf(`\n`,this.index+1);return this.input.slice(t,n)}error(t){return{type:\"error\",passageName:this.passageName,lineNumber:this.lineNumber,message:t,locationSample:this.locationSample()}}parse(t){let n=[],r=0;e:for(;this.index<this.input.length;){if(r>=1e6)return n.push(this.error(\"Parser stuck in infinite loop\")),n;r++;let s=this.index;if(this.consume(u.normalChars),this.index!==s&&n.push(this.input.substring(s,this.index)),t&&this.consume(t))return n;let o=this.consume(u.singleChar)?.[0];switch(o){case\"\\\\\":{let i=this.consume(u.singleChar);n.push(i?.[0]||`\n`);break}case\"<\":n.push(this.parseElement());break;case\"@\":n.push(this.parseMacro());break;case\"/\":switch(this.lookahead()){case\"/\":this.consume(u.commentLine);break;case\"*\":if(!this.consume(u.commentBlock))return n.push(this.error(\"Missing trailing `*/` to close the block comment\")),n;break;default:n.push(o);break}break;case\"$\":{n.push(this.parseNakedVariable(\"story\"));break}case\"_\":{n.push(this.parseNakedVariable(\"temp\"));break}case\"[\":if(this.lookahead()===\"[\"){this.index++;let i=this.consume(/((?:[^\\\\\\]]|\\\\.)*)\\]\\]/y);if(!i)throw new Error(\"Unmatched `[[`\");let a=i[1],l=a.includes(\"->\"),m=a.includes(\"<-\"),p=a.includes(\"|\"),h=Number(l)+Number(m)+Number(p);if(h>1)n.push(this.error(\"Link boxes can only have one of '->', '<-', or '|'\"));else if(h===0)n.push({type:\"linkBox\",passageName:this.passageName,lineNumber:this.lineNumber,link:a,text:a});else{let b=l?\"->\":m?\"<-\":\"|\";n.push(this.makeLinkBox(a,b))}}else n.push(\"[\");break;case\"]\":case\"?\":case\">\":throw new Error(`Cannot yet handle unescaped '${o}' (U+${o.charCodeAt(0)})`);case void 0:break e;default:throw new Error(`Logic Error (${o})`)}}if(t&&!this.consume(t))throw new Error(`Failed to match regex \"${t.source}\"`);return n}parseElement(){let t=this.consume(u.elementName);if(!t)return this.error(\"Element names can contain only hyphens, underscores, and ASCII letters and numbers\");let[n,r,s,o]=t,i=new Map,a=new Map;for(s&&i.set(\"id\",s.slice(1)),o.length&&i.set(\"class\",o.replace(\".\",\" \").trim()),this.consume(u.whitespace);!this.consume(u.closeTag);){let m=this.consume(u.htmlAttr);if(m){let[p,h,b]=m;i.has(h)||a.has(h)?console.warn(`Ignoring duplicate attribute '${h}`):i.set(h,b)}else if(m=this.consume(u.htmlEvalAttr),m){let p=m[1],h=this.parseJsExpression();if(h.trim()===\"\")throw new Error(`Empty JavaScript attribute \"${p}\"`);if(this.lookahead()!==\")\")throw new Error(`No closing paren on dynamic attribute \"${p}\"`);this.index++,i.has(p)||a.has(p)?console.warn(`Ignoring duplicate attribute '${p}`):a.set(p,h)}else return this.error(\"Missing trailing `>` to close the HTML tag\")}let l=vt.includes(r)?[]:this.parse(new RegExp(`</${r}>`,\"y\"));return xt.includes(r)?this.error(`Passages cannot contain \"<${r}>\" elements`):{type:\"element\",passageName:this.passageName,lineNumber:this.lineNumber,name:r,attributes:i,evalAttributes:a,content:l}}parseNakedVariable(t){let n=this.index,r=this.consume(u.js.identifier);if(!r){let i=t===\"story\"?\"$\":\"_\";return this.error(`${i} must be part of a ${t} variable, or escaped with a backslash \\`\\\\\\``)}let s=r[0],o=this.index;for(;;){switch(this.lookahead()){case\".\":if(r=this.consume(u.js.field),r)continue;break;case\"[\":this.index++,this.parseJsArgs(\"]\");continue;case\"(\":this.index++,this.parseJsArgs(\")\");continue}break}return this.index===o?{type:t,passageName:this.passageName,lineNumber:this.lineNumber,name:s}:{type:\"macro\",name:\"print\",args:[(t===\"story\"?\"Engine.vars.\":\"Engine.temp.\")+this.input.substring(n,this.index)],passageName:this.passageName,lineNumber:this.lineNumber}}parseMacro(){let t=this.consume(u.macroName),n;if(t)n=t[0];else if(this.lookahead()===\"(\")n=\"\";else return this.error(\"`@` must be followed by a macro name, or be escaped with a `\\\\`\");let r=null;this.consume(u.macroArgsStart)&&(r=n===\"for\"?this.parseForArgs():this.parseJsArgs(\")\"));let s=this.consume(u.macroBodyStart);if(!r&&!s)return this.error(\"Macro invocations must be followed by `(` or `[`\");let o=s?this.parse(/\\}/y):void 0;return{type:\"macro\",name:n,args:r||[],content:o,passageName:this.passageName,lineNumber:this.lineNumber}}parseForArgs(){let t=this.consume(/\\s*([^]*?)\\s+of\\b/y);if(!t)throw new Error(\"Could not find 'of' in @for macro\");let n=t[1],r=this.parseJsExpression();if(r.trim()===\"\")throw new Error(\"Right-hand side of a for macro must be an Iterable\");if(!this.consume(/\\s*\\)/y))throw new Error(\"No closing paren\");return[n,r]}parseJsArgs(t){let n=[],r;for(;(r=this.parseJsExpression())&&(n.push(r),!!this.consume(/\\s*,/uy)););if(this.consume(u.whitespace),this.lookahead()!==t)throw new Error(`Missing a closing \\`${t}\\``);return this.index++,n}parseJsExpression(){let t=[],n=[],r=!0,s,o=0;e:for(;this.index<this.input.length;){if(this.index===o)throw new Error(`Infinite loop at index ${o} (${this.input[this.index]})`);if(o=this.index,s=this.consume(u.whitespace),s&&n.push(s[0]),s=this.consume(u.js.identifier),s){n.push(s[0]),r=!1;continue}if(s=this.consume(u.js.number),s){n.push(s[0]),r=!1;continue}if(s=this.consume(u.js.binaryOperator),s){n.push(s[0]),r=!0;continue}let i=this.lookahead();switch(i){case'\"':if(s=this.consume(u.js.stringDouble),s)n.push(s[0]),r=!1;else throw new Error(\"Unclosed double-quoted string\");break;case\"'\":if(s=this.consume(u.js.stringSingle),s)n.push(s[0]),r=!1;else throw new Error(\"Unclosed single-quoted string\");break;case\"`\":this.index++,n.push(i),this.parseJsTemplateString(n),r=!1;break;case\"(\":t.push(\")\"),n.push(i),this.index++,r=!0;break;case\"[\":t.push(\"]\"),n.push(i),this.index++,r=!0;break;case\"{\":t.push(\"}\"),n.push(i),this.index++,r=!1;break;case\"$\":if(this.index++,s=this.consume(u.js.identifier),s)n.push(\"Engine.vars.\",s[0]),r=!1;else throw new Error(\"Illegal identifier\");break;case\"_\":if(this.index++,s=this.consume(u.js.identifier),s)n.push(\"Engine.temp.\",s[0]),r=!1;else throw new Error(\"Illegal identifier\");break;case\",\":if(t.length>0)this.index++,n.push(i),r=!0;else break e;break;case\"#\":case\":\":case\";\":case\"?\":case\".\":r=!0,n.push(i),this.index++;break;case\"!\":this.index++,this.lookahead()===\"=\"?(this.index++,this.lookahead()===\"=\"?(this.index++,n.push(\"!==\")):n.push(\"!=\"),r=!0):(n.push(i),r=!1);break;case\"+\":case\"-\":{n.push(i),this.index++;let a=this.lookahead();a===i?(n.push(a),this.index++,r=!1):a===\"=\"?(this.index++,r=!0,n.push(\"=\")):r=!0}break;case\"~\":n.push(i),this.index++,r=!0;break;case\"/\":if(this.index++,this.consume(u.commentLine))n.push(`\n`);else if(s=this.consume(u.commentBlock))s[0].includes(`\n`)&&n.push(`\n`);else if(r){if(n.push(i),s=this.consume(u.js.regexp),!s)throw new Error(\"Invalid RegExp literal\");n.push(s[0]),r=!1}else n.push(i),r=!0;break;default:if(i&&i===t[t.length-1]){this.index++,n.push(i),t.pop();break}if(![\")\",\"]\",\"}\"].includes(i||\"\"))throw new Error(`Can't handle unescaped ${i} yet`);break e}}if(t.length>0)throw new Error(`Expected a \"${t.pop()}\"`);return n.join(\"\")}parseJsTemplateString(t){for(;;){let n=this.consume(u.js.normalInTemplateString);n&&t.push(n[0]);let r=this.lookahead();if(!r)throw new Error(\"Unclosed template string\");switch(r){case\"`\":t.push(r),this.index++;return;case\"$\":if(this.index+=2,t.push(\"${\"),t.push(this.parseJsExpression()),this.lookahead()!==\"}\")throw Error('missing \"}\" inside template string');this.index++,t.push(\"}\");break;default:throw Error(`Logic Error: '${r}' (U+${r.charCodeAt(0)}) was not matched by regex`)}}}makeLinkBox(t,n){let r=t.split(n);if(r.length!==2){let s=`Links in [[...]] can only contain \"${n}\" once`;return this.error(s)}return n===\"<-\"?{type:\"linkBox\",passageName:this.passageName,lineNumber:this.lineNumber,link:r[0],text:r[1]}:{type:\"linkBox\",passageName:this.passageName,lineNumber:this.lineNumber,link:r[1],text:r[0]}}};var X={Engine:{forward:Z,backward:Y,redo:Me,get vars(){return T},get temp(){return E}},Config:g,Dialog:{showPassage:De},Passages:R,clone:y,slugify:B,makeElement:c,numberRange:Se},Ie=Object.keys(X),Le=Object.values(X);function _(e){return new Function(...Ie,`'use strict';${e}`)(...Le)}function k(e){return _(\"return \"+e)}function le(e,t){new Function(...Ie,`\"use strict\"; ${e} = arguments[arguments.length - 1]`)(...Le,t)}var O=class{constructor(t,n,r,s,o){this.name=t,this.loopStatus=s?.loopStatus||1,this.content=o,this.passageName=n,this.lineNumber=r,s?.captures&&(this.captures=s.captures)}render(t,n){switch(n||=this.content||[],this.loopStatus){case 1:case 2:x(t,n,this);break;case 3:case 4:break;default:throw new Error(`unknown loopStatus: \"${this.loopStatus}\"`)}}createCallback(t){let n=this;return function(...s){if(!n.captures)return t.apply(this,s);let o={};for(let a of n.captures)a.name in o||(o[a.name]=E[a.name]),E[a.name]=a.value;let i;try{i=t.apply(this,s)}finally{Object.assign(E,o)}return i}}},F=new Map;function d(e,t){F.has(e)&&console.warn(`Replacing an existing macro: \"${e}\"`),F.set(e,t)}function Ae(e,t){let n=F.get(e);if(!n)throw new Error(`No macro \"${e}\" found`);F.set(t,n)}function ue(e){return F.get(e)||null}d(\"include\",{handler(...e){let[t,n]=e;if(e.length<1||e.length>2)throw new Error(\"@include must be called with 1 argument\");if(typeof t!=\"string\")throw new Error(\"@include: first arg (passage name) must be a string\");if(typeof n<\"u\"&&typeof n!=\"string\")throw new Error(\"@include: second arg (element type) must be a string or undefined\");let r=n||\"div\",s=S(t);if(!s)throw new Error(`Passage not found: \"${t}\"`);let o=c(r);return this.render(o,s),o}});d(\"\",{skipArgs:!0,handler(...e){return _(e.join(\", \")),document.createDocumentFragment()}});d(\"print\",{handler(...e){if(e.length!==1)throw new Error(`@${this.name}: requires 1 argument (got ${e.length})`);if(this.content)throw new Error(`@${this.name}: no body allowed`);return String(e[0])}});Ae(\"print\",\"-\");d(\"render\",{handler(...e){if(e.length!==1)throw new Error(`@${this.name}: requires 1 argument (got ${e.length})`);if(this.content)throw new Error(`@${this.name}: no body allowed`);let t=document.createDocumentFragment(),n=new $(String(e[0]),this.passageName,this.lineNumber);return this.render(t,n.parse()),t}});Ae(\"render\",\"=\");d(\"link\",{handler(...e){if(e.length!==2)throw new Error(\"@link: requires 2 arguments\");let[t,n]=e;if(typeof t!=\"string\")throw new Error(\"@link: first arg (label) was not a string\");if(typeof n!=\"function\")throw new Error(\"@link: second arg (handler) was not a function\");let r=c(\"button\",{class:\"brick-link\",type:\"button\"},t);return r.addEventListener(\"click\",this.createCallback(s=>n.call(this,s))),r}});d(\"linkTo\",{handler(...e){let t,n;if(e.length<1||e.length>2)throw new Error(\"@linkTo requires 1 or 2 arguments\");if(e.length===1?t=n=e[0]:(t=e[0],n=e[1]),typeof t!=\"string\")throw new Error(\"@linkTo: first arg (passage name) must be a string\");if(typeof n!=\"string\")throw new Error(\"@linkTo: second arg (link text) must be a string\");let r=c(\"button\",{class:\"brick-link\",type:\"button\"},n);return r.addEventListener(\"click\",()=>Be(t)),r}});d(\"linkReplace\",{handler(...e){if(e.length!==1)throw new Error(\"@linkReplace: requires exactly 1 argument\");let[t]=e;if(typeof t!=\"string\")throw new Error(\"@linkReplace: first arg (link text) must be a string\");let n=c(\"button\",{class:\"brick-link\",type:\"button\"},t);return n.addEventListener(\"click\",()=>{let r=c(\"span\",{class:\"brick-linkReplace brick-transparent\"});this.content&&this.render(r),n.replaceWith(r),setTimeout(()=>r.classList.remove(\"brick-transparent\"),40)}),n}});d(\"while\",{skipArgs:!0,handler(...e){if(e.some(o=>typeof o!=\"string\"))throw new Error(\"@while: received a non-string arg\");let t=e.join(\",\"),n=document.createDocumentFragment(),{content:r}=this;this.loopStatus=2;let s=1;for(;k(t);){if(s>g.maxLoopIterations)throw new Error(`@for: Too many iterations (Config.maxLoopIterations = ${g.maxLoopIterations})`);if(s++,this.render(n,r),this.loopStatus=this.loopStatus,this.loopStatus===3){this.loopStatus=2;break}else if(this.loopStatus===4){this.loopStatus=2;continue}}return n}});d(\"break\",{handler(){return this.loopStatus=3,document.createDocumentFragment()}});d(\"continue\",{handler(){return this.loopStatus=4,document.createDocumentFragment()}});d(\"for\",{skipArgs:!0,handler(...e){if(e.some(p=>typeof p!=\"string\"))throw new Error(\"@for: received a non-string arg\");if(e.length!==2)throw new Error(\"@for: requires exactly 2 arguments\");let[t,n]=e;if(!t.startsWith(\"_\"))throw new Error(\"@for: loop variable must be a temp variable\");let r=t.substring(1),s=`Engine.temp.${r}`,o=k(n);if(typeof o[Symbol.iterator]!=\"function\")throw new Error(\"@for: Right-hand side must be an iterable value, such as an array\");let i=document.createDocumentFragment(),{content:a}=this;this.loopStatus=2;let l=this.captures||[],m=1;for(let p of o){if(m>g.maxLoopIterations)throw new Error(`@for: Too many iterations (Config.maxLoopIterations = ${g.maxLoopIterations})`);if(m++,le(s,p),this.captures=[...l,{name:r,value:p}],this.render(i,a),this.loopStatus=this.loopStatus,this.loopStatus===3){this.loopStatus=2;break}else this.loopStatus===4&&(this.loopStatus=2)}return this.captures=l,i}});d(\"checkBox\",{skipArgs:!0,handler(...e){if(e.length!==2)throw new Error(\"@checkBox: requires 2 arguments\");if(e.some(l=>typeof l!=\"string\"))throw new Error(\"@checkBox: both arguments must be strings\");let[t,n]=e,r=k(n);if(typeof r!=\"string\"&&!(r instanceof Node))throw new Error(\"@checkBox: label must be a string or Node\");let s=k(t),o=c(\"input\",{type:\"checkbox\",id:Ne()});o.checked=!!s,o.addEventListener(\"change\",()=>le(t,o.checked));let i=c(\"label\",{for:o.id},r);return c(\"div\",{},o,\" \",i)}});d(\"switch\",{handler(...e){if(e.length!==1)throw new Error(\"@switch: requires 1 arg\");if(!this.content)throw new Error(\"@switch: requires a body\");let[t]=e,n=[];for(let s of this.content)if(typeof s==\"string\"){if(s.trim())throw new Error(\"@switch: all children must be @case macros\")}else if(s.type===\"macro\")n.push(s);else throw new Error(\"@switch: all children must be @case macros\");for(let s=0;s<n.length;s++){let o=n[s];if(o.name===\"default\"){if(s!==n.length-1)throw new Error(\"@switch: @default must be the last macro\");if(o.args.length>0)throw new Error(\"@switch: @default cannot receive any arguments\")}else{if(o.name!==\"case\")throw new Error(\"@switch: all children must be @case macros\");if(o.args.length===0)throw new Error(\"@switch: @case macro requires at least one argument\")}}let r=document.createDocumentFragment();for(let s of n){if(s.name===\"default\")return this.render(r,s.content),r;for(let o of s.args){let i=k(o);if(t===i)return this.render(r,s.content),r}}return r}});d(\"if\",{trailingMacros:[\"elseif\",\"else\"],handler(){if(!this.content)throw new Error(\"@if: no child templates\");for(let e of this.content){if(!z(e))throw new Error(\"@if: child was not a MacroTemplate\");if(e.name===\"else\"||k(e.args.join(\",\"))){let t=document.createDocumentFragment();return this.render(t,e.content),t}}return document.createDocumentFragment()}});d(\"redoable\",{handler(){let{content:e}=this;if(!e)throw new Error(\"@redoable: must be called with a body\");let t=c(\"span\",{class:\"brick-macro-redoable\"});this.loopStatus=1;try{this.render(t)}catch(n){if(n instanceof Error){let s=/^Can't (@break|@continue) from outside a loop$/.exec(n.message);s&&(n.message=`Can't ${s[1]} from within a @do macro`)}throw n}return t.addEventListener(\"brick-redo\",()=>{t.innerHTML=\"\",this.render(t)}),t}});function Nt(e){return console.error(e),c(\"span\",{class:\"brick-error\"},String(e))}function x(e,t,n){let r=!0;if(t instanceof P){let s=g.preProcessText?g.preProcessText(t):t.content;if(typeof s!=\"string\")throw new TypeError(`Config.preProcessText returned a ${typeof s}, expected a string`);let o=new $(s,t.name);return x(e,o.parse(),n)}for(let s=0;s<t.length;s++){let o=t[s],i;if(typeof o==\"string\"){i=o;let a=i.split(`\n\n`),l=a.shift();if(typeof l==\"string\")for(e.append(l);typeof(l=a.shift())==\"string\";)e.append(c(\"br\")),e.append(c(\"br\")),e.append(l)}else if(o.type===\"macro\"){let a=ue(o.name);if(!a)throw new Error(`Macro not found: \"${o.name}\"`);let l,m;if(a.trailingMacros){let b=[o];for(let K=s+1;K<t.length;K++){let H=t[K];if(z(H)&&a.trailingMacros.includes(H.name))b.push(H),s=K;else if(!(typeof H==\"string\"&&!H.trim()))break}l=new O(o.name,o.passageName,o.lineNumber,n,b),m=[]}else m=a.skipArgs?o.args:o.args.map(b=>k(b)),l=new O(o.name,o.passageName,o.lineNumber,n,o.content);let p=a.handler.apply(l,m);e.append(p);let h=l.loopStatus;if(h===3||h===4){if(!n||n.loopStatus===1){let b=l.loopStatus===3?\"@break\":\"@continue\";throw new Error(`Can't ${b} from outside a loop`)}return n.loopStatus=l.loopStatus,r}l.loopStatus=1}else if(o.type===\"element\")e.append(St(o,n));else if(o.type===\"linkBox\"){let a=ue(\"linkTo\");if(!a)throw new Error(\"Can't find @linkTo macro for wiki-style [[link]]\");if(!o.text)throw new Error(\"The text of a [[link box]] cannot be empty\");let l=new O(\"linkTo\",o.passageName,o.lineNumber);e.append(a.handler.call(l,o.link,o.text))}else if(o.type===\"error\")r=!1,e.append(Nt(new W(o.message,o.passageName,o.lineNumber)));else{let a=(o.type===\"story\"?T:E)[o.name];e.append(String(a))}}return r}function St(e,t){let n=c(e.name);for(let[r,s]of e.attributes)n.setAttribute(r,s);for(let[r,s]of e.evalAttributes){let o=String(k(s));n.setAttribute(r,o)}return x(n,e.content,t),n}var de=(e,t)=>t.some(n=>e instanceof n),Ce,Pe;function Tt(){return Ce||(Ce=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function It(){return Pe||(Pe=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var fe=new WeakMap,me=new WeakMap,Q=new WeakMap;function Lt(e){let t=new Promise((n,r)=>{let s=()=>{e.removeEventListener(\"success\",o),e.removeEventListener(\"error\",i)},o=()=>{n(L(e.result)),s()},i=()=>{r(e.error),s()};e.addEventListener(\"success\",o),e.addEventListener(\"error\",i)});return Q.set(t,e),t}function Mt(e){if(fe.has(e))return;let t=new Promise((n,r)=>{let s=()=>{e.removeEventListener(\"complete\",o),e.removeEventListener(\"error\",i),e.removeEventListener(\"abort\",i)},o=()=>{n(),s()},i=()=>{r(e.error||new DOMException(\"AbortError\",\"AbortError\")),s()};e.addEventListener(\"complete\",o),e.addEventListener(\"error\",i),e.addEventListener(\"abort\",i)});fe.set(e,t)}var he={get(e,t,n){if(e instanceof IDBTransaction){if(t===\"done\")return fe.get(e);if(t===\"store\")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return L(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t===\"done\"||t===\"store\")?!0:t in e}};function Re(e){he=e(he)}function Dt(e){return It().includes(e)?function(...t){return e.apply(ge(this),t),L(this.request)}:function(...t){return L(e.apply(ge(this),t))}}function At(e){return typeof e==\"function\"?Dt(e):(e instanceof IDBTransaction&&Mt(e),de(e,Tt())?new Proxy(e,he):e)}function L(e){if(e instanceof IDBRequest)return Lt(e);if(me.has(e))return me.get(e);let t=At(e);return t!==e&&(me.set(e,t),Q.set(t,e)),t}var ge=e=>Q.get(e);function _e(e,t,{blocked:n,upgrade:r,blocking:s,terminated:o}={}){let i=indexedDB.open(e,t),a=L(i);return r&&i.addEventListener(\"upgradeneeded\",l=>{r(L(i.result),l.oldVersion,l.newVersion,L(i.transaction),l)}),n&&i.addEventListener(\"blocked\",l=>n(l.oldVersion,l.newVersion,l)),a.then(l=>{o&&l.addEventListener(\"close\",()=>o()),s&&l.addEventListener(\"versionchange\",m=>s(m.oldVersion,m.newVersion,m))}).catch(()=>{}),a}var Bt=[\"get\",\"getKey\",\"getAll\",\"getAllKeys\",\"count\"],Ct=[\"put\",\"add\",\"delete\",\"clear\"],pe=new Map;function $e(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t==\"string\"))return;if(pe.get(t))return pe.get(t);let n=t.replace(/FromIndex$/,\"\"),r=t!==n,s=Ct.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(s||Bt.includes(n)))return;let o=async function(i,...a){let l=this.transaction(i,s?\"readwrite\":\"readonly\"),m=l.store;return r&&(m=m.index(a.shift())),(await Promise.all([m[n](...a),s&&l.done]))[0]};return pe.set(t,o),o}Re(e=>({...e,get:(t,n,r)=>$e(t,n)||e.get(t,n,r),has:(t,n)=>!!$e(t,n)||e.has(t,n)}));var Pt=[\"continue\",\"continuePrimaryKey\",\"advance\"],Oe={},we=new WeakMap,Fe=new WeakMap,$t={get(e,t){if(!Pt.includes(t))return e[t];let n=Oe[t];return n||(n=Oe[t]=function(...r){we.set(this,Fe.get(this)[t](...r))}),n}};async function*Ot(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;let n=new Proxy(t,$t);for(Fe.set(n,t),Q.set(n,ge(t));t;)yield n,t=await(we.get(n)||t.continue()),we.delete(n)}function He(e,t){return t===Symbol.asyncIterator&&de(e,[IDBIndex,IDBObjectStore,IDBCursor])||t===\"iterate\"&&de(e,[IDBIndex,IDBObjectStore])}Re(e=>({...e,get(t,n,r){return He(t,n)?Ot:e.get(t,n,r)},has(t,n){return He(t,n)||e.has(t,n)}}));var Ve,v;var Ue=[];async function qe(e,t){Ve=`brick.${B(e)}.${t}`,v=await _e(Ve,1,{upgrade(n,r,s,o,i){n.createObjectStore(\"moments\",{autoIncrement:!0}),n.createObjectStore(\"histories\",{autoIncrement:!0,keyPath:\"id\"})}})}async function je(e){let t=await v.get(\"moments\",e);if(!t)throw new Error(`Could not load moment ${e}`);return{...t,vars:Ze(t.vars)}}async function be(e){let t={...e,vars:U(e.vars)};return await v.put(\"moments\",t)}async function Ge(e){return await v.get(\"histories\",e)}async function Ke(){return await v.getAll(\"histories\",IDBKeyRange.upperBound(\"\"))}async function Je(e,t,n){let r={id:\"active\",momentIds:e,index:t,timestamp:Date.now(),title:n};await v.put(\"histories\",r)}async function We(e,t,n){let r={momentIds:e,index:t,timestamp:Date.now(),title:n};return r.id=await v.put(\"histories\",r),r}async function ze(){return await v.delete(\"histories\",\"active\")}async function Xe(){return await v.delete(\"histories\",IDBKeyRange.upperBound(\"\"))}async function Ye(e){return await v.delete(\"histories\",e)}function Ze(e){for(let t in Object.keys(e)){let n=e[t];typeof n==\"object\"&&n!==null&&(e[t]=Ze(n))}if(e instanceof Array&&typeof e[0]==\"string\")if(e[0].startsWith(\"!brick-revive:\")){let t=e[0].substring(14);if(e.length!==2)throw new Error(\"malformed save data\");let n=Ue.find(r=>r.name===t);if(!n)throw new Error(\"malformed save data\");return n.deserialize(e[1])}else/^!{2,}brick-revive:/.test(e[0])&&(e[0]=e[0].substring(1));else if(e instanceof Map){let t=new Map;for(let[n,r]of e)typeof n==\"object\"&&n&&(n=U(n)),typeof r==\"object\"&&r&&(r=U(r)),t.set(n,r);return t}else if(e instanceof Set){let t=new Set;for(let n of e)typeof n==\"object\"&&n&&(n=U(n)),t.add(n);return t}return e}function V(e){switch(typeof e){case\"boolean\":case\"string\":case\"number\":case\"undefined\":case\"bigint\":return e;case\"function\":case\"symbol\":throw new Error(`Cannot serialize a ${typeof e}`);case\"object\":return e===null?null:U(e)}}function U(e){if(Array.isArray(e))return typeof e[0]==\"string\"&&/^!+brick-revive:/.test(e[0])?[\"!\"+e[0],...e.slice(1)]:e;if(e instanceof Map){let r=new Map;for(let[s,o]of e)r.set(V(s),V(o));return r}if(e instanceof Set){let r=new Set;for(let s of e)r.add(V(s));return r}if(e instanceof Date||e instanceof RegExp)return e;for(let r of Ue)if(e instanceof r.constructor)return[`!brick-revive:${r.name}`,V(r.serialize(e))];let t=Object.getPrototypeOf(e);if(t!==null&&t!==Object.prototype)throw new Error(\"Can't serialize an object with an unknown prototype\");let n={};for(let r in e)n[r]=V(e[r]);return n}var q,N,I,f,ee,M,T,E;async function et(){q=J(\"brick-main\"),q.innerHTML=\"\",N=[],I=[],f=-1,ee=0,M=\"\",T={},E={}}async function tt(){if(!await ye(\"active\")){let e={passageName:ce().name,timestamp:Date.now(),turnCount:1,vars:T};I=[e],N=[await be(e)],f=0,ne(),await te(),j()}}async function te(){let e=I[f];e||(e=await je(N[f]),I[f]=e),T=y(e.vars),ee=e.turnCount,M=e.passageName}async function Y(){if(f===0)return!1;if(g.stream){let e=Array.from(document.querySelectorAll(\".brick-passage\"));for(let t of e.slice(-2))t.remove()}return f--,await te(),ne(),j(),!0}async function Z(){return f===N.length-1?!1:(f++,await te(),ne(),j(),!0)}async function Be(e){M=typeof e==\"string\"?e:e.name,N.length=f+1,I.length=f+1;let t={passageName:M,timestamp:Date.now(),turnCount:ee,vars:y(T)};I.push(t),N.push(await be(t)),f++,ne(),j()}async function nt(){return await We(N,f,rt())}async function ye(e){let t=await Ge(e);if(t)N=t.momentIds,I=Array(N.length),I.fill(void 0),f=t.index;else return!1;return await te(),j(),!0}function rt(){return`${M} | Turn ${ee}`}function ne(){return Je(N,f,rt())}function j(){let e=S(M);if(!e)throw new Error(`Couldn't find passage \"${M}\"`);if(E={},g.stream){for(let s of q.querySelectorAll(\":enabled\"))s.setAttribute(\"disabled\",\"\");for(let s of document.querySelectorAll(\".brick-active-passage\"))s.classList.remove(\"brick-active-passage\")}else q.innerHTML=\"\";let t=c(\"article\",{class:\"brick-passage brick-active-passage brick-transparent\"}),n=S(\"StoryHeader\"),r=S(\"StoryFooter\");n&&x(t,n),x(t,e),r&&x(t,r),q.append(t),t.scrollIntoView(),setTimeout(()=>t.classList.remove(\"brick-transparent\"),40)}function st(){ze(),window.location.reload()}function Me(){for(let e of document.querySelectorAll(\".brick-macro-redoable\"))e.dispatchEvent(new CustomEvent(\"brick-redo\"))}var w,re,D;function it(){let e=J(\"brick-dialog\");if(e instanceof HTMLDialogElement)w=e;else throw new Error(\"#brick-dialog was not a <dialog> element\");Ee(),w.addEventListener(\"click\",t=>{let n=w.getBoundingClientRect(),{clientX:r,clientY:s}=t;n.top<=s&&s<=n.top+n.height&&n.left<=r&&r<=n.left+n.width||w.close()})}function Ee(){w.innerHTML=\"\",w.className=\"\",re=c(\"h1\");let e=c(\"div\",{},re);D=c(\"div\"),w.append(e,D)}function De(e){let t=S(e);if(!t)throw new Error(`Passage not found: ${e}`);Ee(),re.append(e),x(D,t),w.showModal()}async function at(){Ee(),re.append(\"Saves\"),D.append(\"Loading...\"),w.classList.add(\"brick-saves-menu\"),w.showModal();let e=await Ke();e.sort((s,o)=>o.timestamp-s.timestamp);let t=await Promise.all(e.map(ct));D.innerHTML=\"\";let n=c(\"ul\");D.append(n),t.length===0?n.append(c(\"li\",{class:\"brick-saves-empty\"},c(\"em\",{},\"No saves found\"))):n.append(...t);let r=c(\"div\",{class:\"brick-saves-buttons\"});ke(n,r),D.append(r)}function ke(e,t){let n=c(\"button\",{},\"Delete\");n.addEventListener(\"click\",()=>{for(let i of e.querySelectorAll(\"button\"))i.removeEventListener(\"click\",xe),i.addEventListener(\"click\",lt),i.innerText=\"Delete\";Rt(e,t)});let r=c(\"button\",{},\"Export\");r.addEventListener(\"click\",()=>alert(\"Not supported yet\"));let s=c(\"button\",{},\"Import\");s.addEventListener(\"click\",()=>alert(\"Not supported yet\"));let o=c(\"button\",{},\"Save\");o.addEventListener(\"click\",async()=>{let i=await nt();e.querySelector(\".brick-saves-empty\")?.remove(),e.prepend(ct(i))}),t.innerHTML=\"\",t.append(n,r,s,o)}function Rt(e,t){let n=c(\"button\",{disabled:\"\"},\"Delete All\");n.addEventListener(\"click\",async function(){this.disabled=!0,await Xe(),e.innerHTML=\"\",e.append(c(\"li\",{},c(\"em\",{},\"No saves found\"))),ke(e,t)}),setTimeout(()=>{n.disabled=!1},3e3);let r=c(\"button\",{},\"Cancel\");r.addEventListener(\"click\",()=>{for(let s of e.querySelectorAll(\"button\"))s.removeEventListener(\"click\",lt),s.addEventListener(\"click\",xe),s.innerText=\"Load\";ke(e,t)}),t.innerHTML=\"\",t.append(n,r)}function ct(e){let t=new Date(e.timestamp).toLocaleString(),{id:n}=e;if(!n)throw new Error(\"Tried to create a save menu entry for an unsaved History\");let r=c(\"button\",{\"data-brick-history-id\":String(n)},\"Load\");return r.addEventListener(\"click\",xe),c(\"li\",{},c(\"div\",{},e.title,c(\"br\"),c(\"small\",{},t)),r)}async function xe(){let e=Number(this.dataset.brickHistoryId);if(e!==e)throw new Error(`Tried to load invalid ID \"${this.dataset.brickHistoryId}`);if(w.close(),!await ye(e))throw new Error(`Could not load history #${e}`)}async function lt(){let e=Number(this.dataset.brickHistoryId);if(e!==e)throw new Error(`Tried to delete invalid ID \"${this.dataset.brickHistoryId}`);await Ye(e);let t=this.parentElement?.parentElement;this.parentElement?.remove(),t&&t.childElementCount===0&&t.append(c(\"li\",{class:\"brick-saves-empty\"},c(\"em\",{},\"No saves found\")))}window.addEventListener(\"error\",e=>{let{error:t}=e,n=\"\";t instanceof Error?(n+=`Fatal Error!\n`,n+=t.toString(),t.stack&&(n+=`\n`+t.stack)):(n+=`Non-error object was thrown and not caught:\n`,n+=String(e)),alert(n)});window.addEventListener(\"unhandledrejection\",e=>{let{reason:t}=e;alert(`Fatal Error!\n${t}`)});window.Brick=X;var G=document.getElementsByTagName(\"tw-storydata\")[0];ae(G);var Ft=G.querySelectorAll('style[type=\"text/twine-css\"]'),Vt=G.querySelectorAll('script[type=\"text/twine-javascript\"]'),Ut=G.getAttribute(\"name\")||(()=>{throw new Error(\"Story has no title\")})(),qt=G.getAttribute(\"ifid\")||\"00000000-0000-4000-A000-000000000000\";for(let e of Ft){let t=c(\"style\",{},e.innerText);document.head.appendChild(t)}function se(e,t){document.getElementById(e)?.addEventListener(\"click\",t)}se(\"brick-history-backward\",Y);se(\"brick-history-forward\",Z);se(\"brick-saves\",at);se(\"brick-restart\",st);async function jt(){it(),await qe(Ut,qt),await et();for(let e of Vt)_(e.innerText);await tt()}jt();})();\n</script>\n</body>\n\n</html>\n","hydrate":"\"use strict\";function startState(){return{blockComment:!1,expectMacroBody:!1,js:!1,nesting:[],jsNesting:[]}}const KEYWORDS=\"break case catch class const continue debugger default delete do else export extends false finally for function if import in instanceof new null return super switch this throw true try typeof var void while with let static yield await enum implements interface package private protected public arguments as async eval from get of set undefined\".split(\" \"),OPERATORS=[\"!\",\"!=\",\"!==\",\"%\",\"%=\",\"&\",\"&&\",\"&=\",\"&&=\",\"*\",\"**\",\"*=\",\"**=\",\"+\",\"++\",\"+=\",\"-\",\"--\",\"-=\",\"/\",\"/=\",\"<\",\"<<\",\"<=\",\"<<=\",\"=\",\"==\",\"===\",\">\",\">>\",\">>>\",\">=\",\">>=\",\">>>=\",\"^\",\"^=\",\"|\",\"||\",\"|=\",\"||=\",\"~\"];function tokenJs(e,n){if(e.match(/[!%&*+-<=>^|~]+/))return OPERATORS.includes(e.current())?\"operator\":\"error operator\";if(e.match(/[$_a-zA-Z][$_a-zA-Z0-9]*/))return[\"$\",\"_\"].includes(e.current()[0])?\"variable-3\":KEYWORDS.includes(e.current())?\"keyword\":\"variable\";const r=e.next();switch(r){case\"/\":return e.peek()===\"/\"?(e.skipToEnd(),\"comment\"):e.peek()===\"*\"?(e.next(),n.blockComment=!0,\"comment\"):(e.eat(\"=\"),\"operator\");case\"(\":return n.jsNesting.push(\")\"),\"bracket\";case\"{\":return n.jsNesting.push(\"}\"),\"bracket\";case\"[\":return n.jsNesting.push(\"]\"),\"bracket\";case\")\":case\"}\":case\"]\":return r===n.jsNesting[n.jsNesting.length-1]?(n.jsNesting.pop(),n.jsNesting.length===0?(n.js=!1,n.expectMacroBody=!0,e.eatSpace(),\"variable-2\"):\"bracket\"):\"bracket error\";case'\"':return e.match(/(?:[^\\\\\"]|\\\\[^]])*\"/)?\"string\":(e.skipToEnd(),\"string error\");case\"'\":return e.match(/(?:[^\\\\']|\\\\[^])*'/)?\"string\":(e.skipToEnd(),\"string error\");default:return e.eatSpace(),null}}function token(e,n){if(n.blockComment)return e.match(/[^]*?\\*\\//)?n.blockComment=!1:e.skipToEnd(),\"comment\";if(n.js)return tokenJs(e,n);const r=e.next();if(n.expectMacroBody&&(n.expectMacroBody=!1,r===\"{\"))return n.nesting.push(\"}\"),\"bracket\";switch(r){case\"$\":case\"_\":return e.match(/[$_a-zA-Z]/)?(e.match(/[$_a-zA-Z0-9]*/),\"variable-3\"):\"error\";case\"/\":return e.peek()===\"/\"?(e.skipToEnd(),\"comment\"):e.peek()===\"*\"?(e.next(),n.blockComment=!0,\"comment\"):null;case\"@\":return e.match(/[a-zA-Z]*\\s*\\(/)?(n.jsNesting=[\")\"],n.js=!0,\"variable-2\"):e.match(/[a-zA-Z]*\\s*\\{/)?(e.backUp(1),n.expectMacroBody=!0,\"variable-2\"):\"error\";case\"}\":return n.nesting[n.nesting.length-1]===\"}\"?(n.nesting.pop(),\"bracket\"):null;case\"\\\\\":return e.next()?\"atom\":\"error\";default:return e.match(/[^$_/@{}\\\\]*/),null}}function mode(){return{startState,token}}this.editorExtensions={twine:{\"^2.0.0\":{codeMirror:{mode}}}};\n"});