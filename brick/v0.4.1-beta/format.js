window.storyFormat({"name":"Brick","version":"0.4.1","author":"Chris Neidhart","image":"icon.svg","description":"A modern story format with a JavaScript-like syntax, and a focus on performance and simplicity.<br><br><a href=\"https://github.com/cjneidhart/brick\">Homepage</a>","source":"<!doctype html>\n<html lang=\"en-US\" data-bs-theme=\"dark\">\n  <head>\n    <meta charset=\"utf-8\" />\n    <title>{{STORY_NAME}}</title>\n    <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" />\n    <style id=\"style-bootstrap\">\n      /*!\n * Bootstrap Reboot v5.3.3 (https://getbootstrap.com/)\n * Copyright 2011-2024 The Bootstrap Authors\n * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)\n */:root,[data-bs-theme=light]{--bs-blue:#0d6efd;--bs-indigo:#6610f2;--bs-purple:#6f42c1;--bs-pink:#d63384;--bs-red:#dc3545;--bs-orange:#fd7e14;--bs-yellow:#ffc107;--bs-green:#198754;--bs-teal:#20c997;--bs-cyan:#0dcaf0;--bs-black:#000;--bs-white:#fff;--bs-gray:#6c757d;--bs-gray-dark:#343a40;--bs-gray-100:#f8f9fa;--bs-gray-200:#e9ecef;--bs-gray-300:#dee2e6;--bs-gray-400:#ced4da;--bs-gray-500:#adb5bd;--bs-gray-600:#6c757d;--bs-gray-700:#495057;--bs-gray-800:#343a40;--bs-gray-900:#212529;--bs-primary:#0d6efd;--bs-secondary:#6c757d;--bs-success:#198754;--bs-info:#0dcaf0;--bs-warning:#ffc107;--bs-danger:#dc3545;--bs-light:#f8f9fa;--bs-dark:#212529;--bs-primary-rgb:13,110,253;--bs-secondary-rgb:108,117,125;--bs-success-rgb:25,135,84;--bs-info-rgb:13,202,240;--bs-warning-rgb:255,193,7;--bs-danger-rgb:220,53,69;--bs-light-rgb:248,249,250;--bs-dark-rgb:33,37,41;--bs-primary-text-emphasis:#052c65;--bs-secondary-text-emphasis:#2b2f32;--bs-success-text-emphasis:#0a3622;--bs-info-text-emphasis:#055160;--bs-warning-text-emphasis:#664d03;--bs-danger-text-emphasis:#58151c;--bs-light-text-emphasis:#495057;--bs-dark-text-emphasis:#495057;--bs-primary-bg-subtle:#cfe2ff;--bs-secondary-bg-subtle:#e2e3e5;--bs-success-bg-subtle:#d1e7dd;--bs-info-bg-subtle:#cff4fc;--bs-warning-bg-subtle:#fff3cd;--bs-danger-bg-subtle:#f8d7da;--bs-light-bg-subtle:#fcfcfd;--bs-dark-bg-subtle:#ced4da;--bs-primary-border-subtle:#9ec5fe;--bs-secondary-border-subtle:#c4c8cb;--bs-success-border-subtle:#a3cfbb;--bs-info-border-subtle:#9eeaf9;--bs-warning-border-subtle:#ffe69c;--bs-danger-border-subtle:#f1aeb5;--bs-light-border-subtle:#e9ecef;--bs-dark-border-subtle:#adb5bd;--bs-white-rgb:255,255,255;--bs-black-rgb:0,0,0;--bs-font-sans-serif:system-ui,-apple-system,\"Segoe UI\",Roboto,\"Helvetica Neue\",\"Noto Sans\",\"Liberation Sans\",Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\",\"Segoe UI Symbol\",\"Noto Color Emoji\";--bs-font-monospace:SFMono-Regular,Menlo,Monaco,Consolas,\"Liberation Mono\",\"Courier New\",monospace;--bs-gradient:linear-gradient(180deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0));--bs-body-font-family:var(--bs-font-sans-serif);--bs-body-font-size:1rem;--bs-body-font-weight:400;--bs-body-line-height:1.5;--bs-body-color:#212529;--bs-body-color-rgb:33,37,41;--bs-body-bg:#fff;--bs-body-bg-rgb:255,255,255;--bs-emphasis-color:#000;--bs-emphasis-color-rgb:0,0,0;--bs-secondary-color:rgba(33, 37, 41, 0.75);--bs-secondary-color-rgb:33,37,41;--bs-secondary-bg:#e9ecef;--bs-secondary-bg-rgb:233,236,239;--bs-tertiary-color:rgba(33, 37, 41, 0.5);--bs-tertiary-color-rgb:33,37,41;--bs-tertiary-bg:#f8f9fa;--bs-tertiary-bg-rgb:248,249,250;--bs-heading-color:inherit;--bs-link-color:#0d6efd;--bs-link-color-rgb:13,110,253;--bs-link-decoration:underline;--bs-link-hover-color:#0a58ca;--bs-link-hover-color-rgb:10,88,202;--bs-code-color:#d63384;--bs-highlight-color:#212529;--bs-highlight-bg:#fff3cd;--bs-border-width:1px;--bs-border-style:solid;--bs-border-color:#dee2e6;--bs-border-color-translucent:rgba(0, 0, 0, 0.175);--bs-border-radius:0.375rem;--bs-border-radius-sm:0.25rem;--bs-border-radius-lg:0.5rem;--bs-border-radius-xl:1rem;--bs-border-radius-xxl:2rem;--bs-border-radius-2xl:var(--bs-border-radius-xxl);--bs-border-radius-pill:50rem;--bs-box-shadow:0 0.5rem 1rem rgba(0, 0, 0, 0.15);--bs-box-shadow-sm:0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);--bs-box-shadow-lg:0 1rem 3rem rgba(0, 0, 0, 0.175);--bs-box-shadow-inset:inset 0 1px 2px rgba(0, 0, 0, 0.075);--bs-focus-ring-width:0.25rem;--bs-focus-ring-opacity:0.25;--bs-focus-ring-color:rgba(13, 110, 253, 0.25);--bs-form-valid-color:#198754;--bs-form-valid-border-color:#198754;--bs-form-invalid-color:#dc3545;--bs-form-invalid-border-color:#dc3545}[data-bs-theme=dark]{color-scheme:dark;--bs-body-color:#dee2e6;--bs-body-color-rgb:222,226,230;--bs-body-bg:#212529;--bs-body-bg-rgb:33,37,41;--bs-emphasis-color:#fff;--bs-emphasis-color-rgb:255,255,255;--bs-secondary-color:rgba(222, 226, 230, 0.75);--bs-secondary-color-rgb:222,226,230;--bs-secondary-bg:#343a40;--bs-secondary-bg-rgb:52,58,64;--bs-tertiary-color:rgba(222, 226, 230, 0.5);--bs-tertiary-color-rgb:222,226,230;--bs-tertiary-bg:#2b3035;--bs-tertiary-bg-rgb:43,48,53;--bs-primary-text-emphasis:#6ea8fe;--bs-secondary-text-emphasis:#a7acb1;--bs-success-text-emphasis:#75b798;--bs-info-text-emphasis:#6edff6;--bs-warning-text-emphasis:#ffda6a;--bs-danger-text-emphasis:#ea868f;--bs-light-text-emphasis:#f8f9fa;--bs-dark-text-emphasis:#dee2e6;--bs-primary-bg-subtle:#031633;--bs-secondary-bg-subtle:#161719;--bs-success-bg-subtle:#051b11;--bs-info-bg-subtle:#032830;--bs-warning-bg-subtle:#332701;--bs-danger-bg-subtle:#2c0b0e;--bs-light-bg-subtle:#343a40;--bs-dark-bg-subtle:#1a1d20;--bs-primary-border-subtle:#084298;--bs-secondary-border-subtle:#41464b;--bs-success-border-subtle:#0f5132;--bs-info-border-subtle:#087990;--bs-warning-border-subtle:#997404;--bs-danger-border-subtle:#842029;--bs-light-border-subtle:#495057;--bs-dark-border-subtle:#343a40;--bs-heading-color:inherit;--bs-link-color:#6ea8fe;--bs-link-hover-color:#8bb9fe;--bs-link-color-rgb:110,168,254;--bs-link-hover-color-rgb:139,185,254;--bs-code-color:#e685b5;--bs-highlight-color:#dee2e6;--bs-highlight-bg:#664d03;--bs-border-color:#495057;--bs-border-color-translucent:rgba(255, 255, 255, 0.15);--bs-form-valid-color:#75b798;--bs-form-valid-border-color:#75b798;--bs-form-invalid-color:#ea868f;--bs-form-invalid-border-color:#ea868f}*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:var(--bs-body-font-family);font-size:var(--bs-body-font-size);font-weight:var(--bs-body-font-weight);line-height:var(--bs-body-line-height);color:var(--bs-body-color);text-align:var(--bs-body-text-align);background-color:var(--bs-body-bg);-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;border:0;border-top:var(--bs-border-width) solid;opacity:.25}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2;color:var(--bs-heading-color)}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.1875em;color:var(--bs-highlight-color);background-color:var(--bs-highlight-bg)}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:rgba(var(--bs-link-color-rgb),var(--bs-link-opacity,1));text-decoration:underline}a:hover{--bs-link-color-rgb:var(--bs-link-hover-color-rgb)}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:var(--bs-font-monospace);font-size:1em}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:var(--bs-code-color);word-wrap:break-word}a>code{color:inherit}kbd{padding:.1875rem .375rem;font-size:.875em;color:var(--bs-body-bg);background-color:var(--bs-body-color);border-radius:.25rem}kbd kbd{padding:0;font-size:1em}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:var(--bs-secondary-color);text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]:not([type=date]):not([type=datetime-local]):not([type=month]):not([type=week]):not([type=time])::-webkit-calendar-picker-indicator{display:none!important}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}::file-selector-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}\n/* */\n    </style>\n    <style id=\"style-brick\">\n      #brick-viewport{display:flex;flex-direction:column}#brick-viewport>*{flex:1}.brick-linkReplace,.brick-active-passage{transition:opacity .4s}.brick-transparent{opacity:0}#ui-bar{background-color:var(--bs-secondary-bg);border-bottom:1px solid var(--bs-border-color);overflow-block:auto;padding:.5rem;width:100%}.brick-ui-btn{background-color:#364d63;border:1px solid var(--bs-secondary);padding-block:.25rem;transition:border-color .15s ease-in-out,background-color .15s ease-in-out}.brick-ui-btn:is(:hover:enabled,:focus){background-color:#3e5974}.brick-ui-btn:disabled{color:var(--bs-secondary)}#brick-history-controls{display:flex;flex-direction:row;text-align:center;width:100%;margin-bottom:.5rem}#brick-history-controls>*{flex-grow:1}#story-title{text-align:center}#brick-menu-core{width:100%;text-align:center;list-style:none;padding:0}#brick-menu-core button{width:100%}#brick-main{max-width:60rem}.brick-passage{padding:1rem}.brick-passage:not(:last-child){border-bottom:1px solid currentColor;padding-bottom:1rem}.brick-active-passage{margin-bottom:5rem;min-height:100vh}@media (min-width: 60rem){#brick-viewport{flex-direction:row}#ui-bar{border-bottom:0;border-right:1px solid var(--bs-border-color);height:100vh;height:100dvh;max-width:24rem;position:sticky;top:0;width:auto}#brick-main{margin-inline:auto}.brick-active-passage{min-height:unset}}#brick-dialog{border-color:var(--bs-border-color);border-radius:.5rem;margin-top:2rem;max-width:min(95vw,50rem);max-width:min(95svw,50rem);min-width:min(95vw,30rem);min-width:min(95svw,30rem);overflow-x:auto}#brick-dialog::backdrop{-webkit-backdrop-filter:brightness(50%) blur(.25rem);backdrop-filter:brightness(50%) blur(.25rem)}#brick-dialog.brick-saves table{border:1px solid var(--bs-border-color);width:100%}#brick-dialog.brick-saves table :is(th,td){border:1px solid var(--bs-border-color);padding:.25rem}#brick-dialog.brick-saves table td:nth-child(3){width:100%}#brick-dialog.brick-saves table td:last-child button:enabled{background-color:var(--bs-danger)}#brick-dialog.brick-saves table td:last-child button:enabled:hover{background-color:inherit;color:var(--bs-danger)}.brick-link{padding:0;border:0;background:none;text-decoration:underline var(--bs-link-color);color:var(--bs-link-color)}.brick-link:hover:enabled{color:var(--bs-link-hover-color);text-decoration-color:var(--bs-link-hover-color)}.brick-link:disabled{color:var(--bs-secondary);cursor:not-allowed;text-decoration-color:var(--bs-secondary)}.brick-text-secondary{color:var(--bs-secondary)}.brick-error{background-color:#5c0a0a;border-inline:.25rem solid red;line-height:2;padding:.25rem}.brick-error code{background-color:var(--bs-body-bg);color:var(--bs-body-color);padding:.125rem}.brick-saves-menu ul{border:1px solid currentColor;list-style:none;padding:0}.brick-saves-menu li:not(:first-child){border-top:1px solid currentColor}.brick-saves-menu li{display:flex;flex-direction:row;padding:.25rem}.brick-saves-menu li>div{flex-grow:1}.brick-saves-empty{color:var(--bs-secondary)}.brick-saves-buttons{display:flex;flex-direction:row;justify-content:space-between}dialog.brick-restart .brick-ui-btn{margin-right:1em}\n\n    </style>\n  </head>\n\n  <body>\n    {{STORY_DATA}}\n    <div id=\"brick-viewport\">\n      <aside id=\"ui-bar\">\n        <div id=\"brick-history-controls\">\n          <button id=\"brick-history-backward\" class=\"brick-ui-btn\" type=\"button\">&#x2190;</button>\n          <button id=\"brick-history-forward\" class=\"brick-ui-btn\" type=\"button\">&#x2192;</button>\n        </div>\n        <h1 id=\"story-title\">{{STORY_NAME}}</h1>\n        <ul id=\"brick-menu-core\">\n          <li><button id=\"brick-saves\" class=\"brick-ui-btn\" type=\"button\">SAVES</button></li>\n          <li><button id=\"brick-restart\" class=\"brick-ui-btn\" type=\"button\">RESTART</button></li>\n        </ul>\n      </aside>\n\n      <main id=\"brick-main\">\n        <noscript>JavaScript must be enabled to play this story.</noscript>\n      </main>\n    </div>\n    <dialog id=\"brick-dialog\"></dialog>\n    <script id=\"script-brick\" type=\"text/javascript\">\n      /**\n       * Copyright (C) 2024  Chris Neidhart\n       *\n       *\n       * The JavaScript code in this element is free software: you can\n       * redistribute it and/or modify it under the terms of the GNU\n       * General Public License (GNU GPL) as published by the Free Software\n       * Foundation, either version 3 of the License, or (at your option)\n       * any later version.  The code is distributed WITHOUT ANY WARRANTY;\n       * without even the implied warranty of MERCHANTABILITY or FITNESS\n       * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.\n       *\n       * As additional permission under GNU GPL version 3 section 7, you\n       * may distribute non-source (e.g., minimized or compacted) forms of\n       * that code without the copy of the GNU GPL normally required by\n       * section 4, provided you include this license notice and a URL\n       * through which recipients can access the Corresponding Source.\n       *\n       * The source code for this <script> element is available at:\n       *    https://github.com/cjneidhart/brick\n       */\n      \"use strict\";(()=>{var Mn=Object.create;var at=Object.defineProperty;var Nn=Object.getOwnPropertyDescriptor;var Tn=Object.getOwnPropertyNames;var In=Object.getPrototypeOf,Ln=Object.prototype.hasOwnProperty;var An=(e,t)=>()=>(e&&(t=e(e=0)),t);var Cn=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var Bn=(e,t,n,r)=>{if(t&&typeof t==\"object\"||typeof t==\"function\")for(let s of Tn(t))!Ln.call(e,s)&&s!==n&&at(e,s,{get:()=>t[s],enumerable:!(r=Nn(t,s))||r.enumerable});return e};var Pn=(e,t,n)=>(n=e!=null?Mn(In(e)):{},Bn(t||!e||!e.__esModule?at(n,\"default\",{value:e,enumerable:!0}):n,e));var x,p=An(()=>{x={major:0,minor:4,patch:1,version:\"0.4.1\",time:1739122447845}});var lt=Cn((Lr,ct)=>{\"use strict\";p();ct.exports=function(){function e(t,n,r,s,i){return t<n||r<n?t>r?r+1:t+1:s===i?n:n+1}return function(t,n){if(t===n)return 0;if(t.length>n.length){var r=t;t=n,n=r}for(var s=t.length,i=n.length;s>0&&t.charCodeAt(s-1)===n.charCodeAt(i-1);)s--,i--;for(var o=0;o<s&&t.charCodeAt(o)===n.charCodeAt(o);)o++;if(s-=o,i-=o,s===0||i<3)return i;var a=0,c,u,m,g,f,w,y,b,D,G,ge,he,F=[];for(c=0;c<s;c++)F.push(c+1),F.push(t.charCodeAt(o+c));for(var it=F.length-1;a<i-3;)for(D=n.charCodeAt(o+(u=a)),G=n.charCodeAt(o+(m=a+1)),ge=n.charCodeAt(o+(g=a+2)),he=n.charCodeAt(o+(f=a+3)),w=a+=4,c=0;c<it;c+=2)y=F[c],b=F[c+1],u=e(y,u,m,D,b),m=e(u,m,g,G,b),g=e(m,g,f,ge,b),w=e(g,f,w,he,b),F[c]=w,f=g,g=m,m=u,u=y;for(;a<i;)for(D=n.charCodeAt(o+(u=a)),w=++a,c=0;c<it;c+=2)y=F[c],F[c]=w=e(y,u,w,D,F[c+1]),u=y;return w}}()});p();p();p();p();var q={historyLength:100,maxLoopIterations:1e3,preProcessText:void 0,stream:!1};function Dn(e,t,n){throw new TypeError(`${e}: expected ${t}, got ${typeof n}`)}var v={get historyLength(){return q.historyLength},set historyLength(e){if(typeof e!=\"number\"||e<=0||e%1!==0)throw new TypeError(\"config.historyLength must be a positive integer\");q.historyLength=e},get maxLoopIterations(){return q.maxLoopIterations},set maxLoopIterations(e){if(typeof e!=\"number\"||e<=0||e%1!==0)throw new TypeError(\"Config.maxLoopIterations must be a positive integer\");q.maxLoopIterations=e},get preProcessText(){return q.preProcessText},set preProcessText(e){typeof e<\"u\"&&typeof e!=\"function\"&&Dn(\"Config.preProcessText\",\"function or undefined\",e),q.preProcessText=e},get stream(){return q.stream},set stream(e){q.stream=!!e}};p();p();var mt=Pn(lt(),1);p();var N=class extends Error{constructor(t,n,r){super(`in \\u201C${n}\\u201D at line ${r}: ${t}`),this.passage=n,this.lineNumber=r}},Y=class extends N{constructor(t,n){let r;try{r=`@${t.name}: ${n instanceof Error?n.message:n}`}catch{r=`@${t.name}: (error could not be converted to string)`}super(r,t.passageName,t.lineNumber),this.cause=n}},we=class extends N{constructor(t,n,r){let s;try{s=`while evaluating the attribute \"${n}\": ${t instanceof Error?t.message:t}`}catch{s=`while evaluating the attribute \"${n}\": (error could not be converted to string)`}super(s,r.passageName,r.lineNumber),this.cause=t}},_=class extends N{constructor(t,n,r,s){let i=`while evaluating \"${n}\": ${t}`;super(i,r,s)}},ut={boxedBoolean:\"You are using a boxed boolean, constructed by calling the global `Boolean` function with the `new` keyword. It is recommended to never use the `new` keyword with the global `Boolean` function, as boxed booleans are always considered to be truthy, regardless of their internal value.\",boxedNumber:\"You are using a boxed number, constructed by calling the global `Number` function with the `new` keyword. It is recommended to never use the `new` keyword with the global `Number` function, as boxed numbers are slightly different from regular numbers.\",boxedString:\"You are using a boxed string, constructed by calling the global `String` function with the `new` keyword. It is recommended to never use the `new` keyword with the global `String` function, as boxed strings are slightly different from regular strings.\"};function W(e){let t=ut[e];t&&(ut[e]=void 0,console.warn(t))}var Rn=new Set(\"'\\\",()[]{}.!`?\");function K(e){return Array.from(e).map(t=>t>=\"a\"&&t<=\"z\"||t>=\"0\"&&t<=\"9\"?t:t>=\"A\"&&t<=\"Z\"||t>\"\\x7F\"?t.toLowerCase():Rn.has(t)?\"\":\"-\").join(\"\").replace(/-+/g,\"-\")}function ft(e,t){let n=-1,r=0;for(;n=e.indexOf(t,n+1),n!==-1;)r++;return r}function V(e){switch(typeof e){case\"bigint\":case\"boolean\":case\"number\":case\"string\":case\"undefined\":return e;case\"symbol\":throw new Error(\"Symbols cannot be cloned\");case\"function\":throw new Error(\"Functions cannot be cloned\");case\"object\":if(e===null)return e;if(\"clone\"in e&&typeof e.clone==\"function\")return e.clone();if(e instanceof Array)return e.map(V);if(e instanceof Date)return new Date(e);if(e instanceof Map){let t=new Map;for(let[n,r]of e)t.set(V(n),V(r));return t}else{if(e instanceof RegExp)return new RegExp(e);if(e instanceof Set){let t=new Set;for(let n of e)t.add(V(n));return t}else{if(e instanceof Boolean)return W(\"boxedBoolean\"),e;if(e instanceof Number)return W(\"boxedNumber\"),e;if(e instanceof String)return W(\"boxedString\"),e;{let t=Object.getPrototypeOf(e);if(t!==null&&t!==Object.prototype)throw new Error(\"Can't clone an object with an unknown prototype and no `.clone()` method\");let n=Object.create(t);for(let r in e)n[r]=V(e[r]);return n}}}default:throw new Error(`Unknown type: ${typeof e}`)}}function pt(e){if(e.length<1)throw new Error(\"either: array is empty\");return e[Pe(e.length)]}function ne(e){let t=document.getElementById(e);if(!t)throw new Error(`No element with id \"${e}\" found`);return t}function Pe(e){return Math.floor(Math.random()*e)}var On=0;function $e(){return`brick-unique-id-${On++}`}function l(e,t={},...n){let r=document.createElement(e);for(let s in t)r.setAttribute(s,t[s]);return r.append(...n),r}function*dt(e,t,n=1){let r;if(typeof t>\"u\"?(r=0,t=e):r=e,n>0)for(;r<t;)yield r,r+=n;else for(;r>t;)yield r,r+=n}function*gt(e,t=0){let n=t;for(let r of e)yield[n,r],n++}function J(e){return arguments.length===0?\"\":e instanceof Array&&!(Symbol.toPrimitive in e)&&e.toString===Array.prototype.toString?`[${e.join(\", \")}]`:String(e)}function ye(e,t){t??=(r,s)=>`Unknown property \"${r}\". Did you mean \"${s}\"?`;let n={get(r,s,i){if(s in i||typeof s!=\"string\")return Reflect.get(r,s,i);let o=Object.getOwnPropertyNames(i),a=Object.getPrototypeOf(i);for(;a;)o.push(...Object.getOwnPropertyNames(a)),a=Object.getPrototypeOf(a);let c=o.map(m=>({name:m,distance:(0,mt.default)(s,m)})),{name:u}=c.reduce((m,g)=>g.distance<=s.length*.4&&g.distance<m.distance?g:m,{name:void 0,distance:1/0});return c.length>0&&console.warn(t(s,u)),Reflect.get(r,s,i)}};return new Proxy(e,n)}var re=class{#e;constructor(t){var r;let n=t.getAttribute(\"name\");if(!n)throw new Error(\"Passage has no name\");this.name=n.trim(),this.slug=K(n),this.tags=Object.freeze(((r=t.getAttribute(\"tags\"))==null?void 0:r.split(\" \").filter(s=>s.length>=0).sort())||[]),this.#e=t,Object.freeze(this)}get content(){return this.#e.textContent}toString(){return`Passage \"${this.name}\"`}},_n=[\"PassageDone\",\"PassageFooter\",\"PassageHeader\",\"PassageReady\"],Vn=[\"StoryFooter\",\"StoryHeader\",\"StoryInit\",\"StoryInterface\"],ht=new Set([\"init\",\"debug-footer\",\"debug-startup\",\"nobr\"]);function Fn(e){if(_n.includes(e))console.warn(`The passage name \"${e}\" has no special meaning to Brick. Use \"StoryHeader\" or \"StoryFooter\" instead.`);else if(e===\"StoryTitle\"||e===\"StoryData\")console.warn(`The passage \"${e}\" should have been removed by your compiler. This is likely an error.`);else if(e.startsWith(\"Story\")&&!Vn.includes(e))throw new Error(`The passage name \"${e}\" is not allowed.`)}function Un(e,t){for(let n of e)if(ht.has(n))console.warn(`The tag \"${n}\" on passage \"${t}\" has no special meaning in Brick.`),ht.delete(n);else if(n.startsWith(\"brick\"))throw new Error(`The tag \"${n}\" on passage \"${t}\" is not allowed.`)}var X,De;function wt(e){let t,n=e.getAttribute(\"startnode\"),s=Array.from(e.querySelectorAll('tw-passagedata:not([tags~=\"module\"])')).map(i=>{let o=new re(i);return i.getAttribute(\"pid\")===n&&(t=o),o});s.sort((i,o)=>i.name===o.name?0:i.name<o.name?-1:1),X=new Map;for(let i of s){let{name:o}=i;if(Fn(o),o.startsWith(\"::\")&&console.warn(`Found a passage named \"${o}\". Although starting a passage name with \"::\" is allowed, this is likely a mistake.`),Un(i.tags,o),X.has(o))throw new Error(`Duplicate passage name ${o}`);i.content.trim()||console.warn(`Passage ${o} has no text.`),X.set(o,i)}if(t)De=t;else{let i=X.get(\"Start\");if(!i)throw new Error('Could not find a passage named \"Start\"');De=i}}function Re(e){let t=[];for(let n of X.values())e(n)&&t.push(n);return t}function yt(e){for(let t of X.values())if(e(t))return t}function R(e){return X.get(e.trim())}function bt(){return De}function be(e){return Re(t=>t.tags.includes(e))}p();p();p();var d={closeTag:/>/y,commentBlock:/\\*(?:[^])*?\\*\\//y,commentLine:/\\/.*\\n?/y,elementName:/([-\\p{ID_Continue}]+)(#[-\\p{ID_Continue}]+)?((?:\\.[-\\p{ID_Continue}]+)*)/uy,htmlAttr:/\\s*([-_\\p{ID_Start}][-\\p{ID_Continue}]*)=\"([^\"]*)\"/uy,htmlEvalAttr:/\\s*([-_\\p{ID_Start}][-\\p{ID_Continue}]*)=\\(/uy,js:{binaryOperator:/[%&*<=>^|]+/y,closingParen:/\\s*\\)/y,closingSquareBracket:/\\s*\\]/y,field:new RegExp(\"\\\\.\\\\p{ID_Start}[$\\\\p{ID_Continue}]*\",\"uy\"),identifier:new RegExp(\"\\\\p{ID_Start}[$\\\\p{ID_Continue}]*\",\"uy\"),number:/[0-9][0-9_]*/y,operator:/[!%&*+-<=>^|~]+/y,regexp:new RegExp(\"(?:[^\\\\\\\\[/]|\\\\\\\\[^]|\\\\[(?:[^\\\\\\\\\\\\]]|\\\\\\\\[^])*\\\\])*\\\\/(?:$|\\\\p{ID_Continue})*\",\"uy\"),stringDouble:/\"(?:[^\\\\\"\\r\\n]|\\\\[^])*\"/y,stringSingle:/'(?:[^\\\\'\\r\\n]|\\\\[^])*'/y,normalInTemplateString:/(?:[^`$\\\\]|\\\\[^]|\\$(?!\\{))*/y},macroArgsStart:/ *\\(/y,macroBodyStart:/\\s*\\{/y,macroName:/[-\\p{ID_Start}][-\\p{ID_Continue}]*|=/uy,maybeElementClose:/\\/[-\\p{ID_Continue}]+(?: *>)?/uy,normalChars:/[^[\\\\$_?<@/}]+/y,singleChar:/[^]/y,styleElement:/([^]*?)<\\/style>/y,whitespace:/\\s*/y,wikiLink:/((?:[^\\\\\\]]|\\\\.)*)\\]\\]/y},jn=[\"base\",\"body\",\"link\",\"head\",\"html\",\"meta\",\"script\",\"title\"],qn=[\"area\",\"base\",\"br\",\"col\",\"embed\",\"hr\",\"img\",\"input\",\"link\",\"meta\",\"param\",\"source\",\"track\",\"wbr\"],se=class{constructor(t,n,r){this.input=t,this.index=0,this.passageName=n,this.lineNumber=r||1}get[Symbol.toStringTag](){return this.constructor.name}consume(t){t.lastIndex=this.index;let n=t.exec(this.input);return n&&(this.lineNumber+=ft(n[0],`\n`),this.index=t.lastIndex),n}lookahead(){return this.input[this.index]||null}locationSample(){if(this.input[this.index]===`\n`){let r=this.input.lastIndexOf(`\n`,this.index-1)+1;return this.input.slice(r,this.index)}let t=this.input.lastIndexOf(`\n`,this.index-1)+1,n=this.input.indexOf(`\n`,this.index+1);return this.input.slice(t,n)}error(t){throw new N(t,this.passageName,this.lineNumber)}parse(){try{return this.parseUnsafe()}catch(t){if(!(t instanceof N))throw t;return t}}parseUnsafe(t){var s;let n=[],r=-1;e:for(;this.index<this.input.length;){this.index===r&&this.error(\"Parser stuck in infinite loop\"),r=this.index;let i=this.index;if(this.consume(d.normalChars),this.index!==i&&n.push(this.input.substring(i,this.index)),t&&this.consume(t))return n;let o=(s=this.consume(d.singleChar))==null?void 0:s[0];switch(o){case\"\\\\\":{let a=this.consume(d.singleChar);n.push((a==null?void 0:a[0])||`\n`);break}case\"<\":n.push(this.parseElement());break;case\"@\":n.push(this.parseExpr(\"constants\"));break;case\"/\":switch(this.lookahead()){case\"/\":this.consume(d.commentLine);break;case\"*\":this.consume(d.commentBlock)||this.error(\"Missing trailing `*/` to close the block comment\");break;default:n.push(o);break}break;case\"$\":{n.push(this.parseExpr(\"story\"));break}case\"_\":{n.push(this.parseExpr(\"temp\"));break}case\"[\":if(this.lookahead()===\"[\"){this.index++;let a=this.consume(d.wikiLink);a||this.error(\"Unmatched `[[`\");let c=a[1],u=c.includes(\"->\"),m=c.includes(\"<-\"),g=c.includes(\"|\"),f=Number(u)+Number(m)+Number(g);if(f>1)this.error(\"Link boxes can only have one of '->', '<-', or '|'\");else if(f===0)n.push({type:\"linkBox\",passageName:this.passageName,lineNumber:this.lineNumber,link:c,text:c});else{let w=u?\"->\":m?\"<-\":\"|\";n.push(this.makeLinkBox(c,w))}}else n.push(\"[\");break;case\"}\":n.push(\"}\");break;case void 0:break e;default:throw new Error(`Logic Error (${o})`)}}return t&&!this.consume(t)&&this.error(`Failed to match regex \"${t.source}\"`),n}parseExpr(t){let{lineNumber:n}=this,r=\"\";if(t!==\"constants\"||this.lookahead()!==\"(\"){let o=this.consume(d.macroName);if(!o){let a={constants:\"@\",story:\"$\",temp:\"_\"}[t];throw Error(`Unescaped \"${a}\"`)}r=o[0]}if(t===\"constants\"){let o=S[r];if(oe(o)){let a=o[h];if(typeof a==\"object\"){if(a.chainWith)return this.parseMacroChain(r,a.chainWith);if(a.isForMacro)return this.parseForMacro()}}}let s=[];e:for(;;){let o=this.index;switch(this.lookahead()){case\"(\":{this.index++;let a=this.parseJsArgs(\")\");if(!(a instanceof Array))throw Error();let c=this.input.slice(o,this.index);s.push({type:\"call\",args:a,raw:c});break}case\"[\":{this.index++;let a=this.parseJsArgs(\"]\");if(!(a instanceof Array))throw Error();s.push({type:\"index\",key:a.join(\",\"),needsEval:!0,raw:this.input.slice(o,this.index)});break}case\".\":{this.index++;let a=this.consume(d.js.identifier);if(a)s.push({type:\"index\",key:a[0],needsEval:!1,raw:this.input.slice(o,this.index)});else{this.index--;break e}break}case\" \":if(t===\"constants\"&&s.length===0)this.index++;else break e;break;default:break e}}let i=this.consume(d.macroBodyStart)?this.parseUnsafe(/\\}/y):void 0;return{type:\"expr\",lineNumber:n,passageName:this.passageName,store:t,base:r,ops:s,content:i}}parseMacroChain(t,n){let r=this.lineNumber;if(!this.consume(d.macroArgsStart))throw\"todo\";let s=this.parseJsArgs(\")\");if(!(s instanceof Array))throw Error(\"todo'):\");if(!this.consume(d.macroBodyStart))throw\"error\";let i=this.parseUnsafe(/\\}/y),o=this.index,a=[{name:t,args:s,body:i}],c=n.sticky?n:new RegExp(n,n.flags+\"y\");for(;this.consume(/\\s*@/y);){let m=this.consume(c);if(!m){this.index=o;break}let g=m[0],f=[];if(this.lookahead()===\"(\"){let y=this.parseJsArgs(\")\");if(!(y instanceof Array))throw\"ererdsaf\";f=y}let w=[];this.consume(d.macroBodyStart)&&(w=this.parseUnsafe(/\\}/y),o=this.index),a.push({name:g,args:f,body:w})}return{type:\"chain\",passageName:this.passageName,lineNumber:r,segments:a}}parseForMacro(){let{lineNumber:t}=this;if(!this.consume(d.macroArgsStart))throw\"bad for\";let n=this.index-1,r=this.parseForArgs();if(!(r instanceof Array))throw r;let s=this.input.slice(n,this.index),i=this.consume(d.macroBodyStart)?this.parseUnsafe(/\\}/y):void 0;return{type:\"expr\",passageName:this.passageName,lineNumber:t,store:\"constants\",base:\"for\",ops:[{type:\"call\",args:r,raw:s}],content:i}}parseElement(){let t=this.consume(d.elementName);if(!t){let c=this.consume(d.maybeElementClose);c&&this.error(`Unexpected closing tag \"${c[0]}\"`),this.error('Element names can contain only hyphens, underscores, and ASCII letters and numbers. The \"<\" character must be escaped with a \"\\\\\" backslash if not used as an HTML element.')}let[,n,r,s]=t,i=new Map,o=new Map;for(r&&i.set(\"id\",r.slice(1)),s.length&&i.set(\"class\",s.replace(\".\",\" \").trim()),this.consume(d.whitespace);!this.consume(d.closeTag);){let c=this.consume(d.htmlAttr);if(c){let[u,m,g]=c;i.has(m)||o.has(m)?console.warn(`Ignoring duplicate attribute '${m}`):i.set(m,g)}else if(c=this.consume(d.htmlEvalAttr),c){let u=c[1],m=this.parseJsExpression();if(typeof m==\"object\")return m;m.trim()===\"\"&&this.error(`Empty JavaScript attribute \"${u}\"`),this.lookahead()!==\")\"&&this.error(`No closing paren on dynamic attribute \"${u}\"`),this.index++,i.has(u)||o.has(u)?console.warn(`Ignoring duplicate attribute '${u}`):o.set(u,m)}else this.error(\"Missing trailing `>` to close the HTML tag\")}let a;if(n===\"style\"){let c=this.consume(d.styleElement);if(!c)throw new Error(\"No closing </style> found\");a=[c[1]]}else qn.includes(n)?a=[]:a=this.parseUnsafe(new RegExp(`</${n}>`,\"y\"));return jn.includes(n)&&this.error(`Passages cannot contain \"<${n}>\" elements`),{type:\"element\",passageName:this.passageName,lineNumber:this.lineNumber,name:n,attributes:i,evalAttributes:o,content:a}}parseForArgs(){let t=this.consume(/\\s*([^]*?)\\s+of\\b/y);t||this.error(\"Syntax: @for(_VAR of EXPRESSION)\");let n=t[1],r=this.parseJsExpression();return typeof r==\"object\"?r:(r.trim()===\"\"&&this.error(\"Syntax: @for(_VAR of EXPRESSION)\"),this.consume(/\\s*\\)/y)||this.error(\"@for: missing closing ')'\"),[n,r])}parseJsArgs(t){let n=[],r;for(;r=this.parseJsExpression();){if(typeof r==\"object\")return r;if(n.push(r),!this.consume(/\\s*,/uy))break}return this.consume(d.whitespace),this.lookahead()!==t&&this.error(`Missing a closing \\`${t}\\``),this.index++,n}parseJsExpression(){let t=[],n=[],r=!0,s,i=0;e:for(;this.index<this.input.length;){if(this.index===i)throw new Error(`Infinite loop at index ${i} (${this.input[this.index]})`);if(i=this.index,s=this.consume(d.whitespace),s&&n.push(s[0]),s=this.consume(d.js.identifier),s){n.push(s[0]),r=!1;continue}if(s=this.consume(d.js.number),s){n.push(s[0]),r=!1;continue}if(s=this.consume(d.js.binaryOperator),s){n.push(s[0]),r=!0;continue}let o=this.lookahead();switch(o){case'\"':s=this.consume(d.js.stringDouble),s?(n.push(s[0]),r=!1):this.error(\"Unclosed double-quoted string\");break;case\"'\":s=this.consume(d.js.stringSingle),s?(n.push(s[0]),r=!1):this.error(\"Unclosed single-quoted string\");break;case\"`\":this.index++,n.push(o),this.parseJsTemplateString(n),r=!1;break;case\"(\":t.push(\")\"),n.push(o),this.index++,r=!0;break;case\"[\":t.push(\"]\"),n.push(o),this.index++,r=!0;break;case\"{\":t.push(\"}\"),n.push(o),this.index++,r=!1;break;case\"$\":case\"_\":case\"@\":if(this.index++,s=this.consume(d.js.identifier),s){let a=o===\"$\"?\"engine.vars.\":o===\"_\"?\"brickTempVarScope.\":\"constants.\";n.push(a,s[0]),r=!1}else this.error(\"Illegal identifier\");break;case\",\":if(t.length>0)this.index++,n.push(o),r=!0;else break e;break;case\"#\":case\":\":case\";\":case\"?\":case\".\":r=!0,n.push(o),this.index++;break;case\"!\":this.index++,this.lookahead()===\"=\"?(this.index++,this.lookahead()===\"=\"?(this.index++,n.push(\"!==\")):n.push(\"!=\"),r=!0):(n.push(o),r=!1);break;case\"+\":case\"-\":{n.push(o),this.index++;let a=this.lookahead();a===o?(n.push(a),this.index++,r=!1):a===\"=\"?(this.index++,r=!0,n.push(\"=\")):r=!0}break;case\"~\":n.push(o),this.index++,r=!0;break;case\"/\":this.index++,this.consume(d.commentLine)?n.push(`\n`):(s=this.consume(d.commentBlock))?s[0].includes(`\n`)&&n.push(`\n`):r?(n.push(o),s=this.consume(d.js.regexp),s||this.error(\"Invalid RegExp literal\"),n.push(s[0]),r=!1):(n.push(o),r=!0);break;default:if(o&&o===t[t.length-1]){this.index++,n.push(o),t.pop();break}[\")\",\"]\",\"}\"].includes(o||\"\")||this.error(`Can't handle unescaped ${o} yet`);break e}}return t.length>0&&this.error(`Expected a \"${t.pop()}\"`),n.join(\"\")}parseJsTemplateString(t){for(;;){let n=this.consume(d.js.normalInTemplateString);n&&t.push(n[0]);let r=this.lookahead();switch(r||this.error(\"Unclosed template string\"),r){case\"`\":t.push(r),this.index++;return;case\"$\":{this.index+=2,t.push(\"${\");let s=this.parseJsExpression();if(typeof s==\"object\")return s;t.push(s),this.lookahead()!==\"}\"&&this.error('missing \"}\" inside template string'),this.index++,t.push(\"}\");break}default:this.error(`Logic Error: '${r}' (U+${r.charCodeAt(0)}) was not matched by regex`)}}}makeLinkBox(t,n){let r=t.split(n);return r.length!==2&&this.error(`Links in [[...]] can only contain \"${n}\" once`),n===\"<-\"?{type:\"linkBox\",passageName:this.passageName,lineNumber:this.lineNumber,link:r[0].trim(),text:r[1].trim()}:{type:\"linkBox\",passageName:this.passageName,lineNumber:this.lineNumber,link:r[1].trim(),text:r[0].trim()}}toString(){return\"[object Parser]\"}};p();p();var ue;async function kt(e){let t=e.querySelectorAll('tw-passagedata[tags~=\"module\"]');ue=Object.create(null);for(let o of t){let{name:a,url:c}=Wn(o);ue[a]=c}let n=[];for(let o in Brick)n.push(`export const ${o} = Brick.${o};\n`);n.push(`export default {\n`);for(let o in Brick)n.push(`${o},\n`);n.push(`};\n`);let r=new Blob(n,{type:\"text/javascript\"}),s=URL.createObjectURL(r);ue.brick=s;let i=l(\"script\",{type:\"importmap\"},JSON.stringify({imports:ue}));document.head.append(i),await import(s)}function Et(e){let t=ue[e];if(!t)throw new Error(`No module named \"${e}\" found.`);return import(t)}function Wn(e){var i;let t=e.getAttribute(\"name\");if(!t)throw new Error(\"No passage name\");let n=e.textContent;n=((i=/^\\s*@\\(([^]*)\\)\\s*$/.exec(n))==null?void 0:i[1])??n;let r=new Blob([n],{type:\"text/javascript\"}),s=URL.createObjectURL(r);return{name:t,url:s}}p();p();var Ve=(e,t)=>t.some(n=>e instanceof n),xt,vt;function Jn(){return xt||(xt=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function zn(){return vt||(vt=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var Fe=new WeakMap,He=new WeakMap,ke=new WeakMap;function Gn(e){let t=new Promise((n,r)=>{let s=()=>{e.removeEventListener(\"success\",i),e.removeEventListener(\"error\",o)},i=()=>{n(Z(e.result)),s()},o=()=>{r(e.error),s()};e.addEventListener(\"success\",i),e.addEventListener(\"error\",o)});return ke.set(t,e),t}function Yn(e){if(Fe.has(e))return;let t=new Promise((n,r)=>{let s=()=>{e.removeEventListener(\"complete\",i),e.removeEventListener(\"error\",o),e.removeEventListener(\"abort\",o)},i=()=>{n(),s()},o=()=>{r(e.error||new DOMException(\"AbortError\",\"AbortError\")),s()};e.addEventListener(\"complete\",i),e.addEventListener(\"error\",o),e.addEventListener(\"abort\",o)});Fe.set(e,t)}var Ue={get(e,t,n){if(e instanceof IDBTransaction){if(t===\"done\")return Fe.get(e);if(t===\"store\")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return Z(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t===\"done\"||t===\"store\")?!0:t in e}};function Tt(e){Ue=e(Ue)}function Xn(e){return zn().includes(e)?function(...t){return e.apply(je(this),t),Z(this.request)}:function(...t){return Z(e.apply(je(this),t))}}function Zn(e){return typeof e==\"function\"?Xn(e):(e instanceof IDBTransaction&&Yn(e),Ve(e,Jn())?new Proxy(e,Ue):e)}function Z(e){if(e instanceof IDBRequest)return Gn(e);if(He.has(e))return He.get(e);let t=Zn(e);return t!==e&&(He.set(e,t),ke.set(t,e)),t}var je=e=>ke.get(e);function It(e,t,{blocked:n,upgrade:r,blocking:s,terminated:i}={}){let o=indexedDB.open(e,t),a=Z(o);return r&&o.addEventListener(\"upgradeneeded\",c=>{r(Z(o.result),c.oldVersion,c.newVersion,Z(o.transaction),c)}),n&&o.addEventListener(\"blocked\",c=>n(c.oldVersion,c.newVersion,c)),a.then(c=>{i&&c.addEventListener(\"close\",()=>i()),s&&c.addEventListener(\"versionchange\",u=>s(u.oldVersion,u.newVersion,u))}).catch(()=>{}),a}var Qn=[\"get\",\"getKey\",\"getAll\",\"getAllKeys\",\"count\"],er=[\"put\",\"add\",\"delete\",\"clear\"],_e=new Map;function St(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t==\"string\"))return;if(_e.get(t))return _e.get(t);let n=t.replace(/FromIndex$/,\"\"),r=t!==n,s=er.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(s||Qn.includes(n)))return;let i=async function(o,...a){let c=this.transaction(o,s?\"readwrite\":\"readonly\"),u=c.store;return r&&(u=u.index(a.shift())),(await Promise.all([u[n](...a),s&&c.done]))[0]};return _e.set(t,i),i}Tt(e=>({...e,get:(t,n,r)=>St(t,n)||e.get(t,n,r),has:(t,n)=>!!St(t,n)||e.has(t,n)}));var tr=[\"continue\",\"continuePrimaryKey\",\"advance\"],Mt={},qe=new WeakMap,Lt=new WeakMap,nr={get(e,t){if(!tr.includes(t))return e[t];let n=Mt[t];return n||(n=Mt[t]=function(...r){qe.set(this,Lt.get(this)[t](...r))}),n}};async function*rr(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;let n=new Proxy(t,nr);for(Lt.set(n,t),ke.set(n,je(t));t;)yield n,t=await(qe.get(n)||t.continue()),qe.delete(n)}function Nt(e,t){return t===Symbol.asyncIterator&&Ve(e,[IDBIndex,IDBObjectStore,IDBCursor])||t===\"iterate\"&&Ve(e,[IDBIndex,IDBObjectStore])}Tt(e=>({...e,get(t,n,r){return Nt(t,n)?rr:e.get(t,n,r)},has(t,n){return Nt(t,n)||e.has(t,n)}}));var At,M;var Ee=[];async function Ct(e,t){At=`brick.${K(e)}.${t}`,M=await It(At,1,{upgrade(n,r,s,i,o){n.createObjectStore(\"moments\",{autoIncrement:!0}),n.createObjectStore(\"histories\",{autoIncrement:!0,keyPath:\"id\"})}}),await or()}function Bt(){M==null||M.close()}async function or(){let e=M.transaction(M.objectStoreNames,\"readwrite\"),t=e.objectStore(\"moments\");if(await t.count()>1e3){let r=await e.objectStore(\"histories\").getAll(),s=new Set;for(let o of r)for(let a of o.momentIds)s.add(a);let i=[];for await(let o of t)s.has(o.key)||i.push(o.delete());await Promise.all(i)}await e.done}async function We(e){let t=await M.get(\"moments\",e);if(!t)throw new Error(`Could not load moment ${e}`);return{...t,vars:ie(t.vars)}}async function xe(e){let t={...e,vars:Je(e.vars,!1)};return await M.put(\"moments\",t)}async function Ke(e){return await M.get(\"histories\",e)}async function Pt(){return await M.getAll(\"histories\",IDBKeyRange.upperBound(\"\"))}async function $t(e,t,n){let r={id:\"active\",momentIds:e,index:t,timestamp:Date.now(),title:n};await M.put(\"histories\",r)}async function Dt(e,t,n){let r={momentIds:e,index:t,timestamp:Date.now(),title:n};return r.id=await M.put(\"histories\",r),r}async function Rt(){return await M.delete(\"histories\",\"active\")}async function Ot(){return await M.delete(\"histories\",IDBKeyRange.upperBound(\"\"))}async function Ht(e){return await M.delete(\"histories\",e)}async function _t(e){let t=await Ke(e);if(!t)throw new Error(`No history in slot ${e}`);return{index:t.index,timestamp:t.timestamp,title:t.title,moments:await Promise.all(t.momentIds.map(async r=>{let s=await We(r);return s.vars=Je(s.vars,!0),s}))}}function k(e){throw new Error(`Malformed save data: ${e}`)}async function Vt(e){let t=await e.text(),n=JSON.parse(t);typeof n!=\"object\"||n===null||Array.isArray(n)?k(\"history is not an object\"):\"index\"in n?typeof n.index!=\"number\"?k(\"`index` property is not a number\"):\"timestamp\"in n?typeof n.timestamp!=\"number\"?k(\"`timestamp` property is not a number\"):\"title\"in n?typeof n.title!=\"string\"?k(\"`title` property is not a string\"):\"moments\"in n?Array.isArray(n.moments)||k(\"`moments` property is not an array\"):k(\"Missing `moments` property\"):k(\"Missing `title` property\"):k(\"Missing `timestamp` property\"):k(\"Missing `index` property\");let{moments:r}=n,s=await Promise.all(r.map(o=>(typeof o!=\"object\"||o===null?k(\"one or more moments are not objects\"):\"passageName\"in o?typeof o.passageName!=\"string\"?k(\"`passageName` property is not a string\"):\"timestamp\"in o?typeof o.timestamp!=\"number\"?k(\"`timestamp` property is not a number\"):\"turnCount\"in o?typeof o.turnCount!=\"number\"?k(\"`turnCount` property is not a number\"):\"vars\"in o?(typeof o.vars!=\"object\"||o.vars===null)&&k(\"`vars` property is not an object\"):k(\"missing `vars` property\"):k(\"missing `turnCount` property\"):k(\"missing `timestamp` property\"):k(\"missing `passageName` property\"),xe({passageName:o.passageName,timestamp:o.timestamp,turnCount:o.turnCount,vars:ie(o.vars)})))),i={index:n.index,timestamp:n.timestamp,title:n.title,momentIds:s};return await M.put(\"histories\",i)}function Ft(e,t,n,r){if(typeof e!=\"function\")throw new Error(\"registerClass: `constructor` must be a function\");if(e===Array)throw new Error('\"Array\" cannot be a registered class');if(r===void 0&&(r=e.name),typeof r!=\"string\")throw new Error(\"registerClass: `name` must be undefined or a string\");if(t===void 0&&(t=e.serialize),typeof t!=\"function\")throw new Error(\"registerClass: `serialize` must be undefined or a string\");if(n===void 0&&(n=e.deserialize),typeof n!=\"function\")throw new Error(\"registerClass: `deserialize` must be undefined or a string\");if(Ee.some(s=>s.name===r)||[\"undefined\",\"neg-inf\",\"pos-inf\",\"nan\",\"Map\",\"Date\",\"Set\",\"RegExp\",\"boxed\",\"null-proto\"].includes(r))throw new Error(`registerClass: \"${r}\" has already been registered`);if([Map,Set,Date,RegExp,Boolean,Number,String].includes(e))throw new Error(`${e.name} is already handled by Brick.`);Ee.unshift({constructor:e,name:r,serialize:t,deserialize:n})}function ie(e){for(let t in e){let n=e[t];typeof n==\"object\"&&n!==null&&(e[t]=ie(n))}if(e instanceof Array&&typeof e[0]==\"string\")if(e[0].startsWith(\"!brick-revive:\")){let t=e[0].substring(14);if(![1,2].includes(e.length))throw new Error(\"malformed save data\");return ir(t,e[1])}else/^!{2,}brick-revive:/.test(e[0])&&(e[0]=e[0].substring(1));else if(e instanceof Map){let t=new Map;for(let[n,r]of e)typeof n==\"object\"&&n&&(n=ie(n)),typeof r==\"object\"&&r&&(r=ie(r)),t.set(n,r);return t}else if(e instanceof Set){let t=new Set;for(let n of e)typeof n==\"object\"&&n&&(n=ie(n)),t.add(n);return t}return e}function ir(e,t){switch(e){case\"undefined\":return;case\"pos-inf\":return 1/0;case\"neg-inf\":return-1/0;case\"nan\":return NaN;case\"bigint\":if(typeof t!=\"string\")throw new Error(`Could not revive a BigInt. Payload was ${t}`);return BigInt(t);case\"null-proto\":return Object.assign(Object.create(null),t);case\"boxed\":switch(typeof t){case\"boolean\":return new Boolean(t);case\"number\":return new Number(t);case\"string\":return new String(t);default:throw new TypeError(`Can't revive a boxed ${typeof t}`)}case\"Map\":if(!Array.isArray(t)||!t.every(r=>Array.isArray(r)&&r.length===2))throw new Error(\"Malformed save data. Could not revive a Map.\");return new Map(t);case\"Set\":if(!Array.isArray(t))throw new Error(\"Malformed save data. Could not revive a Set.\");return new Set(t);case\"Date\":if(typeof t!=\"string\")throw new Error(\"Malformed save data. Could not revive a Date object.\");return new Date(t);case\"RegExp\":{if(!Array.isArray(t)||t.length!==2||!t.every(i=>typeof i==\"string\"))throw new Error(\"Malformed save data. Could not revive a RegExp.\");let[r,s]=t;return new RegExp(r,s)}}let n=Ee.find(r=>r.name===e);if(!n)throw new Error(`Malformed save data. Unknown type \"${e}\".`);return n.deserialize(t)}function z(e,t){switch(typeof e){case\"boolean\":case\"string\":return e;case\"undefined\":return t?[\"!brick-revive:undefined\"]:e;case\"number\":if(t)switch(e){case 1/0:return[\"!brick-revive:pos-inf\"];case-1/0:return[\"!brick-revive:neg-inf\"];default:return Number.isNaN(e)?[\"!brick-revive:nan\"]:e}else return e;case\"bigint\":return t?[\"!brick-revive:bigint\",String(e)]:e;case\"function\":case\"symbol\":throw new Error(`Cannot serialize a ${typeof e}`);case\"object\":return e===null?null:Je(e,t)}}function Je(e,t){if(Array.isArray(e))return typeof e[0]==\"string\"&&/^!+brick-revive:/.test(e[0])?[\"!\"+e[0],...e.slice(1)]:e;if(e instanceof Map)if(t){let s=[];for(let[i,o]of e)s.push([z(i,t),z(o,t)]);return[\"!brick-revive:Map\",s]}else{let s=new Map;for(let[i,o]of e)s.set(z(i,t),z(o,t));return s}if(e instanceof Set)if(t){let s=[];for(let i of e)s.push(z(i,t));return[\"!brick-revive:Set\",s]}else{let s=new Set;for(let i of e)s.add(z(i,t));return s}if(e instanceof Date)return t?[\"!brick-revive:Date\",e.toJSON()]:e;if(e instanceof RegExp)return t?[\"!brick-revive:RegExp\",[e.source,e.flags]]:e;if(e instanceof Boolean)return W(\"boxedBoolean\"),t?[\"!brick-revive:boxed\",e.valueOf()]:e;if(e instanceof Number)return W(\"boxedNumber\"),t?[\"!brick-revive:boxed\",e.valueOf()]:e;if(e instanceof String)return W(\"boxedString\"),t?[\"!brick-revive:boxed\",e.valueOf()]:e;for(let s of Ee)if(e instanceof s.constructor)return[`!brick-revive:${s.name}`,z(s.serialize(e),t)];let n=Object.getPrototypeOf(e);if(n!==null&&n!==Object.prototype)throw new Error(\"Can't serialize an object with an unknown prototype\");let r={};for(let s in e)r[s]=z(e[s],t);return n===null?[\"!brick-revive:null-proto\",r]:r}var ae={BRICK_VERSION:x,get constants(){return S},engine:{forward:Ne,backward:Me,redo:qt,get vars(){return B},get temp(){return P}},config:v,dialog:{showPassage:Wt},passages:{filter(e){if(typeof e!=\"function\")throw new Error(\"passages.filter: expected a function\");return Re(e)},find(e){if(typeof e!=\"function\")throw new Error(\"passages.find: expected a function\");return yt(e)},get(e){if(typeof e!=\"string\")throw new Error(\"passages.get: expected a string\");return R(e)},withTag(e){if(typeof e!=\"string\")throw new Error(\"passages.withTag: expected a string\");return be(e)}},saves:{registerClass:Ft},clone:V,createMacro:me,createGetter:jt,either(e){if(arguments.length!==1)throw new Error(\"either(): exactly one argument required\");if(typeof e!=\"object\"||e===null)throw new Error(\"either(): first argument was not an array\");if(!(\"length\"in e)||typeof e.length!=\"number\")throw new Error(\"either(): first argument was not an array\");return pt(e)},enumerate:gt,makeElement:l,numberRange:dt,passageName(){if(arguments.length!==0)throw new TypeError(\"passageName(): no arguments allowed\");return ze()},randomInt(e){if(arguments.length!==1)throw new Error(\"randomInt: exactly 1 argument required\");if(typeof e!=\"number\")throw new Error(\"randomInt: argument must be a number\");return Pe(e)},render:Q,renderPassage:C,slugify:K,tags(){if(arguments.length!==0)throw new TypeError(\"tags(): no arguments allowed\");let e=R(ze());return(e==null?void 0:e.tags)??[]}};ae.BRICK_VERSION.toString=function(){return this.version};ae.BRICK_VERSION.time=new Date(ae.BRICK_VERSION.time);var Ge,Ye;function Ut(){Ge=Object.keys(ae),Ye=Object.values(ae),window.Brick=ae,window.brickImport=function(e){if(arguments.length!==1)throw new TypeError(\"brickImport: must receive exactly one argument\");if(typeof e!=\"string\")throw new TypeError(\"brickImport: string expected\");return Et(e)}}function Xe(e,t){return new Function(...Ge,\"brickTempVarScope\",`'use strict';${e}`)(...Ye,t)}function T(e,t){return Xe(\"return \"+e,t)}function Se(e,t,n){new Function(...Ge,\"brickTempVarScope\",`\"use strict\"; ${e} = arguments[arguments.length - 1]`)(...Ye,n,t)}var h=Symbol.for(\"BRICK_MACRO\");function oe(e){if(typeof e==\"function\"&&h in e){let t=e[h];if(typeof t==\"object\"&&t!==null||t===!0)return!0}return!1}var O=class{constructor(t,n){this.context=t,this.type=n}toString(){return`Signal from @${this.type} in \"${this.context.passageName}\" line ${this.context.lineNumber}`}};function me(e,t){let n=(r,...s)=>e(r,...s);return n[h]=t??!0,n}function jt(e,t){Object.defineProperty(S,e,{configurable:!0,enumerable:!0,get:t,set(n){Object.defineProperty(S,e,{configurable:!0,enumerable:!0,value:n,writable:!0})}})}function Kt(e){Object.assign(e,{\"\":zt,\"-\":Qe,\"=\":et,append:Ze(\"append\"),break:Xt,checkBox:en,continue:Zt,for:Qt,if:nn,include:Jt,later:on,link:lr,linkReplace:Gt,macro:cn,prepend:Ze(\"prepend\"),print:Qe,punt:an,redoable:sn,render:et,replace:Ze(\"replace\"),switch:rn,textBox:tn,while:Yt})}var ce=class{constructor(t,n,r,s,i,o){this.name=t,this.content=o,this.tempVars=s,this.passageName=n,this.lineNumber=r,this.parent=i}get[Symbol.toStringTag](){return this.constructor.name}createTempVariableScope(){let t=this.tempVars,n=Object.create(t);return new Proxy(n,{set(r,s,i,o){return!(s in o)||Object.prototype.hasOwnProperty.call(o,s)?Reflect.set(r,s,i,o):Reflect.set(t,s,i,t)}})}render(t,n,r){return Q(t,r||this.createTempVariableScope(),n,this)}},Jt=(e,...t)=>{if(t.length<1||t.length>2)throw new Error(\"must be called with 1 argument\");let[n,r]=t;if(typeof n!=\"string\")throw new Error(\"first arg (passage name) must be a string\");if(typeof r<\"u\"&&typeof r!=\"string\")throw new Error(\"second arg (element type) must be a string or undefined\");let i=l(r||\"div\"),o=e.createTempVariableScope();return C(i,o,n),i};Jt[h]=!0;var zt=(e,...t)=>(Xe(t.join(\", \"),e.tempVars),document.createDocumentFragment());zt[h]={skipArgs:!0};var Qe=(e,...t)=>{if(t.length!==1)throw new Error(`requires 1 argument (got ${t.length})`);if(e.content)throw new Error(\"no body allowed\");return J(t[0])};Qe[h]=!0;var et=(e,...t)=>{if(t.length!==1)throw new Error(`requires 1 argument (got ${t.length})`);if(e.content)throw new Error(\"no body allowed\");if(typeof t[0]!=\"string\")throw new Error(\"argument must be a string. Use the String() constructor if you want to convert a value to a string.\");let n=document.createDocumentFragment(),r=new se(t[0],e.passageName,e.lineNumber);return e.render(n,r.parse()),n};et[h]=!0;var lr=me((e,...t)=>{if(t.length<1||t.length>3)throw new Error(\"requires 1, 2 or 3 arguments\");if(typeof t[0]!=\"string\")throw new Error(\"first argument (link text) must be a string\");let n=t[0],r,s;if(t.length===2)if(typeof t[1]==\"string\")r=t[1],s=void 0;else if(typeof t[1]==\"function\")r=void 0,s=t[1];else throw new Error(\"second argument must be a string or function\");else if(t.length===3){if(typeof t[1]==\"function\"&&typeof t[2]==\"string\")throw new Error(\"second argument must be a string and third argument must be a function\");if(typeof t[1]!=\"string\")throw new Error(\"second argument must be a string\");if(typeof t[2]!=\"function\")throw new Error(\"third argument must be a function\");r=t[1],s=t[2]}else e.content||console.warn(\"@link received only 1 argument. This link will do nothing when clicked.\"),r=void 0,s=void 0;let i=l(\"button\",{class:\"brick-link\",type:\"button\"},n);return r&&(i.dataset.linkDestination=r),i.addEventListener(\"click\",o=>{if(s&&s.call(i,o),e.content){let a=l(\"div\");e.render(a,e.content);let c=a.innerHTML.trim();c&&console.warn(`An @link macro's children, when rendered, contained non-whitespace characters. This is likely an error. Its contents:\n`+c)}i.dataset.linkDestination&&ln(i.dataset.linkDestination)}),i}),Gt=(e,...t)=>{if(t.length!==1)throw new Error(\"requires exactly 1 argument\");let[n]=t;if(typeof n!=\"string\")throw new Error(\"first arg (link text) must be a string\");let r=l(\"button\",{class:\"brick-link\",type:\"button\"},n);return r.addEventListener(\"click\",()=>{let s=l(\"span\",{class:\"brick-linkReplace brick-transparent\"});e.content&&e.render(s,e.content),r.replaceWith(s),setTimeout(()=>s.classList.remove(\"brick-transparent\"),40)}),r};Gt[h]=!0;var Yt=(e,...t)=>{if(t.some(o=>typeof o!=\"string\"))throw new Error(\"received a non-string arg\");let n=t.join(\",\"),r=document.createDocumentFragment(),{content:s}=e,i=1;for(;T(n,e.tempVars);){if(i>v.maxLoopIterations)throw new Error(`Too many iterations (Config.maxLoopIterations = ${v.maxLoopIterations})`);i++;try{if(!(s?e.render(r,s):!0))break}catch(o){if(o instanceof O){if(o.type===\"break\")break;continue}else throw o}}return r};Yt[h]={skipArgs:!0};var Xt=e=>{throw new O(e,\"break\")};Xt[h]=!0;var Zt=e=>{throw new O(e,\"continue\")};Zt[h]=!0;var Qt=(e,...t)=>{if(!t.every(u=>typeof u==\"string\"))throw new Error(\"received a non-string arg\");if(t.length!==2)throw new Error(\"requires exactly 2 arguments\");let[n,r]=t;if(!n.startsWith(\"_\"))throw new Error(\"loop variable must be a temp variable\");let s=n.substring(1),i=T(r,e.tempVars);if(typeof i[Symbol.iterator]!=\"function\")throw new Error(\"Right-hand side must be an iterable value, such as an array\");let o=document.createDocumentFragment(),{content:a}=e,c=1;for(let u of i){if(c>v.maxLoopIterations)throw new Error(`Too many iterations (Config.maxLoopIterations = ${v.maxLoopIterations})`);c++;let m=e.createTempVariableScope();m[s]=u;try{if(!(a?e.render(o,a,m):!0))break}catch(g){if(g instanceof O){if(g.type===\"break\")break;continue}else throw g}}return o};Qt[h]={isForMacro:!0,skipArgs:!0};var en=(e,...t)=>{if(t.length!==2)throw new Error(\"requires 2 arguments\");if(t.some(u=>typeof u!=\"string\"))throw new Error(\"both arguments must be strings\");let[n,r]=t,s=T(r,e.tempVars);if(typeof s!=\"string\"&&!(s instanceof Node))throw new Error(\"label must be a string or Node\");let i=T(n,e.tempVars),o=l(\"input\",{type:\"checkbox\",id:$e()});o.checked=!!i,o.addEventListener(\"change\",()=>Se(n,o.checked,e.tempVars));let a=l(\"label\",{for:o.id},s);return l(\"div\",{},o,\" \",a)};en[h]={skipArgs:!0};var tn=(e,...t)=>{if(t.length!==2)throw new Error(\"requires 2 arguments\");if(!t.every(u=>typeof u==\"string\"))throw new Error(\"both arguments must be strings\");let[n,r]=t,s=T(r,e.tempVars);if(typeof s!=\"string\"&&!(s instanceof Node))throw new Error(\"label must be a string or Node\");let i=J(T(n,e.tempVars)||\"\"),o=l(\"input\",{id:$e(),type:\"text\",value:i});o.addEventListener(\"keyup\",()=>Se(n,o.value,e.tempVars));let a=l(\"label\",{for:o.id},s);return l(\"div\",{},o,\" \",a)};tn[h]={skipArgs:!0};var nn=(e,...t)=>{let n=t;for(let r of n)if(!r.name.includes(\"if\")||T(r.args.join(\", \"),e.tempVars)){let s=document.createDocumentFragment();return e.render(s,r.body),s}return\"\"};nn[h]={skipArgs:!0,chainWith:/else(?:\\s+if)?\\s*/y};var rn=(e,...t)=>{if(t.length!==1)throw new Error(\"requires 1 arg\");if(!e.content)throw new Error(\"requires a body\");let[n]=t,r=[];for(let i of e.content)if(typeof i==\"string\"){if(i.trim())throw new Error(\"all children must be @case macros 1\")}else if(i.type===\"expr\"&&i.store===\"constants\"&&i.content&&(i.base===\"case\"&&i.ops.length===1&&i.ops[0].type===\"call\"||i.base===\"default\"&&i.ops.length===0))r.push(i);else throw new Error(\"all children must be @case macros 2\");for(let i=0;i<r.length;i++){let o=r[i],a=o.ops[0];if(o.base===\"default\"){if(i!==r.length-1)throw new Error(\"@default must be the last macro\")}else{if(o.base!==\"case\")throw new Error(\"all children must be @case macros 3\");if(a.args.length===0)throw new Error(\"@case macro requires at least one argument\")}}let s=document.createDocumentFragment();for(let i of r){if(i.base===\"default\")return i.content&&e.render(s,i.content),s;for(let o of i.ops[0].args){let a=T(o,e.tempVars);if(n===a)return i.content&&e.render(s,i.content),s}}return s};rn[h]=!0;var sn=(e,...t)=>{let{content:n}=e;if(!n)throw new Error(\"must be called with a body\");let r=l(\"span\",{class:\"brick-macro-redoable\"});try{e.content&&e.render(r,e.content)}catch(s){throw s instanceof O?new Y(s.context,`Can't @${s.type} from inside @${e.name}`):s}return r.addEventListener(\"brick-redo\",()=>{r.innerHTML=\"\",e.content&&e.render(r,e.content)}),r};sn[h]=!0;var on=(e,...t)=>{if(t.length!==0&&t.length!==1)throw new Error(\"does not take any args\");let n=40;if(t.length===1){if(typeof t[0]!=\"number\")throw new Error(\"first argument must be a number\");n=t[0]}let{content:r}=e;if(!r)throw new Error(\"requires a body\");let s=l(\"span\",{class:\"brick-macro-later\",hidden:\"\"});return setTimeout(()=>{let i=document.createDocumentFragment();e.render(i,r),s.replaceWith(i)},n),s};on[h]=!0;function Ze(e){return me((t,...n)=>{if(n.length!==1)throw new Error(\"requires exactly one argument\");if(typeof n[0]!=\"string\")throw new Error(\"first argument must be a string\");let r=document.querySelector(n[0]);if(!r)throw new Error(`The selector '${n[0]}' did not match any elements`);let s=document.createDocumentFragment();if(t.content)t.render(s,t.content);else if(e!==\"replace\")throw new Error('no content provided. Use \"{}\" to provide content.');switch(e){case\"append\":r.append(s);break;case\"prepend\":r.prepend(s);break;case\"replace\":r.innerHTML=\"\",r.append(s);break}return\"\"})}var an=(e,...t)=>{if(e.content)throw new Error(\"Does not take content\");if(t.length===0)throw new Error(\"requires at least one argument\");if(!t.every(n=>typeof n==\"string\"))throw new Error(\"received a non-string arg\");if(!t.every(n=>n.startsWith(\"brickTempVarScope.\")))throw new Error(\"only temp variables can be punted\");for(let n of t)un(n.slice(18));return\"\"};an[h]={skipArgs:!0};var cn=(e,...t)=>{if(!t.every(a=>typeof a==\"string\"))throw new Error(\"received a non-string arg\");if(t.length<1)throw new Error(\"macro name required\");if(!e.content)throw new Error(\"children (body) required\");let n=e.content,[r,...s]=t,i=s.map(a=>{let c=a.trim();console.log(c);let u=new RegExp(\"^brickTempVarScope.(\\\\p{ID_Start}\\\\p{ID_Continue}*)$\",\"u\").exec(c);if(!u)throw c.startsWith(\"_\")?new Error(`\"${c.replace(\"brickTempVarScope.\",\"_\")}\" is an invalid parameter name`):new Error(\"Parameter names must start with '_'\");return u[1]}),o=me((a,...c)=>{if(a.content)throw new Error(\"This macro was created with @macro and cannot receive children\");let u=e.createTempVariableScope();for(let[g,f]of i.entries())Object.defineProperty(u,f,{configurable:!0,enumerable:!0,writable:!0,value:c[g]});let m=document.createDocumentFragment();return a.render(m,n,u),m});return Se(r,o,e.tempVars),\"\"};cn[h]={skipArgs:!0};function I(e){return console.error(e),l(\"span\",{class:\"brick-error\"},J(e))}function C(e,t,n){if(typeof n==\"string\"){let r=R(n);return r?C(e,t,r):(e.innerHTML=\"\",e.append(l(\"span\",{class:\"brick-error\"},`No passage named \"${n}\" found`)),!1)}return e.innerHTML=\"\",e.classList.add(`psg-${n.slug}`),e.dataset.name=n.name,e.dataset.tags=n.tags.join(\" \"),Q(e,t,n)}var Ie=1e3,tt=!1;function Q(e,t,n,r){if(tt)return!1;if(Ie<=0){let i=(r==null?void 0:r.passageName)||n instanceof re&&n.name||\"unknown\",o=(r==null?void 0:r.lineNumber)||0,a=new N(\"Infinite recursion detected\",i,o);return e.append(I(a)),tt=!0,!1}let s;try{Ie--,s=mr(e,t,n,r)}finally{Ie++,Ie>=1e3&&(tt=!1)}return s}function mr(e,t,n,r){let s=!0;if(n instanceof re){let i=v.preProcessText?v.preProcessText(n):n.content;if(typeof i!=\"string\")throw new TypeError(`Config.preProcessText returned a ${typeof i}, expected a string`);let o=new se(i,n.name);return Q(e,t,o.parse(),r)}if(n instanceof N){let i=R(n.passage);if(!i)throw new Error(`Can't render a parse error that occurred in ${n.passage}`);e.append(I(n),l(\"br\"));let o=i.content.split(`\n`).map(c=>l(\"span\",{},c));o[n.lineNumber-1].classList.add(\"brick-error\");let a=l(\"code\");for(let c of o)a.append(c,l(\"br\"));return e.append(l(\"pre\",{},a)),!1}for(let i of n)if(typeof i==\"string\"){let o=i.split(`\n\n`),a=o.shift();if(typeof a==\"string\")for(e.append(a);typeof(a=o.shift())==\"string\";)e.append(l(\"br\")),e.append(l(\"br\")),e.append(a)}else if(i.type===\"expr\")s=fr(e,t,i,r)&&s;else if(i.type===\"chain\"){let o=i.segments[0].name,a=S[o];if(!oe(a))throw new Error(\"chain macro not a macro\");let c=new ce(o,i.passageName,i.lineNumber,t,r,[]);nt(e,a,c,i.segments)}else if(i.type===\"element\")s=pr(i,e,t,r)&&s;else if(i.type===\"linkBox\"){let o=S.link;if(!oe(o))throw\"link is not link\";let a=new ce(\"link\",i.passageName,i.lineNumber,t);nt(e,o,a,[i.text,i.link])}else if(i.type===\"error\")s=!1,e.append(I(new N(i.message,i.passageName,i.lineNumber)));else throw new Error(`Unknown NodeTemplate type: ${i.type}`);return s}function fr(e,t,n,r){var g;let s=n.store===\"constants\"?S:n.store===\"story\"?B:t,i={constants:\"@\",story:\"$\",temp:\"_\"}[n.store],o;try{o=s[n.base]}catch(f){let w=new _(f,i+n.base,n.passageName,n.lineNumber);return e.append(I(w)),!1}let a=null,c=((g=n.ops[n.ops.length-1])==null?void 0:g.type)===\"call\"?n.ops[n.ops.length-1]:void 0,u=c?n.ops.slice(0,-1):n.ops,m=i+n.base;for(let f of u)switch(f.type){case\"index\":{let w;try{w=f.needsEval?T(f.key.trim(),t):f.key}catch(y){let b=new _(y,f.raw.slice(1,-1),n.passageName,n.lineNumber);return e.append(I(b)),!1}a=o;try{o=o[w]}catch(y){let b=new _(y,`${m}${f.raw}`,n.passageName,n.lineNumber);return e.append(I(b)),!1}m+=f.raw;break}case\"call\":{let w=[];for(let b of f.args)try{w.push(T(b,t))}catch(D){let G=new _(D,b,n.passageName,n.lineNumber);return e.append(I(G)),!1}if(typeof o!=\"function\"){let b=new N(`\"${m}\" is not a function`,n.passageName,n.lineNumber);return e.append(I(b)),!1}let y;try{y=o.apply(a,w)}catch(b){let D=new _(b,m+f.raw,n.passageName,n.lineNumber);e.append(I(D))}a=o,o=y}}if(oe(o)){let f=(c==null?void 0:c.args)||[],w=new ce(m,n.passageName,n.lineNumber,t,r,n.content),y=o[h];if(!(typeof y==\"object\"&&y.skipArgs)){let D=f;f=[];for(let G of D)try{f.push(T(G,t))}catch(ge){let he=new _(ge,G,n.passageName,n.lineNumber);return e.append(I(he)),!1}}return nt(e,o,w,f)}else{if(n.content){let f=new N(`${m} is not a macro`,n.passageName,n.lineNumber);return e.append(I(f)),!1}if(c){if(typeof o!=\"function\"){let y=new N(`\"${m}\" is not a function`,n.passageName,n.lineNumber);return e.append(I(y)),!1}let f=[];for(let y of c.args)try{f.push(T(y,t))}catch(b){let D=new _(b,y,n.passageName,n.lineNumber);return e.append(I(D)),!1}let w=o.apply(a,f);a=o,o=w}e.append(o instanceof Node?o:String(o))}return!0}function pr(e,t,n,r){let s=l(e.name);for(let[o,a]of e.attributes)s.setAttribute(o,a);for(let[o,a]of e.evalAttributes)try{let c=T(a,n);o.startsWith(\"on\")&&o.length>=3&&typeof c==\"function\"?s.addEventListener(o.substring(2),c):s.setAttribute(o,J(c))}catch(c){if(c instanceof O)throw c;return t.append(I(new we(c,o,e))),!1}let i=Q(s,n,e.content,r);return t.append(s),i}function nt(e,t,n,r){try{let s=t.call(null,n,...r);return e.append(s),!0}catch(s){if(s instanceof O)throw s;let i=s instanceof Y?s:new Y(n,s);return e.append(I(i)),!1}}var le,$,H,L,ee,U,te,B,P,S;function dr(e,t){return typeof t==\"string\"?`Unknown story variable \"$${e}\". Did you mean \"$${t}\"?`:`Unknown story variable \"$${e}\".`}function gr(e,t){return typeof t==\"string\"?`Unknown temporary variable \"_${e}\". Did you mean \"_${t}\"?`:`Unknown temporary variable \"_${e}\".`}function hr(e,t){return typeof t==\"string\"?`Unknown constant \"@${e}\". Did you mean \"@${t}\"?`:`Unknown constant \"@${e}\".`}function rt(e){return ye(e||{},dr)}function st(){return ye({},gr)}function wr(){return ye({},hr)}async function mn(){le=ne(\"brick-main\"),le.innerHTML=\"\",$=[],H=[],L=-1,ee=0,U=\"\",B=rt(),P=st(),S=wr(),te=[]}async function fn(){if(Object.freeze(S),!await Le(\"active\")){ee=1,U=bt().name,B=rt(),P=st(),te=[];let e={passageName:U,timestamp:Date.now(),turnCount:ee,vars:B};H=[e],$=[await xe(e)],L=0,Ae(),fe()}}function ze(){return U}async function ot(){let e=H[L];e||(e=await We($[L]),H[L]=e),B=rt(V(e.vars)),ee=e.turnCount,U=e.passageName}async function Me(){if(L===0)return!1;if(v.stream){let e=Array.from(document.querySelectorAll(\".brick-passage\"));for(let t of e.slice(-2))t.remove()}return L--,await ot(),Ae(),fe(),!0}async function Ne(){return L===$.length-1?!1:(L++,await ot(),Ae(),fe(),!0)}async function ln(e){U=typeof e==\"string\"?e:e.name,$.length=L+1,H.length=L+1,ee++,te.length>0&&(B[\"-brick-punted\"]=te.map(n=>[n,P[n]]));let t={passageName:U,timestamp:Date.now(),turnCount:ee,vars:V(B)};H.push(t),$.push(await xe(t)),H.length>v.historyLength&&(H=H.slice(-v.historyLength),$=$.slice(-v.historyLength)),L=$.length-1,Ae(),fe()}async function pn(){return await Dt($,L,dn())}async function Le(e){let t=await Ke(e);return t?($=t.momentIds,H=Array($.length),H.fill(void 0),L=t.index,await ot(),le.innerHTML=\"\",fe(),!0):!1}function dn(){return`${U} | Turn ${ee}`}function Ae(){return $t($,L,dn())}function fe(){if(P=st(),te=[],\"-brick-punted\"in B&&B[\"-brick-punted\"]instanceof Array)for(let[r,s]of B[\"-brick-punted\"])typeof r!=\"string\"?console.warn(\"non-string key in $-brick-punted\"):P[r]=s;if(delete B[\"-brick-punted\"],v.stream){for(let r of le.querySelectorAll(\":enabled\"))r.setAttribute(\"disabled\",\"\");for(let r of document.querySelectorAll(\".brick-active-passage\"))r.classList.remove(\"brick-active-passage\")}else le.innerHTML=\"\";let e=l(\"article\",{class:\"brick-passage brick-active-passage brick-transparent\"});C(e,P,U);let t=R(\"StoryHeader\"),n=R(\"StoryFooter\");if(t){let r=l(\"header\");C(r,P,t),e.prepend(r)}if(n){let r=l(\"footer\");C(r,P,n),e.append(r)}le.append(e),e.scrollIntoView(),setTimeout(()=>e.classList.remove(\"brick-transparent\"),40)}function gn(){Rt(),window.location.reload()}function qt(){for(let e of document.querySelectorAll(\".brick-macro-redoable\"))e.dispatchEvent(new CustomEvent(\"brick-redo\"))}function un(e){te.includes(e)&&console.warn(`_${e} was already punted`),te.push(e)}p();var hn={generic:{cancel:\"Cancel\",restart:\"Restart\"},misc:{restartConfirmation:\"Are you sure you would like to restart?\"},savesDialog:{delete:\"Delete\",deleteAll:\"Delete All\",deleteMode:\"Delete\",export:\"Export\",exportMode:\"Export\",empty:\"No saves found\",import:\"Import\",loadSave:\"Load\",newSave:\"Save\",title:\"Saves\"}};var br=hn;function kr(e,t){let n=t.split(\".\"),r=e,s;for(let[i,o]of n.entries()){if(!(o in r))throw new Error(`Invalid key: ${n.slice(0,i+1).join(\".\")}`);let a=r;if(i===n.length-1)s=a[o];else{if(typeof a[o]!=\"object\"||a[o]===null)throw new Error(`\"${n.slice(0,i+1).join(\".\")}\" is not an object`);r=a[o]}}return s}function E(e,t){let n;try{n=kr(br,e)}catch(r){console.error(r)}return typeof n==\"string\"?n:`{{${e}}}`}var A,pe,j,wn;function yn(e){wn=e;let t=ne(\"brick-dialog\");if(t instanceof HTMLDialogElement)A=t;else throw new Error(\"#brick-dialog was not a <dialog> element\");Be(),A.addEventListener(\"click\",n=>{let r=A.getBoundingClientRect(),{clientX:s,clientY:i}=n;r.top<=i&&i<=r.top+r.height&&r.left<=s&&s<=r.left+r.width||A.close()})}function Be(){A.innerHTML=\"\",A.className=\"\",pe=l(\"h1\");let e=l(\"div\",{},pe);j=l(\"div\"),A.append(e,j)}function Wt(e){Be(),pe.append(e),C(j,{},e),A.showModal()}async function bn(){Be(),pe.append(E(\"savesDialog.title\")),j.append(\"Loading...\"),A.classList.add(\"brick-saves-menu\"),A.showModal();let e=await Pt();e.sort((s,i)=>i.timestamp-s.timestamp);let t=await Promise.all(e.map(kn));j.innerHTML=\"\";let n=l(\"ul\");j.append(n),t.length===0?n.append(l(\"li\",{class:\"brick-saves-empty\"},l(\"em\",{},E(\"savesDialog.empty\")))):n.append(...t);let r=l(\"div\",{class:\"brick-saves-buttons\"});Ce(n,r),j.append(r)}function Ce(e,t){let n=l(\"button\",{class:\"brick-ui-btn\"},E(\"savesDialog.deleteMode\"));n.addEventListener(\"click\",()=>{for(let a of e.querySelectorAll(\"button\"))a.removeEventListener(\"click\",de),a.addEventListener(\"click\",En),a.textContent=\"Delete\";Er(e,t)});let r=l(\"button\",{class:\"brick-ui-btn\"},E(\"savesDialog.exportMode\"));r.addEventListener(\"click\",()=>{for(let a of e.querySelectorAll(\"button\"))a.removeEventListener(\"click\",de),a.addEventListener(\"click\",xn),a.textContent=E(\"savesDialog.export\");xr(e,t)});let s=l(\"input\",{type:\"file\"});s.addEventListener(\"change\",async()=>{if(!s.files||s.files.length===0)return;let a=await Vt(s.files[0]);A.close(),await Le(a)});let i=l(\"button\",{class:\"brick-ui-btn\"},E(\"savesDialog.import\"));i.addEventListener(\"click\",()=>s.click());let o=l(\"button\",{class:\"brick-ui-btn\"},E(\"savesDialog.newSave\"));o.addEventListener(\"click\",async()=>{var c;let a=await pn();(c=e.querySelector(\".brick-saves-empty\"))==null||c.remove(),e.prepend(kn(a))}),t.innerHTML=\"\",t.append(n,r,i,o)}function Er(e,t){let n=l(\"button\",{class:\"brick-ui-btn\",disabled:\"\"},E(\"savesDialog.deleteAll\"));n.addEventListener(\"click\",async function(){this.disabled=!0,await Ot(),e.innerHTML=\"\",e.append(l(\"li\",{},l(\"em\",{},\"No saves found\"))),Ce(e,t)}),setTimeout(()=>{n.disabled=!1},2e3);let r=l(\"button\",{class:\"brick-ui-btn\"},E(\"generic.cancel\"));r.addEventListener(\"click\",()=>{let s=E(\"savesDialog.loadSave\");for(let i of e.querySelectorAll(\"button\"))i.removeEventListener(\"click\",En),i.addEventListener(\"click\",de),i.textContent=s;Ce(e,t)}),t.innerHTML=\"\",t.append(n,r)}function xr(e,t){let n=l(\"button\",{class:\"brick-ui-btn\"},E(\"generic.cancel\"));n.addEventListener(\"click\",()=>{let r=E(\"savesDialog.loadSave\");for(let s of e.querySelectorAll(\"button\"))s.removeEventListener(\"click\",xn),s.addEventListener(\"click\",de),s.textContent=r;Ce(e,t)}),t.innerHTML=\"\",t.append(n)}function kn(e){let t=new Date(e.timestamp).toLocaleString(),{id:n}=e;if(!n)throw new Error(\"Tried to create a save menu entry for an unsaved History\");let r=l(\"button\",{class:\"brick-ui-btn\",\"data-brick-history-id\":String(n)},E(\"savesDialog.loadSave\"));return r.addEventListener(\"click\",de),l(\"li\",{},l(\"div\",{},e.title,l(\"br\"),l(\"small\",{},t)),r)}async function de(){let e=Number(this.dataset.brickHistoryId);if(e!==e)throw new Error(`Tried to load invalid ID \"${this.dataset.brickHistoryId}\"`);if(A.close(),!await Le(e))throw new Error(`Could not load history #${e}`)}async function En(){var n,r;let e=Number(this.dataset.brickHistoryId);if(e!==e)throw new Error(`Tried to delete invalid ID \"${this.dataset.brickHistoryId}\"`);await Ht(e);let t=(n=this.parentElement)==null?void 0:n.parentElement;(r=this.parentElement)==null||r.remove(),t&&t.childElementCount===0&&t.append(l(\"li\",{class:\"brick-saves-empty\"},l(\"em\",{},E(\"savesDialog.empty\"))))}async function xn(){let e=Number(this.dataset.brickHistoryId);if(Number.isNaN(e))throw new Error(`Tried to export invalid ID \"${this.dataset.brickHistoryId}\"`);let t=await _t(e),n=new Date(t.timestamp).toISOString().replace(/-|:|\\..*/g,\"\").replace(\"T\",\"-\"),r=`${wn}-${n}.json`,s=URL.createObjectURL(new Blob([JSON.stringify(t)],{type:\"application/json\"}));l(\"a\",{download:r,href:s}).click(),URL.revokeObjectURL(s)}function vn(){Be(),A.classList.add(\"brick-restart\"),pe.textContent=\"Restart\",j.append(l(\"p\",{},E(\"misc.restartConfirmation\")));let e=l(\"button\",{class:\"brick-ui-btn\"},E(\"generic.restart\"));e.addEventListener(\"click\",gn);let t=l(\"button\",{class:\"brick-ui-btn\"},E(\"generic.cancel\"));t.addEventListener(\"click\",()=>A.close()),j.append(e,t),A.showModal()}async function Sn(){let e=document.getElementsByTagName(\"tw-storydata\")[0];wt(e);let t=e.querySelectorAll('style[type=\"text/twine-css\"]'),n=e.querySelectorAll('script[type=\"text/twine-javascript\"]'),r=R(\"StoryInterface\");r&&(ne(\"brick-viewport\").outerHTML=r.content);let s=e.getAttribute(\"name\")||(()=>{throw new Error(\"Story has no title\")})(),i=e.getAttribute(\"ifid\")||\"00000000-0000-4000-A000-000000000000\";for(let c of t){let u=l(\"style\",{class:\"brick-author-style\"},c.textContent);document.head.appendChild(u)}function o(c,u){var m;(m=document.getElementById(c))==null||m.addEventListener(\"click\",u)}o(\"brick-history-backward\",Me),o(\"brick-history-forward\",Ne),o(\"brick-saves\",bn),o(\"brick-restart\",vn),yn(K(s)),await Ct(s,i),await mn(),Ut(),Kt(S);for(let c of be(\"macro\")){if(!new RegExp(\"\\\\p{ID_Start}\\\\p{ID_Continue}*\",\"u\").test(c.name))throw new Error(`The passage \"${c.name}\" cannot be made into a macro. Either change its name to a valid identifier, or remove the \"macro\" tag.`);let u=(m,...g)=>{if(m.content)throw new Error('This macro was created with the \"macro\" tag and cannot take children');if(g.length!==0)throw new Error('This macro was created with the \"macro\" tag and does not accept arguments');let f=l(\"div\");return C(f,P,c),f};u[h]=!0,S[c.name]=u}await kt(e);for(let c of n){let u=URL.createObjectURL(new Blob([c.textContent],{type:\"text/javascript\"}));await import(u),URL.revokeObjectURL(u)}let a=R(\"StoryInit\");if(a){let c=l(\"div\");C(c,P,a),c.normalize();let u=c.textContent.trim();u&&console.warn(`StoryInit, when rendered, contained non-whitespace characters. This is likely an error. Its contents:\n`+u)}await fn()}function Sr(){Bt()}window.brickInit=Sn;window.brickFinish=Sr;document.documentElement.dataset.brickTest||(window.addEventListener(\"error\",e=>{let{error:t}=e,n=\"\";t instanceof Error?(n+=`Fatal Error!\n`,n+=t.toString(),t.stack&&(n+=`\n`+t.stack)):t instanceof O?n+=`@${t.type} was called outside a loop, at \"${t.context.passageName}\" line ${t.context.lineNumber}`:(n+=`Non-error object was thrown and not caught:\n`,n+=J(e)),alert(n)}),window.addEventListener(\"unhandledrejection\",e=>{let{reason:t}=e;alert(`Fatal Error!\n${t}`)}),Sn());})();\n\n    </script>\n  </body>\n</html>\n","hydrate":"function startState(){return{blockComment:!1,js:!1,nesting:[],jsNesting:[],status:\"default\"}}const KEYWORDS=\"break case catch class const continue debugger default delete do else export extends false finally for function if import in instanceof new null return super switch this throw true try typeof var void while with let static yield await enum implements interface package private protected public arguments as async eval from get of set undefined\".split(\" \"),OPERATORS=[\"!\",\"!=\",\"!==\",\"%\",\"%=\",\"&\",\"&&\",\"&=\",\"&&=\",\"*\",\"**\",\"*=\",\"**=\",\"+\",\"++\",\"+=\",\"-\",\"--\",\"-=\",\"/\",\"/=\",\"<\",\"<<\",\"<=\",\"<<=\",\"=\",\"==\",\"===\",\"=>\",\">\",\">>\",\">>>\",\">=\",\">>=\",\">>>=\",\"^\",\"^=\",\"|\",\"||\",\"|=\",\"||=\",\"~\"],RE_NUMBER_ERROR=/^[_0-9.a-fA-F]+n?/,RE_NUMBER_LEADING_ZERO=/^(?:[bB](?:_?[01])+n?|[oO](?:_?[0-7])+n?|[xX](?:_?[0-9a-fA-F])+n?|n|(?:\\.(?:_?[0-9])*)?(?:[eE](?:_?[0-9])+)?)/,RE_POSTNUMBER_ERROR=/^[_0-9\\p{ID_Start}]/u;function postNumberCheck(e){return e.match(RE_POSTNUMBER_ERROR)?\"error number\":\"number\"}function tokenJsNumber(e,r){if(r===\"0\"){if(e.match(RE_NUMBER_LEADING_ZERO))return postNumberCheck(e);if(e.eol()||e.peek().match(/^[^0-9\\p{ID_Start}]/u))return postNumberCheck(e)}else if(r===\".\"){if(e.match(/^(?:_?[0-9])+(?:[eE](?:_?[0-9])+)?/))return postNumberCheck(e)}else if(e.match(/^(?:(?:_?[0-9])*(?:\\.(?:_?[0-9])*)?(?:[eE](?:_?[0-9])+)?|(?:_?[0-9])*n)/))return postNumberCheck(e);return e.match(RE_NUMBER_ERROR),\"error number\"}function tokenJs(e,r){if(e.match(/^[!%&*+\\-<=>^|~]+/))return OPERATORS.includes(e.current())?\"operator\":\"error operator\";if(e.match(/^@?[$_a-zA-Z][$_a-zA-Z0-9]*/))return[\"$\",\"_\",\"@\"].includes(e.current()[0])?\"variable-2\":KEYWORDS.includes(e.current())?\"keyword\":\"variable\";const n=e.next();if(n>=\"0\"&&n<=\"9\"||n===\".\"&&e.peek()>=\"0\"&&e.peek()<=\"9\")return tokenJsNumber(e,n);switch(n){case\"/\":return e.peek()===\"/\"?(e.skipToEnd(),\"comment\"):e.peek()===\"*\"?(e.next(),r.blockComment=!0,\"comment\"):(e.eat(\"=\"),\"operator\");case\"(\":return r.jsNesting.push(\")\"),\"bracket\";case\"{\":return r.jsNesting.push(\"}\"),\"bracket\";case\"[\":return r.jsNesting.push(\"]\"),\"bracket\";case\")\":case\"}\":case\"]\":return n===r.jsNesting[r.jsNesting.length-1]?(r.jsNesting.pop(),r.jsNesting.length===0&&(r.js=!1),\"bracket\"):\"bracket error\";case'\"':return e.match(/^(?:[^\\\\\"]|\\\\[^]])*\"/)?\"string\":(e.skipToEnd(),\"string error\");case\"'\":return e.match(/^(?:[^\\\\']|\\\\[^])*'/)?\"string\":(e.skipToEnd(),\"string error\");default:return e.eatSpace(),null}}const miniModes={closingTag(e,r){return r.status=\"default\",e.match(/^\\s*>/)?\"bracket\":(e.next(),\"error\")},closingTagPreName(e,r){return e.match(new RegExp(\"\\\\p{ID_Start}\\\\p{ID_Continue}*(?:-\\\\p{ID_Continue})*\",\"u\"))?(r.status=\"closingTag\",\"tag\"):(r.status=\"default\",e.next(),\"error\")},expectAttrValue(e,r){return e.match(/^\"([^\"]*)\"/)?(r.status=\"openTag\",\"string\"):e.match(/^\".*/)?(r.status=\"default\",\"string error\"):e.eat(\"(\")?(r.js=!0,r.jsNesting=[\")\"],r.status=\"openTag\",\"bracket\"):(r.status=\"default\",e.next(),\"error\")},exprFollowUp(e,r){return e.eat(\"[\")?(r.jsNesting=[\"]\"],r.js=!0,\"bracket\"):e.eat(\"(\")?(r.jsNesting=[\")\"],r.js=!0,\"bracket\"):e.eat(\".\")?(r.status=\"exprPostDot\",e.peek()&&new RegExp(\"\\\\p{ID_Start}\",\"u\").test(e.peek())?\"variable-2\":\"\"):e.match(/^\\s*\\{/)?(r.nesting.push(\"}\"),\"bracket\"):(r.status=\"default\",token(e,r))},exprPostDot(e,r){return e.match(new RegExp(\"^\\\\p{ID_Start}\\\\p{ID_Continue}*\",\"u\"))?(r.status=\"exprFollowUp\",\"variable-2\"):(r.status=\"default\",token(e,r))},macroFollowUp(e,r){return e.match(/^\\s*\\(/)?(r.jsNesting=[\")\"],r.js=!0,r.status=\"exprFollowUp\",\"bracket\"):miniModes.exprFollowUp(e,r)},openTag(e,r){return r.maybeAttrEquals&&(r.maybeAttrEquals=!1,e.eat(\"=\"))?(r.status=\"expectAttrValue\",\"\"):e.match(/^\\s*\\/?>/)?(r.status=\"default\",\"bracket\"):e.match(new RegExp(\"^\\\\s*\\\\p{ID_Start}\\\\p{ID_Continue}*(?:-\\\\p{ID_Continue})*\",\"u\"))?(r.maybeAttrEquals=!0,\"attribute\"):(e.next(),r.status=\"default\",\"error\")},openTagPreName(e,r){return e.match(new RegExp(\"^\\\\p{ID_Start}\\\\p{ID_Continue}*(?:-\\\\p{ID_Continue})*\",\"u\"))?(r.status=\"openTag\",\"tag\"):(r.status=\"default\",e.next(),\"error\")},wikiLink(e,r){return e.match(/^->|<-|\\|/)?\"bracket\":e.match(\"]]\")?(r.status=\"default\",\"bracket\"):(e.match(/^[^<|\\-\\]]+/)||e.next(),null)}};function token(e,r){if(r.blockComment)return e.match(/^[^]*?\\*\\//)?r.blockComment=!1:e.skipToEnd(),\"comment\";if(r.js)return tokenJs(e,r);if(r.status in miniModes)return miniModes[r.status](e,r);const n=e.next();switch(n){case\"@\":case\"$\":case\"_\":return e.match(new RegExp(\"^\\\\p{ID_Start}\\\\p{ID_Continue}*\",\"u\"))||n===\"@\"&&e.peek()===\"(\"?(r.status=n===\"@\"?\"macroFollowUp\":\"exprFollowUp\",n===\"@\"?\"keyword\":\"variable-2\"):\"error\";case\"/\":return e.peek()===\"/\"?(e.skipToEnd(),\"comment\"):e.peek()===\"*\"?(e.next(),r.blockComment=!0,\"comment\"):null;case\"{\":return\"error\";case\"[\":if(e.eat(\"[\"))return r.status=\"wikiLink\",\"bracket\";case\"}\":return n===r.nesting.at(-1)?(r.nesting.pop(),\"bracket\"):\"error\";case\"\\\\\":return e.next(),\"atom\";case\"<\":{const t=e.peek();return t&&new RegExp(\"\\\\p{ID_Start}\",\"u\").test(t)?(r.status=\"openTagPreName\",\"bracket\"):t===\"/\"?(e.next(),r.status=\"closingTagPreName\",\"bracket\"):\"bracket error\"}case\">\":return\"error\";default:return e.match(/^[^$_/@{}\\\\<>\\[]*/),null}}function mode(){return{startState,token}}function register(e){e.defineMode(\"brick\",mode)}this.editorExtensions={twine:{\"^2.4.0\":{codeMirror:{mode}}}};\n","url":"https://github.com/cjneidhart/brick","license":"GPL-3.0"});