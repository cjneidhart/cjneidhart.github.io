window.storyFormat({"name":"Brick","version":"0.2.2","author":"Chris Neidhart","image":"icon.svg","description":"A modern story format with a JavaScript-like syntax, and a focus on performance and simplicity.<br><br><a href=\"https://github.com/cjneidhart/brick\">Homepage</a>","source":"<!doctype html>\n<html lang=\"en-US\" data-bs-theme=\"dark\">\n  <head>\n    <meta charset=\"utf-8\" />\n    <title>{{STORY_NAME}}</title>\n    <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" />\n    <style id=\"style-bootstrap\">\n      /*!\n * Bootstrap Reboot v5.3.3 (https://getbootstrap.com/)\n * Copyright 2011-2024 The Bootstrap Authors\n * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)\n */:root,[data-bs-theme=light]{--bs-blue:#0d6efd;--bs-indigo:#6610f2;--bs-purple:#6f42c1;--bs-pink:#d63384;--bs-red:#dc3545;--bs-orange:#fd7e14;--bs-yellow:#ffc107;--bs-green:#198754;--bs-teal:#20c997;--bs-cyan:#0dcaf0;--bs-black:#000;--bs-white:#fff;--bs-gray:#6c757d;--bs-gray-dark:#343a40;--bs-gray-100:#f8f9fa;--bs-gray-200:#e9ecef;--bs-gray-300:#dee2e6;--bs-gray-400:#ced4da;--bs-gray-500:#adb5bd;--bs-gray-600:#6c757d;--bs-gray-700:#495057;--bs-gray-800:#343a40;--bs-gray-900:#212529;--bs-primary:#0d6efd;--bs-secondary:#6c757d;--bs-success:#198754;--bs-info:#0dcaf0;--bs-warning:#ffc107;--bs-danger:#dc3545;--bs-light:#f8f9fa;--bs-dark:#212529;--bs-primary-rgb:13,110,253;--bs-secondary-rgb:108,117,125;--bs-success-rgb:25,135,84;--bs-info-rgb:13,202,240;--bs-warning-rgb:255,193,7;--bs-danger-rgb:220,53,69;--bs-light-rgb:248,249,250;--bs-dark-rgb:33,37,41;--bs-primary-text-emphasis:#052c65;--bs-secondary-text-emphasis:#2b2f32;--bs-success-text-emphasis:#0a3622;--bs-info-text-emphasis:#055160;--bs-warning-text-emphasis:#664d03;--bs-danger-text-emphasis:#58151c;--bs-light-text-emphasis:#495057;--bs-dark-text-emphasis:#495057;--bs-primary-bg-subtle:#cfe2ff;--bs-secondary-bg-subtle:#e2e3e5;--bs-success-bg-subtle:#d1e7dd;--bs-info-bg-subtle:#cff4fc;--bs-warning-bg-subtle:#fff3cd;--bs-danger-bg-subtle:#f8d7da;--bs-light-bg-subtle:#fcfcfd;--bs-dark-bg-subtle:#ced4da;--bs-primary-border-subtle:#9ec5fe;--bs-secondary-border-subtle:#c4c8cb;--bs-success-border-subtle:#a3cfbb;--bs-info-border-subtle:#9eeaf9;--bs-warning-border-subtle:#ffe69c;--bs-danger-border-subtle:#f1aeb5;--bs-light-border-subtle:#e9ecef;--bs-dark-border-subtle:#adb5bd;--bs-white-rgb:255,255,255;--bs-black-rgb:0,0,0;--bs-font-sans-serif:system-ui,-apple-system,\"Segoe UI\",Roboto,\"Helvetica Neue\",\"Noto Sans\",\"Liberation Sans\",Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\",\"Segoe UI Symbol\",\"Noto Color Emoji\";--bs-font-monospace:SFMono-Regular,Menlo,Monaco,Consolas,\"Liberation Mono\",\"Courier New\",monospace;--bs-gradient:linear-gradient(180deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0));--bs-body-font-family:var(--bs-font-sans-serif);--bs-body-font-size:1rem;--bs-body-font-weight:400;--bs-body-line-height:1.5;--bs-body-color:#212529;--bs-body-color-rgb:33,37,41;--bs-body-bg:#fff;--bs-body-bg-rgb:255,255,255;--bs-emphasis-color:#000;--bs-emphasis-color-rgb:0,0,0;--bs-secondary-color:rgba(33, 37, 41, 0.75);--bs-secondary-color-rgb:33,37,41;--bs-secondary-bg:#e9ecef;--bs-secondary-bg-rgb:233,236,239;--bs-tertiary-color:rgba(33, 37, 41, 0.5);--bs-tertiary-color-rgb:33,37,41;--bs-tertiary-bg:#f8f9fa;--bs-tertiary-bg-rgb:248,249,250;--bs-heading-color:inherit;--bs-link-color:#0d6efd;--bs-link-color-rgb:13,110,253;--bs-link-decoration:underline;--bs-link-hover-color:#0a58ca;--bs-link-hover-color-rgb:10,88,202;--bs-code-color:#d63384;--bs-highlight-color:#212529;--bs-highlight-bg:#fff3cd;--bs-border-width:1px;--bs-border-style:solid;--bs-border-color:#dee2e6;--bs-border-color-translucent:rgba(0, 0, 0, 0.175);--bs-border-radius:0.375rem;--bs-border-radius-sm:0.25rem;--bs-border-radius-lg:0.5rem;--bs-border-radius-xl:1rem;--bs-border-radius-xxl:2rem;--bs-border-radius-2xl:var(--bs-border-radius-xxl);--bs-border-radius-pill:50rem;--bs-box-shadow:0 0.5rem 1rem rgba(0, 0, 0, 0.15);--bs-box-shadow-sm:0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);--bs-box-shadow-lg:0 1rem 3rem rgba(0, 0, 0, 0.175);--bs-box-shadow-inset:inset 0 1px 2px rgba(0, 0, 0, 0.075);--bs-focus-ring-width:0.25rem;--bs-focus-ring-opacity:0.25;--bs-focus-ring-color:rgba(13, 110, 253, 0.25);--bs-form-valid-color:#198754;--bs-form-valid-border-color:#198754;--bs-form-invalid-color:#dc3545;--bs-form-invalid-border-color:#dc3545}[data-bs-theme=dark]{color-scheme:dark;--bs-body-color:#dee2e6;--bs-body-color-rgb:222,226,230;--bs-body-bg:#212529;--bs-body-bg-rgb:33,37,41;--bs-emphasis-color:#fff;--bs-emphasis-color-rgb:255,255,255;--bs-secondary-color:rgba(222, 226, 230, 0.75);--bs-secondary-color-rgb:222,226,230;--bs-secondary-bg:#343a40;--bs-secondary-bg-rgb:52,58,64;--bs-tertiary-color:rgba(222, 226, 230, 0.5);--bs-tertiary-color-rgb:222,226,230;--bs-tertiary-bg:#2b3035;--bs-tertiary-bg-rgb:43,48,53;--bs-primary-text-emphasis:#6ea8fe;--bs-secondary-text-emphasis:#a7acb1;--bs-success-text-emphasis:#75b798;--bs-info-text-emphasis:#6edff6;--bs-warning-text-emphasis:#ffda6a;--bs-danger-text-emphasis:#ea868f;--bs-light-text-emphasis:#f8f9fa;--bs-dark-text-emphasis:#dee2e6;--bs-primary-bg-subtle:#031633;--bs-secondary-bg-subtle:#161719;--bs-success-bg-subtle:#051b11;--bs-info-bg-subtle:#032830;--bs-warning-bg-subtle:#332701;--bs-danger-bg-subtle:#2c0b0e;--bs-light-bg-subtle:#343a40;--bs-dark-bg-subtle:#1a1d20;--bs-primary-border-subtle:#084298;--bs-secondary-border-subtle:#41464b;--bs-success-border-subtle:#0f5132;--bs-info-border-subtle:#087990;--bs-warning-border-subtle:#997404;--bs-danger-border-subtle:#842029;--bs-light-border-subtle:#495057;--bs-dark-border-subtle:#343a40;--bs-heading-color:inherit;--bs-link-color:#6ea8fe;--bs-link-hover-color:#8bb9fe;--bs-link-color-rgb:110,168,254;--bs-link-hover-color-rgb:139,185,254;--bs-code-color:#e685b5;--bs-highlight-color:#dee2e6;--bs-highlight-bg:#664d03;--bs-border-color:#495057;--bs-border-color-translucent:rgba(255, 255, 255, 0.15);--bs-form-valid-color:#75b798;--bs-form-valid-border-color:#75b798;--bs-form-invalid-color:#ea868f;--bs-form-invalid-border-color:#ea868f}*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:var(--bs-body-font-family);font-size:var(--bs-body-font-size);font-weight:var(--bs-body-font-weight);line-height:var(--bs-body-line-height);color:var(--bs-body-color);text-align:var(--bs-body-text-align);background-color:var(--bs-body-bg);-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;border:0;border-top:var(--bs-border-width) solid;opacity:.25}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2;color:var(--bs-heading-color)}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.1875em;color:var(--bs-highlight-color);background-color:var(--bs-highlight-bg)}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:rgba(var(--bs-link-color-rgb),var(--bs-link-opacity,1));text-decoration:underline}a:hover{--bs-link-color-rgb:var(--bs-link-hover-color-rgb)}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:var(--bs-font-monospace);font-size:1em}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:var(--bs-code-color);word-wrap:break-word}a>code{color:inherit}kbd{padding:.1875rem .375rem;font-size:.875em;color:var(--bs-body-bg);background-color:var(--bs-body-color);border-radius:.25rem}kbd kbd{padding:0;font-size:1em}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:var(--bs-secondary-color);text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]:not([type=date]):not([type=datetime-local]):not([type=month]):not([type=week]):not([type=time])::-webkit-calendar-picker-indicator{display:none!important}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}::file-selector-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}\n/* */\n    </style>\n    <style id=\"style-brick\">\n      #brick-viewport{display:flex;flex-direction:column}#brick-viewport>*{flex:1}.brick-linkReplace,.brick-active-passage{transition:opacity .4s}.brick-transparent{opacity:0}#ui-bar{background-color:var(--bs-secondary-bg);border-bottom:1px solid var(--bs-border-color);overflow-block:auto;padding:.5rem;width:100%}.brick-ui-btn{background-color:#364d63;border:1px solid var(--bs-secondary);padding-block:.25rem;transition:border-color .15s ease-in-out,background-color .15s ease-in-out}.brick-ui-btn:hover:enabled,.brick-ui-btn:focus{background-color:#3e5974}.brick-ui-btn:disabled{color:var(--bs-secondary)}#brick-history-controls{display:flex;flex-direction:row;text-align:center;width:100%;margin-bottom:.5rem}#brick-history-controls>*{flex-grow:1}#story-title{text-align:center}#brick-menu-core{width:100%;text-align:center;list-style:none;padding:0}#brick-menu-core button{width:100%}#brick-main{max-width:60rem}.brick-passage{padding:1rem}.brick-passage:not(:last-child){border-bottom:1px solid currentColor;padding-bottom:1rem}.brick-active-passage{margin-bottom:5rem;min-height:100vh}@media (min-width: 60rem){#brick-viewport{flex-direction:row}#ui-bar{border-bottom:0;border-right:1px solid var(--bs-border-color);height:100vh;height:100dvh;max-width:24rem;position:-webkit-sticky;position:sticky;top:0;width:auto}#brick-main{margin-inline:auto}.brick-active-passage{min-height:unset}}#brick-dialog{border-color:var(--bs-border-color);border-radius:.5rem;margin-top:2rem;max-width:min(95vw,50rem);max-width:min(95svw,50rem);min-width:min(95vw,30rem);min-width:min(95svw,30rem);overflow-x:auto}#brick-dialog::backdrop{-webkit-backdrop-filter:brightness(50%) blur(.25rem);backdrop-filter:brightness(50%) blur(.25rem)}#brick-dialog.brick-saves table{border:1px solid var(--bs-border-color);width:100%}#brick-dialog.brick-saves table :is(th,td){border:1px solid var(--bs-border-color);padding:.25rem}#brick-dialog.brick-saves table td:nth-child(3){width:100%}#brick-dialog.brick-saves table td:last-child button:enabled{background-color:var(--bs-danger)}#brick-dialog.brick-saves table td:last-child button:enabled:hover{background-color:inherit;color:var(--bs-danger)}.brick-link{padding:0;border:0;background:none;text-decoration:underline var(--bs-link-color);color:var(--bs-link-color)}.brick-link:hover:enabled{color:var(--bs-link-hover-color);-webkit-text-decoration-color:var(--bs-link-hover-color);text-decoration-color:var(--bs-link-hover-color)}.brick-link:disabled{color:var(--bs-secondary);cursor:not-allowed;-webkit-text-decoration-color:var(--bs-secondary);text-decoration-color:var(--bs-secondary)}.brick-text-secondary{color:var(--bs-secondary)}.brick-error{background-color:#5c0a0a;border-inline:.25rem solid red;line-height:2;padding:.25rem}.brick-error code{background-color:var(--bs-body-bg);color:var(--bs-body-color);padding:.125rem}.brick-saves-menu ul{border:1px solid currentColor;list-style:none;padding:0}.brick-saves-menu li:not(:first-child){border-top:1px solid currentColor}.brick-saves-menu li{display:flex;flex-direction:row;padding:.25rem}.brick-saves-menu li>div{flex-grow:1}.brick-saves-empty{color:var(--bs-secondary)}.brick-saves-buttons{display:flex;flex-direction:row;justify-content:space-between}dialog.brick-restart .brick-ui-btn{margin-right:1em}\n\n    </style>\n  </head>\n\n  <body>\n    {{STORY_DATA}}\n    <div id=\"brick-viewport\">\n      <aside id=\"ui-bar\">\n        <div id=\"brick-history-controls\">\n          <button id=\"brick-history-backward\" class=\"brick-ui-btn\" type=\"button\">&#x2190;</button>\n          <button id=\"brick-history-forward\" class=\"brick-ui-btn\" type=\"button\">&#x2192;</button>\n        </div>\n        <h1 id=\"story-title\">{{STORY_NAME}}</h1>\n        <ul id=\"brick-menu-core\">\n          <li><button id=\"brick-saves\" class=\"brick-ui-btn\" type=\"button\">SAVES</button></li>\n          <li><button id=\"brick-restart\" class=\"brick-ui-btn\" type=\"button\">RESTART</button></li>\n        </ul>\n      </aside>\n\n      <main id=\"brick-main\">\n        <noscript>JavaScript must be enabled to play this story.</noscript>\n      </main>\n    </div>\n    <dialog id=\"brick-dialog\"></dialog>\n    <script id=\"script-brick\" type=\"text/javascript\">\n      \"use strict\";(()=>{var tn=Object.create;var Se=Object.defineProperty;var nn=Object.getOwnPropertyDescriptor;var rn=Object.getOwnPropertyNames;var sn=Object.getPrototypeOf,on=Object.prototype.hasOwnProperty;var tt=e=>{throw TypeError(e)};var an=(e,t)=>()=>(e&&(t=e(e=0)),t);var cn=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),ln=(e,t)=>{for(var n in t)Se(e,n,{get:t[n],enumerable:!0})},un=(e,t,n,r)=>{if(t&&typeof t==\"object\"||typeof t==\"function\")for(let s of rn(t))!on.call(e,s)&&s!==n&&Se(e,s,{get:()=>t[s],enumerable:!(r=nn(t,s))||r.enumerable});return e};var mn=(e,t,n)=>(n=e!=null?tn(sn(e)):{},un(t||!e||!e.__esModule?Se(n,\"default\",{value:e,enumerable:!0}):n,e));var nt=(e,t,n)=>t.has(e)||tt(\"Cannot \"+n);var rt=(e,t,n)=>(nt(e,t,\"read from private field\"),n?n.call(e):t.get(e)),st=(e,t,n)=>t.has(e)?tt(\"Cannot add the same private member more than once\"):t instanceof WeakSet?t.add(e):t.set(e,n),ot=(e,t,n,r)=>(nt(e,t,\"write to private field\"),r?r.call(e,n):t.set(e,n),n);var y,f=an(()=>{y={major:0,minor:2,patch:2,version:\"0.2.2\"}});var at=cn((rr,it)=>{\"use strict\";f();it.exports=function(){function e(t,n,r,s,o){return t<n||r<n?t>r?r+1:t+1:s===o?n:n+1}return function(t,n){if(t===n)return 0;if(t.length>n.length){var r=t;t=n,n=r}for(var s=t.length,o=n.length;s>0&&t.charCodeAt(s-1)===n.charCodeAt(o-1);)s--,o--;for(var i=0;i<s&&t.charCodeAt(i)===n.charCodeAt(i);)i++;if(s-=i,o-=i,s===0||o<3)return o;var a=0,c,m,u,d,N,A,z,te,fe,Ye,Ze,Qe,$=[];for(c=0;c<s;c++)$.push(c+1),$.push(t.charCodeAt(i+c));for(var et=$.length-1;a<o-3;)for(fe=n.charCodeAt(i+(m=a)),Ye=n.charCodeAt(i+(u=a+1)),Ze=n.charCodeAt(i+(d=a+2)),Qe=n.charCodeAt(i+(N=a+3)),A=a+=4,c=0;c<et;c+=2)z=$[c],te=$[c+1],m=e(z,m,u,fe,te),u=e(m,u,d,Ye,te),d=e(u,d,N,Ze,te),A=e(d,N,A,Qe,te),$[c]=A,N=d,d=u,u=m,m=z;for(;a<o;)for(fe=n.charCodeAt(i+(m=a)),A=++a,c=0;c<et;c+=2)z=$[c],$[c]=A=e(z,m,A,fe,$[c+1]),m=z;return A}}()});f();f();f();f();var R={historyLength:100,maxLoopIterations:1e3,preProcessText:void 0,stream:!1};function pn(e,t,n){throw new TypeError(\"\".concat(e,\": expected \").concat(t,\", got \").concat(typeof n))}var b={get historyLength(){return R.historyLength},set historyLength(e){if(typeof e!=\"number\"||e<=0||e%1!==0)throw new TypeError(\"config.historyLength must be a positive integer\");R.historyLength=e},get maxLoopIterations(){return R.maxLoopIterations},set maxLoopIterations(e){if(typeof e!=\"number\"||e<=0||e%1!==0)throw new TypeError(\"Config.maxLoopIterations must be a positive integer\");R.maxLoopIterations=e},get preProcessText(){return R.preProcessText},set preProcessText(e){typeof e<\"u\"&&typeof e!=\"function\"&&pn(\"Config.preProcessText\",\"function or undefined\",e),R.preProcessText=e},get stream(){return R.stream},set stream(e){R.stream=!!e}};var re={};ln(re,{Passage:()=>q,filter:()=>pt,find:()=>En,get:()=>V,init:()=>$e,start:()=>Be,withTag:()=>xn});f();f();var ct=mn(at(),1),dn=new Set(\"'\\\",()[]{}.!`?\");function O(e){return Array.from(e).map(t=>t>=\"a\"&&t<=\"z\"||t>=\"0\"&&t<=\"9\"?t:t>=\"A\"&&t<=\"Z\"||t>\"\\x7F\"?t.toLowerCase():dn.has(t)?\"\":\"-\").join(\"\").replace(/-+/g,\"-\")}function lt(e,t){let n=-1,r=0;for(;n=e.indexOf(t,n+1),n!==-1;)r++;return r}function C(e){switch(typeof e){case\"bigint\":case\"boolean\":case\"number\":case\"string\":case\"undefined\":return e;case\"symbol\":throw new Error(\"Symbols cannot be cloned\");case\"function\":throw new Error(\"Functions cannot be cloned\");case\"object\":if(e===null)return e;if(\"clone\"in e&&typeof e.clone==\"function\")return e.clone();if(e instanceof Array)return e.map(C);if(e instanceof Date)return new Date(e);if(e instanceof Map){let t=new Map;for(let[n,r]of e)t.set(C(n),C(r));return t}else{if(e instanceof RegExp)return new RegExp(e);if(e instanceof Set){let t=new Set;for(let n of e)t.add(C(n));return t}else{let t=Object.getPrototypeOf(e);if(t!==null&&t!==Object.prototype)throw new Error(\"Can't clone an object with an unknown prototype and no `.clone()` method\");let n=Object.create(t);for(let r in e)n[r]=C(e[r]);return n}}default:throw new Error(\"Unknown type: \".concat(typeof e))}}function ut(e){if(e.length<1)throw new Error(\"either: array is empty\");return e[Le(e.length)]}function G(e){let t=document.getElementById(e);if(!t)throw new Error('No element with id \"'.concat(e,'\" found'));return t}function Le(e){return Math.floor(Math.random()*e)}var hn=0;function Ie(){return\"brick-unique-id-\".concat(hn++)}function l(e,t={},...n){let r=document.createElement(e);for(let s in t)r.setAttribute(s,t[s]);return r.append(...n),r}function*mt(e,t,n=1){let r;if(typeof t>\"u\"?(r=0,t=e):r=e,n>0)for(;r<t;)yield r,r+=n;else for(;r>t;)yield r,r+=n}function*ft(e,t=0){let n=t;for(let r of e)yield[n,r],n++}function B(e){return arguments.length===0?\"\":e instanceof Array&&!(Symbol.toPrimitive in e)&&e.toString===Array.prototype.toString?\"[\".concat(e.join(\", \"),\"]\"):String(e)}function De(e,t){t!=null||(t=(r,s)=>'Unknown property \"'.concat(r,'\". Did you mean \"').concat(s,'\"?'));let n={get(r,s,o){if(s in o||typeof s!=\"string\")return Reflect.get(r,s,o);let i=Object.getOwnPropertyNames(o),a=Object.getPrototypeOf(o);for(;a;)i.push(...Object.getOwnPropertyNames(a)),a=Object.getPrototypeOf(a);let c=i.map(u=>({name:u,distance:(0,ct.default)(s,u)})),{name:m}=c.reduce((u,d)=>d.distance<=s.length*.4&&d.distance<u.distance?d:u,{name:void 0,distance:1/0});return c.length>0&&console.warn(t(s,m)),Reflect.get(r,s,o)}};return new Proxy(e,n)}var ne,q=class{constructor(t){st(this,ne);var s;let n=t.getAttribute(\"pid\");if(!n)throw new Error(\"Passage has no pid: \"+t.outerHTML);let r=t.getAttribute(\"name\");if(!r)throw new Error(\"Passage \".concat(n,\" has no name\"));this.id=n,this.name=r,this.slug=O(r),this.tags=((s=t.getAttribute(\"tags\"))==null?void 0:s.split(\" \").filter(o=>o.length>=0))||[],ot(this,ne,t)}get content(){return rt(this,ne).textContent}toString(){return'Passage \"'.concat(this.name,'\"')}};ne=new WeakMap;var wn=[\"PassageDone\",\"PassageFooter\",\"PassageHeader\",\"PassageReady\",\"StoryAuthor\",\"StoryBanner\",\"StoryCaption\",\"StoryDisplayTitle\",\"StoryInit\",\"StoryMenu\",\"StorySettings\",\"StorySubtitle\",\"StoryTitle\"],yn=[\"init\",\"script\",\"stylesheet\",\"Twine.audio\",\"Twine.image\",\"Twine.video\",\"Twine.vtt\",\"widget\",\"header\",\"footer\",\"startup\",\"debug-header\",\"debug-footer\",\"debug-startup\",\"nobr\"];function bn(e){if(wn.includes(e))throw new Error('The passage name \"'.concat(e,'\" is not allowed'))}function kn(e,t){for(let n of e)if(yn.includes(n))throw new Error(\"The tag '\".concat(n,\"' on the passage \\\"\").concat(t,\" is not allowed\"))}var Ae=new Map,X=new Map,Ce;function $e(e){let t=e.getElementsByTagName(\"tw-passagedata\");for(let r of t){let s=new q(r),{id:o,name:i}=s;if(bn(s.name),s.name.startsWith(\"::\")&&console.warn('Found a passage named \"'.concat(i,'\". Although starting a passage name with \"::\" is allowed, this is likely a mistake.')),kn(s.tags,i),Ae.has(o))throw new Error(\"Duplicate passage id \".concat(o));if(X.has(i))throw new Error(\"Duplicate passage name \".concat(i));s.content.trim()||console.warn(\"Passage \".concat(i,\" has no text.\")),Ae.set(o,s),X.set(i,s)}let n=e.getAttribute(\"startnode\");if(n){let r=Ae.get(n);if(!r)throw new Error(\"Could not determine starting passage; no passage with \".concat(n));Ce=r}else{let r=X.get(\"Start\");if(!r)throw new Error('Could not find a passage named \"Start\"');Ce=r}}function pt(e){let t=[];for(let n of X.values())e(n)&&t.push(n);return t}function En(e){for(let t of X.values())if(e(t))return t}function V(e){return X.get(e)}function Be(){return Ce}function xn(e){return pt(t=>t.tags.includes(e))}f();f();var _=class extends Error{constructor(t,n,r){super(\"in \\u201C\".concat(n,\"\\u201D at line \").concat(r,\": \").concat(t)),this.passage=n,this.lineNumber=r}},U=class extends _{constructor(t,n){let r;try{r=\"@\".concat(t.name,\": \").concat(n instanceof Error?n.message:n)}catch(s){r=\"@\".concat(t.name,\": (error could not be converted to string)\")}super(r,t.passageName,t.lineNumber),this.cause=n}},pe=class extends _{constructor(t,n,r){let s;try{s='while evaluating the attribute \"'.concat(n,'\": ').concat(t instanceof Error?t.message:t)}catch(o){s='while evaluating the attribute \"'.concat(n,'\": (error could not be converted to string)')}super(s,r.passageName,r.lineNumber),this.cause=t}};f();f();var p={closeTag:/>/y,commentBlock:/\\*(?:[^])*?\\*\\//y,commentLine:/\\/.*\\n?/y,elementName:/([-\\p{ID_Continue}]+)(#[-\\p{ID_Continue}]+)?((?:\\.[-\\p{ID_Continue}]+)*)/uy,htmlAttr:/\\s*([-_\\p{ID_Start}][-\\p{ID_Continue}]*)=\"([^\"]*)\"/uy,htmlEvalAttr:/\\s*([-_\\p{ID_Start}][-\\p{ID_Continue}]*)=\\(/uy,js:{binaryOperator:/[%&*<=>^|]+/y,closingParen:/\\s*\\)/y,closingSquareBracket:/\\s*\\]/y,field:new RegExp(\"\\\\.\\\\p{ID_Start}[$\\\\p{ID_Continue}]*\",\"uy\"),identifier:new RegExp(\"\\\\p{ID_Start}[$\\\\p{ID_Continue}]*\",\"uy\"),number:/[0-9][0-9_]*/y,operator:/[!%&*+-<=>^|~]+/y,regexp:new RegExp(\"(?:[^\\\\\\\\[/]|\\\\\\\\[^]|\\\\[(?:[^\\\\\\\\\\\\]]|\\\\\\\\[^])*\\\\])*\\\\/(?:$|\\\\p{ID_Continue})*\",\"uy\"),stringDouble:/\"(?:[^\\\\\"]|\\\\[^])*\"/y,stringSingle:/'(?:[^\\\\']|\\\\[^])*'/y,normalInTemplateString:/(?:[^`$\\\\]|\\\\[^]|\\$(?!\\{))*/y},macroArgsStart:/ *\\(/y,macroBodyStart:/\\s*\\{/y,macroName:/[-_=<>\\p{ID_Start}][-=<>\\p{ID_Continue}]*/uy,maybeElementClose:/\\/[-\\p{ID_Continue}]+(?: *>)?/uy,normalChars:/[^[\\\\$_?<@/}]+/y,singleChar:/[^]/y,whitespace:/\\s*/y,wikiLink:/((?:[^\\\\\\]]|\\\\.)*)\\]\\]/y},vn=[\"base\",\"body\",\"link\",\"head\",\"html\",\"meta\",\"script\",\"style\",\"title\"],Nn=[\"area\",\"base\",\"br\",\"col\",\"embed\",\"hr\",\"img\",\"input\",\"link\",\"meta\",\"param\",\"source\",\"track\",\"wbr\"];function de(e){return typeof e==\"object\"&&e.type===\"macro\"}var Y=class{constructor(t,n,r){this.input=t,this.index=0,this.passageName=n,this.lineNumber=r||1}get[Symbol.toStringTag](){return this.constructor.name}consume(t){t.lastIndex=this.index;let n=t.exec(this.input);return n&&(this.lineNumber+=lt(n[0],\"\\n\"),this.index=t.lastIndex),n}lookahead(){return this.input[this.index]||null}locationSample(){if(this.input[this.index]===\"\\n\"){let r=this.input.lastIndexOf(\"\\n\",this.index-1)+1;return this.input.slice(r,this.index)}let t=this.input.lastIndexOf(\"\\n\",this.index-1)+1,n=this.input.indexOf(\"\\n\",this.index+1);return this.input.slice(t,n)}error(t){return{type:\"error\",passageName:this.passageName,lineNumber:this.lineNumber,message:t,locationSample:this.locationSample()}}parse(t){var s;let n=[],r=0;e:for(;this.index<this.input.length;){if(r>=1e6)return n.push(this.error(\"Parser stuck in infinite loop\")),n;r++;let o=this.index;if(this.consume(p.normalChars),this.index!==o&&n.push(this.input.substring(o,this.index)),t&&this.consume(t))return n;let i=(s=this.consume(p.singleChar))==null?void 0:s[0];switch(i){case\"\\\\\":{let a=this.consume(p.singleChar);n.push((a==null?void 0:a[0])||\"\\n\");break}case\"<\":n.push(this.parseElement());break;case\"@\":n.push(this.parseMacro());break;case\"/\":switch(this.lookahead()){case\"/\":this.consume(p.commentLine);break;case\"*\":if(!this.consume(p.commentBlock))return n.push(this.error(\"Missing trailing `*/` to close the block comment\")),n;break;default:n.push(i);break}break;case\"$\":{n.push(this.parseNakedVariable(\"story\"));break}case\"_\":{n.push(this.parseNakedVariable(\"temp\"));break}case\"[\":if(this.lookahead()===\"[\"){this.index++;let a=this.consume(p.wikiLink);if(!a){n.push(this.error(\"Unmatched `[[`\"));break}let c=a[1],m=c.includes(\"->\"),u=c.includes(\"<-\"),d=c.includes(\"|\"),N=Number(m)+Number(u)+Number(d);if(N>1)n.push(this.error(\"Link boxes can only have one of '->', '<-', or '|'\"));else if(N===0)n.push({type:\"linkBox\",passageName:this.passageName,lineNumber:this.lineNumber,link:c,text:c});else{let A=m?\"->\":u?\"<-\":\"|\";n.push(this.makeLinkBox(c,A))}}else n.push(\"[\");break;case\"}\":n.push(\"}\");break;case void 0:break e;default:throw new Error(\"Logic Error (\".concat(i,\")\"))}}return t&&!this.consume(t)&&n.push(this.error('Failed to match regex \"'.concat(t.source,'\"'))),n}parseElement(){let t=this.consume(p.elementName);if(!t){let c=this.consume(p.maybeElementClose);return c?this.error('Unexpected closing tag \"'.concat(c[0],'\"')):this.error('Element names can contain only hyphens, underscores, and ASCII letters and numbers. The \"<\" character must be escaped with a \"\\\\\" backslash if not used as an HTML element.')}let[,n,r,s]=t,o=new Map,i=new Map;for(r&&o.set(\"id\",r.slice(1)),s.length&&o.set(\"class\",s.replace(\".\",\" \").trim()),this.consume(p.whitespace);!this.consume(p.closeTag);){let c=this.consume(p.htmlAttr);if(c){let[m,u,d]=c;o.has(u)||i.has(u)?console.warn(\"Ignoring duplicate attribute '\".concat(u)):o.set(u,d)}else if(c=this.consume(p.htmlEvalAttr),c){let m=c[1],u=this.parseJsExpression();if(typeof u==\"object\")return u;if(u.trim()===\"\")return this.error('Empty JavaScript attribute \"'.concat(m,'\"'));if(this.lookahead()!==\")\")return this.error('No closing paren on dynamic attribute \"'.concat(m,'\"'));this.index++,o.has(m)||i.has(m)?console.warn(\"Ignoring duplicate attribute '\".concat(m)):i.set(m,u)}else return this.error(\"Missing trailing `>` to close the HTML tag\")}let a=Nn.includes(n)?[]:this.parse(new RegExp(\"</\".concat(n,\">\"),\"y\"));return vn.includes(n)?this.error('Passages cannot contain \"<'.concat(n,'>\" elements')):{type:\"element\",passageName:this.passageName,lineNumber:this.lineNumber,name:n,attributes:o,evalAttributes:i,content:a}}parseNakedVariable(t){let n=this.index,r=this.consume(p.js.identifier);if(!r){let i=t===\"story\"?\"$\":\"_\";return this.error(\"\".concat(i,\" must be part of a \").concat(t,\" variable, \").concat(\"or escaped with a backslash `\\\\`\"))}let s=r[0],o=this.index;for(;;){switch(this.lookahead()){case\".\":if(r=this.consume(p.js.field),r)continue;break;case\"[\":this.index++,this.parseJsArgs(\"]\");continue;case\"(\":this.index++,this.parseJsArgs(\")\");continue}break}return this.index===o?{type:t,passageName:this.passageName,lineNumber:this.lineNumber,name:s}:{type:\"macro\",name:\"print\",args:[(t===\"story\"?\"Engine.vars.\":\"Engine.temp.\")+this.input.substring(n,this.index)],passageName:this.passageName,lineNumber:this.lineNumber}}parseMacro(){let t=this.consume(p.macroName),n;if(t)n=t[0];else if(this.lookahead()===\"(\")n=\"\";else return this.error(\"`@` must be followed by a macro name, or be escaped with a `\\\\`\");let r=null;if(this.consume(p.macroArgsStart)){let i=n===\"for\"?this.parseForArgs():this.parseJsArgs(\")\");if(\"type\"in i)return i;r=i}let s=this.consume(p.macroBodyStart);if(!r&&!s)return this.error(\"Macro invocations must be followed by `(` or `[`\");let o=s?this.parse(/\\}/y):void 0;return{type:\"macro\",name:n,args:r||[],content:o,passageName:this.passageName,lineNumber:this.lineNumber}}parseForArgs(){let t=this.consume(/\\s*([^]*?)\\s+of\\b/y);if(!t)return this.error(\"Syntax: @for(_VAR of EXPRESSION)\");let n=t[1],r=this.parseJsExpression();return typeof r==\"object\"?r:r.trim()===\"\"?this.error(\"Syntax: @for(_VAR of EXPRESSION)\"):this.consume(/\\s*\\)/y)?[n,r]:this.error(\"@for: missing closing ')'\")}parseJsArgs(t){let n=[],r;for(;r=this.parseJsExpression();){if(typeof r==\"object\")return r;if(n.push(r),!this.consume(/\\s*,/uy))break}return this.consume(p.whitespace),this.lookahead()!==t?this.error(\"Missing a closing `\".concat(t,\"`\")):(this.index++,n)}parseJsExpression(){let t=[],n=[],r=!0,s,o=0;e:for(;this.index<this.input.length;){if(this.index===o)throw new Error(\"Infinite loop at index \".concat(o,\" (\").concat(this.input[this.index],\")\"));if(o=this.index,s=this.consume(p.whitespace),s&&n.push(s[0]),s=this.consume(p.js.identifier),s){n.push(s[0]),r=!1;continue}if(s=this.consume(p.js.number),s){n.push(s[0]),r=!1;continue}if(s=this.consume(p.js.binaryOperator),s){n.push(s[0]),r=!0;continue}let i=this.lookahead();switch(i){case'\"':if(s=this.consume(p.js.stringDouble),s)n.push(s[0]),r=!1;else return this.error(\"Unclosed double-quoted string\");break;case\"'\":if(s=this.consume(p.js.stringSingle),s)n.push(s[0]),r=!1;else return this.error(\"Unclosed single-quoted string\");break;case\"`\":this.index++,n.push(i),this.parseJsTemplateString(n),r=!1;break;case\"(\":t.push(\")\"),n.push(i),this.index++,r=!0;break;case\"[\":t.push(\"]\"),n.push(i),this.index++,r=!0;break;case\"{\":t.push(\"}\"),n.push(i),this.index++,r=!1;break;case\"$\":if(this.index++,s=this.consume(p.js.identifier),s)n.push(\"Engine.vars.\",s[0]),r=!1;else return this.error(\"Illegal identifier\");break;case\"_\":if(this.index++,s=this.consume(p.js.identifier),s)n.push(\"Engine.temp.\",s[0]),r=!1;else return this.error(\"Illegal identifier\");break;case\",\":if(t.length>0)this.index++,n.push(i),r=!0;else break e;break;case\"#\":case\":\":case\";\":case\"?\":case\".\":r=!0,n.push(i),this.index++;break;case\"!\":this.index++,this.lookahead()===\"=\"?(this.index++,this.lookahead()===\"=\"?(this.index++,n.push(\"!==\")):n.push(\"!=\"),r=!0):(n.push(i),r=!1);break;case\"+\":case\"-\":{n.push(i),this.index++;let a=this.lookahead();a===i?(n.push(a),this.index++,r=!1):a===\"=\"?(this.index++,r=!0,n.push(\"=\")):r=!0}break;case\"~\":n.push(i),this.index++,r=!0;break;case\"/\":if(this.index++,this.consume(p.commentLine))n.push(\"\\n\");else if(s=this.consume(p.commentBlock))s[0].includes(\"\\n\")&&n.push(\"\\n\");else if(r){if(n.push(i),s=this.consume(p.js.regexp),!s)return this.error(\"Invalid RegExp literal\");n.push(s[0]),r=!1}else n.push(i),r=!0;break;default:if(i&&i===t[t.length-1]){this.index++,n.push(i),t.pop();break}if(![\")\",\"]\",\"}\"].includes(i||\"\"))return this.error(\"Can't handle unescaped \".concat(i,\" yet\"));break e}}return t.length>0?this.error('Expected a \"'.concat(t.pop(),'\"')):n.join(\"\")}parseJsTemplateString(t){for(;;){let n=this.consume(p.js.normalInTemplateString);n&&t.push(n[0]);let r=this.lookahead();if(!r)return this.error(\"Unclosed template string\");switch(r){case\"`\":t.push(r),this.index++;return;case\"$\":{this.index+=2,t.push(\"${\");let s=this.parseJsExpression();if(typeof s==\"object\")return s;if(t.push(s),this.lookahead()!==\"}\")return this.error('missing \"}\" inside template string');this.index++,t.push(\"}\");break}default:return this.error(\"Logic Error: '\".concat(r,\"' (U+\").concat(r.charCodeAt(0),\") was not matched by regex\"))}}}makeLinkBox(t,n){let r=t.split(n);if(r.length!==2){let s='Links in [[...]] can only contain \"'.concat(n,'\" once');return this.error(s)}return n===\"<-\"?{type:\"linkBox\",passageName:this.passageName,lineNumber:this.lineNumber,link:r[0],text:r[1]}:{type:\"linkBox\",passageName:this.passageName,lineNumber:this.lineNumber,link:r[1],text:r[0]}}toString(){return\"[object Parser]\"}};f();var se={BRICK_VERSION:y,Engine:{forward:we,backward:ge,redo:gt,get vars(){return v},get temp(){return T}},config:b,Dialog:{showPassage:wt},passages:re,clone:C,either(e){if(arguments.length!==1)throw new Error(\"either(): exactly one argument required\");if(typeof e!=\"object\"||e===null)throw new Error(\"either(): first argument was not an array\");if(!(\"length\"in e)||typeof e.length!=\"number\")throw new Error(\"either(): first argument was not an array\");return ut(e)},enumerate:ft,makeElement:l,numberRange:mt,randomInt(e){if(arguments.length!==1)throw new Error(\"randomInt: exactly 1 argument required\");if(typeof e!=\"number\")throw new Error(\"randomInt: argument must be a number\");return Le(e)},slugify:O};se.BRICK_VERSION.toString=function(){return this.version};var dt=Object.keys(se),ht=Object.values(se);function oe(e){return new Function(...dt,\"'use strict';\".concat(e))(...ht)}function L(e){return oe(\"return \"+e)}function he(e,t){new Function(...dt,'\"use strict\"; '.concat(e,\" = arguments[arguments.length - 1]\"))(...ht,t)}var I=class{constructor(t){if(t.name!==\"break\"&&t.name!==\"continue\")throw new Error('BreakError requires a \"break\" or \"continue\" context');this.context=t,this.type=t.name}toString(){return\"Signal from @\".concat(this.type,' in \"').concat(this.context.passageName,'\" line ').concat(this.context.lineNumber)}},Z=class{constructor(t,n,r,s,o){this.name=t,this.content=o,this.passageName=n,this.lineNumber=r,s!=null&&s.captures&&(this.captures=s.captures)}createCallback(t){let n=this;return function(...s){if(!n.captures)return t.apply(this,s);let o={};for(let a of n.captures)a.name in o||(o[a.name]=T[a.name]),T[a.name]=a.value;let i;try{i=t.apply(this,s)}finally{Object.assign(T,o)}return i}}get[Symbol.toStringTag](){return this.constructor.name}},ie=new Map;function h(e,t){ie.has(e)&&console.warn('Replacing an existing macro: \"'.concat(e,'\"')),ie.set(e,t)}function ye(e,t){let n=ie.get(e);if(!n)throw new Error('No macro \"'.concat(e,'\" found'));ie.set(t,n)}function Pe(e){return ie.get(e)||null}h(\"include\",{handler(...e){if(e.length<1||e.length>2)throw new Error(\"must be called with 1 argument\");let[t,n]=e;if(typeof t!=\"string\")throw new Error(\"first arg (passage name) must be a string\");if(typeof n<\"u\"&&typeof n!=\"string\")throw new Error(\"second arg (element type) must be a string or undefined\");let s=l(n||\"div\");return P(s,t),s}});h(\"\",{skipArgs:!0,handler(...e){return oe(e.join(\", \")),document.createDocumentFragment()}});h(\"print\",{handler(...e){if(e.length!==1)throw new Error(\"requires 1 argument (got \".concat(e.length,\")\"));if(this.content)throw new Error(\"no body allowed\");return B(e[0])}});ye(\"print\",\"-\");h(\"render\",{handler(...e){if(e.length!==1)throw new Error(\"requires 1 argument (got \".concat(e.length,\")\"));if(this.content)throw new Error(\"no body allowed\");if(typeof e[0]!=\"string\")throw new Error(\"argument must be a string. Use the String() constructor if you want to convert a value to a string.\");let t=document.createDocumentFragment(),n=new Y(e[0],this.passageName,this.lineNumber);return k(t,n.parse()),t}});ye(\"render\",\"=\");h(\"link\",{handler(...e){if(e.length<1||e.length>3)throw new Error(\"requires 1, 2 or 3 arguments\");if(typeof e[0]!=\"string\")throw new Error(\"first argument (link text) must be a string\");let t=e[0],n,r;if(e.length===2)if(typeof e[1]==\"string\")n=e[1],r=void 0;else if(typeof e[1]==\"function\")n=void 0,r=e[1];else throw new Error(\"second argument must be a string or function\");else if(e.length===3){if(typeof e[1]==\"function\"&&typeof e[2]==\"string\")throw new Error(\"second argument must be a string and third argument must be a function\");if(typeof e[1]!=\"string\")throw new Error(\"second argument must be a string\");if(typeof e[2]!=\"function\")throw new Error(\"third argument must be a function\");n=e[1],r=e[2]}else console.warn(\"@link received only 1 argument. This link will do nothing when clicked.\"),n=void 0,r=void 0;let s=l(\"button\",{class:\"brick-link\",type:\"button\"},t);return n&&(s.dataset.linkDestination=n),s.addEventListener(\"click\",this.createCallback(function(o){r&&r.call(this,o),s.dataset.linkDestination&&yt(s.dataset.linkDestination)})),s}});h(\"linkReplace\",{handler(...e){if(e.length!==1)throw new Error(\"requires exactly 1 argument\");let[t]=e;if(typeof t!=\"string\")throw new Error(\"first arg (link text) must be a string\");let n=l(\"button\",{class:\"brick-link\",type:\"button\"},t);return n.addEventListener(\"click\",()=>{let r=l(\"span\",{class:\"brick-linkReplace brick-transparent\"});this.content&&k(r,this.content,this),n.replaceWith(r),setTimeout(()=>r.classList.remove(\"brick-transparent\"),40)}),n}});h(\"while\",{skipArgs:!0,handler(...e){if(e.some(o=>typeof o!=\"string\"))throw new Error(\"received a non-string arg\");let t=e.join(\",\"),n=document.createDocumentFragment(),{content:r}=this,s=1;for(;L(t);){if(s>b.maxLoopIterations)throw new Error(\"Too many iterations (Config.maxLoopIterations = \".concat(b.maxLoopIterations,\")\"));s++;try{if(!(r?k(n,r,this):!0))break}catch(o){if(o instanceof I){if(o.type===\"break\")break;continue}else throw o}}return n}});h(\"break\",{handler(){throw new I(this)}});h(\"continue\",{handler(){throw new I(this)}});h(\"for\",{skipArgs:!0,handler(...e){if(!e.every(u=>typeof u==\"string\"))throw new Error(\"received a non-string arg\");if(e.length!==2)throw new Error(\"requires exactly 2 arguments\");let[t,n]=e;if(!t.startsWith(\"_\"))throw new Error(\"loop variable must be a temp variable\");let r=t.substring(1),s=\"Engine.temp.\".concat(r),o=L(n);if(typeof o[Symbol.iterator]!=\"function\")throw new Error(\"Right-hand side must be an iterable value, such as an array\");let i=document.createDocumentFragment(),{content:a}=this,c=this.captures||[],m=1;for(let u of o){if(m>b.maxLoopIterations)throw new Error(\"Too many iterations (Config.maxLoopIterations = \".concat(b.maxLoopIterations,\")\"));m++,he(s,u),this.captures=[...c,{name:r,value:u}];try{if(!(a?k(i,a,this):!0))break}catch(d){if(d instanceof I){if(d.type===\"break\")break;continue}else throw d}}return this.captures=c,i}});h(\"checkBox\",{skipArgs:!0,handler(...e){if(e.length!==2)throw new Error(\"requires 2 arguments\");if(e.some(c=>typeof c!=\"string\"))throw new Error(\"both arguments must be strings\");let[t,n]=e,r=L(n);if(typeof r!=\"string\"&&!(r instanceof Node))throw new Error(\"label must be a string or Node\");let s=L(t),o=l(\"input\",{type:\"checkbox\",id:Ie()});o.checked=!!s,o.addEventListener(\"change\",()=>he(t,o.checked));let i=l(\"label\",{for:o.id},r);return l(\"div\",{},o,\" \",i)}});h(\"textBox\",{skipArgs:!0,handler(...e){if(e.length!==2)throw new Error(\"requires 2 arguments\");if(!e.every(c=>typeof c==\"string\"))throw new Error(\"both arguments must be strings\");let[t,n]=e,r=L(n);if(typeof r!=\"string\"&&!(r instanceof Node))throw new Error(\"label must be a string or Node\");let s=B(L(t)||\"\"),o=l(\"input\",{id:Ie(),type:\"text\",value:s});o.addEventListener(\"keyup\",()=>he(t,o.value));let i=l(\"label\",{for:o.id},r);return l(\"div\",{},o,\" \",i)}});h(\"switch\",{handler(...e){if(e.length!==1)throw new Error(\"requires 1 arg\");if(!this.content)throw new Error(\"requires a body\");let[t]=e,n=[];for(let s of this.content)if(typeof s==\"string\"){if(s.trim())throw new Error(\"all children must be @case macros\")}else if(s.type===\"macro\")n.push(s);else throw new Error(\"all children must be @case macros\");for(let s=0;s<n.length;s++){let o=n[s];if(o.name===\"default\"){if(s!==n.length-1)throw new Error(\"@default must be the last macro\");if(o.args.length>0)throw new Error(\"@default cannot receive any arguments\")}else{if(o.name!==\"case\")throw new Error(\"all children must be @case macros\");if(o.args.length===0)throw new Error(\"@case macro requires at least one argument\")}}let r=document.createDocumentFragment();for(let s of n){if(s.name===\"default\")return s.content&&k(r,s.content,this),r;for(let o of s.args){let i=L(o);if(t===i)return s.content&&k(r,s.content,this),r}}return r}});h(\"if\",{trailingMacros:[\"elseif\",\"else\"],handler(){if(!this.content)throw new Error(\"no child templates\");for(let e of this.content){if(!de(e))throw new Error(\"child was not a MacroTemplate\");if(e.name===\"else\"||L(e.args.join(\",\"))){let t=document.createDocumentFragment();return e.content&&k(t,e.content,this),t}}return document.createDocumentFragment()}});h(\"redoable\",{handler(){let{content:e}=this;if(!e)throw new Error(\"must be called with a body\");let t=l(\"span\",{class:\"brick-macro-redoable\"});try{this.content&&k(t,this.content,this)}catch(n){throw n instanceof I?new U(n.context,\"Can't @\".concat(n.type,\" from inside @\").concat(this.name)):n}return t.addEventListener(\"brick-redo\",()=>{t.innerHTML=\"\",this.content&&k(t,this.content,this)}),t}});h(\"later\",{handler(...e){if(e.length!==0&&e.length!==1)throw new Error(\"does not take any args\");let t=40;if(e.length===1){if(typeof e[0]!=\"number\")throw new Error(\"first argument must be a number\");t=e[0]}let{content:n}=this;if(!n)throw new Error(\"requires a body\");let r=l(\"span\",{class:\"brick-macro-later\",hidden:\"\"});return setTimeout(this.createCallback(()=>{let s=document.createDocumentFragment();k(s,n),r.replaceWith(s)}),t),r}});h(\"replace\",{handler(...e){if(e.length!==1)throw new Error(\"requires exactly one argument\");if(typeof e[0]!=\"string\")throw new Error(\"first argument must be a string\");let t=document.querySelector(e[0]);if(!t)throw new Error(\"The selector '\".concat(e[0],\"' did not match any elements\"));let n=document.createDocumentFragment();if(this.content)k(n,this.content,this);else if(this.name!==\"replace\")throw new Error('no content provided. Use \"{}\" to provide content.');switch(this.name){case\"append\":t.append(n);break;case\"prepend\":t.prepend(n);break;case\"replace\":t.innerHTML=\"\",t.append(n);break;default:throw new Error(\"Unknown name. Call this macro only with @append, @prepend, or @replace\")}return\"\"}});ye(\"replace\",\"append\");ye(\"replace\",\"prepend\");h(\"punt\",{skipArgs:!0,handler(...e){if(this.content)throw new Error(\"Does not take content\");if(e.length===0)throw new Error(\"requires at least one argument\");if(!e.every(t=>typeof t==\"string\"))throw new Error(\"received a non-string arg\");if(!e.every(t=>t.startsWith(\"Engine.temp.\")))throw new Error(\"only temp variables can be punted\");for(let t of e)bt(t.slice(12));return\"\"}});function ae(e){return console.error(e),l(\"span\",{class:\"brick-error\"},B(e))}function P(e,t){if(typeof t==\"string\"){let n=V(t);return n?P(e,n):(e.innerHTML=\"\",e.append(l(\"span\",{class:\"brick-error\"},'No passage named \"'.concat(t,'\" found'))),!1)}return e.innerHTML=\"\",e.classList.add(\"psg-\".concat(t.slug)),e.dataset.name=t.name,e.dataset.tags=t.tags.join(\" \"),k(e,t)}var be=1e3,Re=!1;function k(e,t,n){if(Re)return!1;if(be<=0){let s=(n==null?void 0:n.passageName)||t instanceof q&&t.name||\"unknown\",o=(n==null?void 0:n.lineNumber)||0,i=new _(\"Infinite recursion detected\",s,o);return e.append(ae(i)),Re=!0,!1}let r;try{be--,r=Tn(e,t,n)}finally{be++,be>=1e3&&(Re=!1)}return r}function Tn(e,t,n){let r=!0;if(t instanceof q){let s=b.preProcessText?b.preProcessText(t):t.content;if(typeof s!=\"string\")throw new TypeError(\"Config.preProcessText returned a \".concat(typeof s,\", expected a string\"));let o=new Y(s,t.name);return k(e,o.parse(),n)}for(let s=0;s<t.length;s++){let o=t[s],i;if(typeof o==\"string\"){i=o;let a=i.split(\"\\n\\n\"),c=a.shift();if(typeof c==\"string\")for(e.append(c);typeof(c=a.shift())==\"string\";)e.append(l(\"br\")),e.append(l(\"br\")),e.append(c)}else if(o.type===\"macro\"){let a=Pe(o.name);if(!a){let u=new _('Macro not found: \"'.concat(o.name,'\"'),o.passageName,o.lineNumber);e.append(ae(u)),r=!1;continue}let c,m;if(a.trailingMacros){let u=[o];for(let d=s+1;d<t.length;d++){let N=t[d];if(de(N)&&a.trailingMacros.includes(N.name))u.push(N),s=d;else if(!(typeof N==\"string\"&&!N.trim()))break}c=new Z(o.name,o.passageName,o.lineNumber,n,u),m=[]}else m=a.skipArgs?o.args:o.args.map(u=>L(u)),c=new Z(o.name,o.passageName,o.lineNumber,n,o.content);try{let u=a.handler.apply(c,m);e.append(u)}catch(u){if(u instanceof I)throw u;let d=u instanceof U?u:new U(c,u);e.append(ae(d))}}else if(o.type===\"element\")r=Mn(o,e,n)||r;else if(o.type===\"linkBox\"){let a=Pe(\"link\");if(!a)throw new Error(\"Can't find @link macro for wiki-style [[link]]\");if(!o.text)throw new Error(\"The text of a [[link box]] cannot be empty\");let c=new Z(\"link\",o.passageName,o.lineNumber);e.append(a.handler.call(c,o.text,o.link))}else if(o.type===\"error\")r=!1,e.append(ae(new _(o.message,o.passageName,o.lineNumber)));else{let a=(o.type===\"story\"?v:T)[o.name];e.append(B(a))}}return r}function Mn(e,t,n){let r=l(e.name);for(let[o,i]of e.attributes)r.setAttribute(o,i);for(let[o,i]of e.evalAttributes)try{let a=L(i);o.startsWith(\"on\")&&o.length>=3&&typeof a==\"function\"?r.addEventListener(o.substring(2),a):r.setAttribute(o,B(a))}catch(a){if(a instanceof I)throw a;return t.append(ae(new pe(a,o,e))),!1}let s=k(r,e.content,n);return t.append(r),s}f();f();var _e=(e,t)=>t.some(n=>e instanceof n),kt,Et;function Sn(){return kt||(kt=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Ln(){return Et||(Et=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var Fe=new WeakMap,Oe=new WeakMap,ke=new WeakMap;function In(e){let t=new Promise((n,r)=>{let s=()=>{e.removeEventListener(\"success\",o),e.removeEventListener(\"error\",i)},o=()=>{n(J(e.result)),s()},i=()=>{r(e.error),s()};e.addEventListener(\"success\",o),e.addEventListener(\"error\",i)});return ke.set(t,e),t}function Dn(e){if(Fe.has(e))return;let t=new Promise((n,r)=>{let s=()=>{e.removeEventListener(\"complete\",o),e.removeEventListener(\"error\",i),e.removeEventListener(\"abort\",i)},o=()=>{n(),s()},i=()=>{r(e.error||new DOMException(\"AbortError\",\"AbortError\")),s()};e.addEventListener(\"complete\",o),e.addEventListener(\"error\",i),e.addEventListener(\"abort\",i)});Fe.set(e,t)}var je={get(e,t,n){if(e instanceof IDBTransaction){if(t===\"done\")return Fe.get(e);if(t===\"store\")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return J(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t===\"done\"||t===\"store\")?!0:t in e}};function Tt(e){je=e(je)}function An(e){return Ln().includes(e)?function(...t){return e.apply(qe(this),t),J(this.request)}:function(...t){return J(e.apply(qe(this),t))}}function Cn(e){return typeof e==\"function\"?An(e):(e instanceof IDBTransaction&&Dn(e),_e(e,Sn())?new Proxy(e,je):e)}function J(e){if(e instanceof IDBRequest)return In(e);if(Oe.has(e))return Oe.get(e);let t=Cn(e);return t!==e&&(Oe.set(e,t),ke.set(t,e)),t}var qe=e=>ke.get(e);function Mt(e,t,{blocked:n,upgrade:r,blocking:s,terminated:o}={}){let i=indexedDB.open(e,t),a=J(i);return r&&i.addEventListener(\"upgradeneeded\",c=>{r(J(i.result),c.oldVersion,c.newVersion,J(i.transaction),c)}),n&&i.addEventListener(\"blocked\",c=>n(c.oldVersion,c.newVersion,c)),a.then(c=>{o&&c.addEventListener(\"close\",()=>o()),s&&c.addEventListener(\"versionchange\",m=>s(m.oldVersion,m.newVersion,m))}).catch(()=>{}),a}var $n=[\"get\",\"getKey\",\"getAll\",\"getAllKeys\",\"count\"],Bn=[\"put\",\"add\",\"delete\",\"clear\"],Ve=new Map;function xt(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t==\"string\"))return;if(Ve.get(t))return Ve.get(t);let n=t.replace(/FromIndex$/,\"\"),r=t!==n,s=Bn.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(s||$n.includes(n)))return;let o=async function(i,...a){let c=this.transaction(i,s?\"readwrite\":\"readonly\"),m=c.store;return r&&(m=m.index(a.shift())),(await Promise.all([m[n](...a),s&&c.done]))[0]};return Ve.set(t,o),o}Tt(e=>({...e,get:(t,n,r)=>xt(t,n)||e.get(t,n,r),has:(t,n)=>!!xt(t,n)||e.has(t,n)}));var Pn=[\"continue\",\"continuePrimaryKey\",\"advance\"],vt={},Ue=new WeakMap,St=new WeakMap,Hn={get(e,t){if(!Pn.includes(t))return e[t];let n=vt[t];return n||(n=vt[t]=function(...r){Ue.set(this,St.get(this)[t](...r))}),n}};async function*Rn(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;let n=new Proxy(t,Hn);for(St.set(n,t),ke.set(n,qe(t));t;)yield n,t=await(Ue.get(n)||t.continue()),Ue.delete(n)}function Nt(e,t){return t===Symbol.asyncIterator&&_e(e,[IDBIndex,IDBObjectStore,IDBCursor])||t===\"iterate\"&&_e(e,[IDBIndex,IDBObjectStore])}Tt(e=>({...e,get(t,n,r){return Nt(t,n)?Rn:e.get(t,n,r)},has(t,n){return Nt(t,n)||e.has(t,n)}}));var Lt,M;var It=[];async function Dt(e,t){Lt=\"brick.\".concat(O(e),\".\").concat(t),M=await Mt(Lt,1,{upgrade(n,r,s,o,i){n.createObjectStore(\"moments\",{autoIncrement:!0}),n.createObjectStore(\"histories\",{autoIncrement:!0,keyPath:\"id\"})}}),await Vn()}async function Vn(){let e=M.transaction(M.objectStoreNames,\"readwrite\"),t=e.objectStore(\"moments\");if(await t.count()>1e3){let r=await e.objectStore(\"histories\").getAll(),s=new Set;for(let i of r)for(let a of i.momentIds)s.add(a);let o=[];for await(let i of t)s.has(i.key)||o.push(i.delete());await Promise.all(o)}await e.done}async function Je(e){let t=await M.get(\"moments\",e);if(!t)throw new Error(\"Could not load moment \".concat(e));return{...t,vars:Q(t.vars)}}async function Ee(e){let t={...e,vars:Ke(e.vars,!1)};return await M.put(\"moments\",t)}async function We(e){return await M.get(\"histories\",e)}async function At(){return await M.getAll(\"histories\",IDBKeyRange.upperBound(\"\"))}async function Ct(e,t,n){let r={id:\"active\",momentIds:e,index:t,timestamp:Date.now(),title:n};await M.put(\"histories\",r)}async function $t(e,t,n){let r={momentIds:e,index:t,timestamp:Date.now(),title:n};return r.id=await M.put(\"histories\",r),r}async function Bt(){return await M.delete(\"histories\",\"active\")}async function Pt(){return await M.delete(\"histories\",IDBKeyRange.upperBound(\"\"))}async function Ht(e){return await M.delete(\"histories\",e)}async function Rt(e){let t=await We(e);if(!t)throw new Error(\"No history in slot \".concat(e));return{index:t.index,timestamp:t.timestamp,title:t.title,moments:await Promise.all(t.momentIds.map(async r=>{let s=await Je(r);return s.vars=Ke(s.vars,!0),s}))}}function g(e){throw new Error(\"Malformed save data: \".concat(e))}async function Ot(e){let t=await e.text(),n=JSON.parse(t);typeof n!=\"object\"||n===null||Array.isArray(n)?g(\"history is not an object\"):\"index\"in n?typeof n.index!=\"number\"?g(\"`index` property is not a number\"):\"timestamp\"in n?typeof n.timestamp!=\"number\"?g(\"`timestamp` property is not a number\"):\"title\"in n?typeof n.title!=\"string\"?g(\"`title` property is not a string\"):\"moments\"in n?Array.isArray(n.moments)||g(\"`moments` property is not an array\"):g(\"Missing `moments` property\"):g(\"Missing `title` property\"):g(\"Missing `timestamp` property\"):g(\"Missing `index` property\");let{moments:r}=n,s=await Promise.all(r.map(i=>(typeof i!=\"object\"||i===null?g(\"one or more moments are not objects\"):\"passageName\"in i?typeof i.passageName!=\"string\"?g(\"`passageName` property is not a string\"):\"timestamp\"in i?typeof i.timestamp!=\"number\"?g(\"`timestamp` property is not a number\"):\"turnCount\"in i?typeof i.turnCount!=\"number\"?g(\"`turnCount` property is not a number\"):\"vars\"in i?(typeof i.vars!=\"object\"||i.vars===null)&&g(\"`vars` property is not an object\"):g(\"missing `vars` property\"):g(\"missing `turnCount` property\"):g(\"missing `timestamp` property\"):g(\"missing `passageName` property\"),Ee({passageName:i.passageName,timestamp:i.timestamp,turnCount:i.turnCount,vars:Q(i.vars)})))),o={index:n.index,timestamp:n.timestamp,title:n.title,momentIds:s};return await M.put(\"histories\",o)}function Q(e){for(let t in e){let n=e[t];typeof n==\"object\"&&n!==null&&(e[t]=Q(n))}if(e instanceof Array&&typeof e[0]==\"string\")if(e[0].startsWith(\"!brick-revive:\")){let t=e[0].substring(14);if(![1,2].includes(e.length))throw new Error(\"malformed save data\");return _n(t,e[1])}else/^!{2,}brick-revive:/.test(e[0])&&(e[0]=e[0].substring(1));else if(e instanceof Map){let t=new Map;for(let[n,r]of e)typeof n==\"object\"&&n&&(n=Q(n)),typeof r==\"object\"&&r&&(r=Q(r)),t.set(n,r);return t}else if(e instanceof Set){let t=new Set;for(let n of e)typeof n==\"object\"&&n&&(n=Q(n)),t.add(n);return t}return e}function _n(e,t){switch(e){case\"undefined\":return;case\"pos-inf\":return 1/0;case\"neg-inf\":return-1/0;case\"nan\":return NaN;case\"bigint\":if(\"BigInt\"in window&&typeof window.BigInt==\"function\")return window.BigInt(t);throw new Error(\"This browser does not support BigInts\");case\"null-proto\":return Object.assign(Object.create(null),t);case\"Map\":if(!Array.isArray(t)||!t.every(r=>Array.isArray(r)&&r.length===2))throw new Error(\"Malformed save data. Could not revive a Map.\");return new Map(t);case\"Set\":if(!Array.isArray(t))throw new Error(\"Malformed save data. Could not revive a Set.\");return new Set(t);case\"Date\":if(typeof t!=\"string\")throw new Error(\"Malformed save data. Could not revive a Date object.\");return new Date(t);case\"RegExp\":{if(!Array.isArray(t)||t.length!==2||!t.every(o=>typeof o==\"string\"))throw new Error(\"Malformed save data. Could not revive a RegExp.\");let[r,s]=t;return new RegExp(r,s)}}let n=It.find(r=>r.name===e);if(!n)throw new Error('Malformed save data. Unknown type \"'.concat(e,'\".'));return n.deserialize(t)}function F(e,t){switch(typeof e){case\"boolean\":case\"string\":return e;case\"undefined\":return t?[\"!brick-revive:undefined\"]:e;case\"number\":if(t)switch(e){case 1/0:return[\"!brick-revive:pos-inf\"];case-1/0:return[\"!brick-revive:neg-inf\"];default:return Number.isNaN(e)?[\"!brick-revive:nan\"]:e}else return e;case\"bigint\":return t?[\"!brick-revive:bigint\",String(e)]:e;case\"function\":case\"symbol\":throw new Error(\"Cannot serialize a \".concat(typeof e));case\"object\":return e===null?null:Ke(e,t)}}function Ke(e,t){if(Array.isArray(e))return typeof e[0]==\"string\"&&/^!+brick-revive:/.test(e[0])?[\"!\"+e[0],...e.slice(1)]:e;if(e instanceof Map)if(t){let s=[];for(let[o,i]of e)s.push([F(o,t),F(i,t)]);return[\"!brick-revive:Map\",s]}else{let s=new Map;for(let[o,i]of e)s.set(F(o,t),F(i,t));return s}if(e instanceof Set)if(t){let s=[];for(let o of e)s.push(F(o,t));return[\"!brick-revive:Set\",s]}else{let s=new Set;for(let o of e)s.add(F(o,t));return s}if(e instanceof Date)return t?[\"!brick-revive:Date\",e.toJSON()]:e;if(e instanceof RegExp)return t?[\"!brick-revive:RegExp\",[e.source,e.flags]]:e;if(e instanceof Date||e instanceof RegExp)return e;for(let s of It)if(e instanceof s.constructor)return[\"!brick-revive:\".concat(s.name),F(s.serialize(e),t)];let n=Object.getPrototypeOf(e);if(n!==null&&n!==Object.prototype)throw new Error(\"Can't serialize an object with an unknown prototype\");let r={};for(let s in e)r[s]=F(e[s],t);return n===null?[\"!brick-revive:null-proto\",r]:r}var ee,S,D,E,W,j,K,v,T;function Fn(e,t){return typeof t==\"string\"?'Unknown story variable \"$'.concat(e,'\". Did you mean \"$').concat(t,'\"?'):'Unknown story variable \"$'.concat(e,'\".')}function jn(e,t){return typeof t==\"string\"?'Unknown temporary variable \"_'.concat(e,'\". Did you mean \"_').concat(t,'\"?'):'Unknown temporary variable \"_'.concat(e,'\".')}function ze(e){return De(e||{},Fn)}function Ge(){return De({},jn)}async function _t(){ee=G(\"brick-main\"),ee.innerHTML=\"\",S=[],D=[],E=-1,W=0,j=\"\",v=ze(),T=Ge(),K=[]}async function Ft(){if(!await xe(\"active\")){W=1,j=Be().name,v=ze(),T=Ge(),K=[];let e={passageName:j,timestamp:Date.now(),turnCount:W,vars:v};D=[e],S=[await Ee(e)],E=0,ve(),ce()}}async function Xe(){let e=D[E];e||(e=await Je(S[E]),D[E]=e),v=ze(C(e.vars)),W=e.turnCount,j=e.passageName}async function ge(){if(E===0)return!1;if(b.stream){let e=Array.from(document.querySelectorAll(\".brick-passage\"));for(let t of e.slice(-2))t.remove()}return E--,await Xe(),ve(),ce(),!0}async function we(){return E===S.length-1?!1:(E++,await Xe(),ve(),ce(),!0)}async function yt(e){j=typeof e==\"string\"?e:e.name,S.length=E+1,D.length=E+1,W++,K.length>0&&(v[\"-brick-punted\"]=K.map(n=>[n,T[n]]));let t={passageName:j,timestamp:Date.now(),turnCount:W,vars:C(v)};D.push(t),S.push(await Ee(t)),D.length>b.historyLength&&(D=D.slice(-b.historyLength),S=S.slice(-b.historyLength)),E=S.length-1,ve(),ce()}async function jt(){return await $t(S,E,qt())}async function xe(e){let t=await We(e);return t?(S=t.momentIds,D=Array(S.length),D.fill(void 0),E=t.index,await Xe(),ee.innerHTML=\"\",ce(),!0):!1}function qt(){return\"\".concat(j,\" | Turn \").concat(W)}function ve(){return Ct(S,E,qt())}function ce(){if(T=Ge(),K=[],\"-brick-punted\"in v&&v[\"-brick-punted\"]instanceof Array)for(let[r,s]of v[\"-brick-punted\"])typeof r!=\"string\"?console.warn(\"non-string key in $-brick-punted\"):T[r]=s;if(delete v[\"-brick-punted\"],b.stream){for(let r of ee.querySelectorAll(\":enabled\"))r.setAttribute(\"disabled\",\"\");for(let r of document.querySelectorAll(\".brick-active-passage\"))r.classList.remove(\"brick-active-passage\")}else ee.innerHTML=\"\";let e=l(\"article\",{class:\"brick-passage brick-active-passage brick-transparent\"});P(e,j);let t=V(\"StoryHeader\"),n=V(\"StoryFooter\");if(t){let r=l(\"header\");P(r,t),e.prepend(r)}if(n){let r=l(\"footer\");P(r,n),e.append(r)}ee.append(e),e.scrollIntoView(),setTimeout(()=>e.classList.remove(\"brick-transparent\"),40)}function Ut(){Bt(),window.location.reload()}function gt(){for(let e of document.querySelectorAll(\".brick-macro-redoable\"))e.dispatchEvent(new CustomEvent(\"brick-redo\"))}function bt(e){K.includes(e)&&console.warn(\"_\".concat(e,\" was already punted\")),K.push(e)}f();var Jt={generic:{cancel:\"Cancel\",restart:\"Restart\"},misc:{restartConfirmation:\"Are you sure you would like to restart?\"},savesDialog:{delete:\"Delete\",deleteAll:\"Delete All\",deleteMode:\"Delete\",export:\"Export\",exportMode:\"Export\",empty:\"No saves found\",import:\"Import\",loadSave:\"Load\",newSave:\"Save\",title:\"Saves\"}};var Un=Jt;function Jn(e,t){let n=t.split(\".\"),r=e,s;for(let[o,i]of n.entries()){if(!(i in r))throw new Error(\"Invalid key: \".concat(n.slice(0,o+1).join(\".\")));let a=r;if(o===n.length-1)s=a[i];else{if(typeof a[i]!=\"object\"||a[i]===null)throw new Error('\"'.concat(n.slice(0,o+1).join(\".\"),'\" is not an object'));r=a[i]}}return s}function w(e,t){let n;try{n=Jn(Un,e)}catch(r){console.error(r)}return typeof n==\"string\"?n:\"{{\".concat(e,\"}}\")}var x,le,H,Wt;function Kt(e){Wt=e;let t=G(\"brick-dialog\");if(t instanceof HTMLDialogElement)x=t;else throw new Error(\"#brick-dialog was not a <dialog> element\");Te(),x.addEventListener(\"click\",n=>{let r=x.getBoundingClientRect(),{clientX:s,clientY:o}=n;r.top<=o&&o<=r.top+r.height&&r.left<=s&&s<=r.left+r.width||x.close()})}function Te(){x.innerHTML=\"\",x.className=\"\",le=l(\"h1\");let e=l(\"div\",{},le);H=l(\"div\"),x.append(e,H)}function wt(e){Te(),le.append(e),P(H,e),x.showModal()}async function zt(){Te(),le.append(w(\"savesDialog.title\")),H.append(\"Loading...\"),x.classList.add(\"brick-saves-menu\"),x.showModal();let e=await At();e.sort((s,o)=>o.timestamp-s.timestamp);let t=await Promise.all(e.map(Gt));H.innerHTML=\"\";let n=l(\"ul\");H.append(n),t.length===0?n.append(l(\"li\",{class:\"brick-saves-empty\"},l(\"em\",{},w(\"savesDialog.empty\")))):n.append(...t);let r=l(\"div\",{class:\"brick-saves-buttons\"});Ne(n,r),H.append(r)}function Ne(e,t){let n=l(\"button\",{class:\"brick-ui-btn\"},w(\"savesDialog.deleteMode\"));n.addEventListener(\"click\",()=>{for(let a of e.querySelectorAll(\"button\"))a.removeEventListener(\"click\",ue),a.addEventListener(\"click\",Xt),a.textContent=\"Delete\";Wn(e,t)});let r=l(\"button\",{class:\"brick-ui-btn\"},w(\"savesDialog.exportMode\"));r.addEventListener(\"click\",()=>{for(let a of e.querySelectorAll(\"button\"))a.removeEventListener(\"click\",ue),a.addEventListener(\"click\",Yt),a.textContent=w(\"savesDialog.export\");Kn(e,t)});let s=l(\"input\",{type:\"file\"});s.addEventListener(\"change\",async()=>{if(!s.files||s.files.length===0)return;let a=await Ot(s.files[0]);console.log(a),x.close(),await xe(a)});let o=l(\"button\",{class:\"brick-ui-btn\"},w(\"savesDialog.import\"));o.addEventListener(\"click\",()=>s.click());let i=l(\"button\",{class:\"brick-ui-btn\"},w(\"savesDialog.newSave\"));i.addEventListener(\"click\",async()=>{var c;let a=await jt();(c=e.querySelector(\".brick-saves-empty\"))==null||c.remove(),e.prepend(Gt(a))}),t.innerHTML=\"\",t.append(n,r,o,i)}function Wn(e,t){let n=l(\"button\",{class:\"brick-ui-btn\",disabled:\"\"},w(\"savesDialog.deleteAll\"));n.addEventListener(\"click\",async function(){this.disabled=!0,await Pt(),e.innerHTML=\"\",e.append(l(\"li\",{},l(\"em\",{},\"No saves found\"))),Ne(e,t)}),setTimeout(()=>{n.disabled=!1},2e3);let r=l(\"button\",{class:\"brick-ui-btn\"},w(\"generic.cancel\"));r.addEventListener(\"click\",()=>{let s=w(\"savesDialog.loadSave\");for(let o of e.querySelectorAll(\"button\"))o.removeEventListener(\"click\",Xt),o.addEventListener(\"click\",ue),o.textContent=s;Ne(e,t)}),t.innerHTML=\"\",t.append(n,r)}function Kn(e,t){let n=l(\"button\",{class:\"brick-ui-btn\"},w(\"generic.cancel\"));n.addEventListener(\"click\",()=>{let r=w(\"savesDialog.loadSave\");for(let s of e.querySelectorAll(\"button\"))s.removeEventListener(\"click\",Yt),s.addEventListener(\"click\",ue),s.textContent=r;Ne(e,t)}),t.innerHTML=\"\",t.append(n)}function Gt(e){let t=new Date(e.timestamp).toLocaleString(),{id:n}=e;if(!n)throw new Error(\"Tried to create a save menu entry for an unsaved History\");let r=l(\"button\",{class:\"brick-ui-btn\",\"data-brick-history-id\":String(n)},w(\"savesDialog.loadSave\"));return r.addEventListener(\"click\",ue),l(\"li\",{},l(\"div\",{},e.title,l(\"br\"),l(\"small\",{},t)),r)}async function ue(){let e=Number(this.dataset.brickHistoryId);if(e!==e)throw new Error('Tried to load invalid ID \"'.concat(this.dataset.brickHistoryId,'\"'));if(x.close(),!await xe(e))throw new Error(\"Could not load history #\".concat(e))}async function Xt(){var n,r;let e=Number(this.dataset.brickHistoryId);if(e!==e)throw new Error('Tried to delete invalid ID \"'.concat(this.dataset.brickHistoryId,'\"'));await Ht(e);let t=(n=this.parentElement)==null?void 0:n.parentElement;(r=this.parentElement)==null||r.remove(),t&&t.childElementCount===0&&t.append(l(\"li\",{class:\"brick-saves-empty\"},l(\"em\",{},w(\"savesDialog.empty\"))))}async function Yt(){let e=Number(this.dataset.brickHistoryId);if(Number.isNaN(e))throw new Error('Tried to export invalid ID \"'.concat(this.dataset.brickHistoryId,'\"'));let t=await Rt(e),n=new Date(t.timestamp).toISOString().replace(/-|:|\\..*/g,\"\").replace(\"T\",\"-\"),r=\"\".concat(Wt,\"-\").concat(n,\".json\"),s=URL.createObjectURL(new Blob([JSON.stringify(t)],{type:\"application/json\"}));l(\"a\",{download:r,href:s}).click(),URL.revokeObjectURL(s)}function Zt(){Te(),x.classList.add(\"brick-restart\"),le.textContent=\"Restart\",H.append(l(\"p\",{},w(\"misc.restartConfirmation\")));let e=l(\"button\",{class:\"brick-ui-btn\"},w(\"generic.restart\"));e.addEventListener(\"click\",Ut);let t=l(\"button\",{class:\"brick-ui-btn\"},w(\"generic.cncel\"));t.addEventListener(\"click\",()=>x.close()),H.append(e,t),x.showModal()}window.addEventListener(\"error\",e=>{let{error:t}=e,n=\"\";t instanceof Error?(n+=\"Fatal Error!\\n\",n+=t.toString(),t.stack&&(n+=\"\\n\"+t.stack)):t instanceof I?n+=\"@\".concat(t.type,' was called outside a loop, at \"').concat(t.context.passageName,'\" line ').concat(t.context.lineNumber):(n+=\"Non-error object was thrown and not caught:\\n\",n+=B(e)),alert(n)});window.addEventListener(\"unhandledrejection\",e=>{let{reason:t}=e;alert(\"Fatal Error!\\n\".concat(t))});window.Brick=se;var me=document.getElementsByTagName(\"tw-storydata\")[0];$e(me);var Gn=me.querySelectorAll('style[type=\"text/twine-css\"]'),Xn=me.querySelectorAll('script[type=\"text/twine-javascript\"]'),Qt=V(\"StoryInterface\");Qt&&(G(\"brick-viewport\").outerHTML=Qt.content);var en=me.getAttribute(\"name\")||(()=>{throw new Error(\"Story has no title\")})(),Yn=me.getAttribute(\"ifid\")||\"00000000-0000-4000-A000-000000000000\";for(let e of Gn){let t=l(\"style\",{class:\"brick-author-style\"},e.textContent);document.head.appendChild(t)}function Me(e,t){var n;(n=document.getElementById(e))==null||n.addEventListener(\"click\",t)}Me(\"brick-history-backward\",ge);Me(\"brick-history-forward\",we);Me(\"brick-saves\",zt);Me(\"brick-restart\",Zt);async function Zn(){Kt(O(en)),await Dt(en,Yn),await _t();for(let e of Xn)oe(e.textContent);await Ft()}Zn();})();\n\n    </script>\n  </body>\n</html>\n","hydrate":"\"use strict\";function startState(){return{blockComment:!1,expectMacroBody:!1,js:!1,nesting:[],jsNesting:[]}}const KEYWORDS=\"break case catch class const continue debugger default delete do else export extends false finally for function if import in instanceof new null return super switch this throw true try typeof var void while with let static yield await enum implements interface package private protected public arguments as async eval from get of set undefined\".split(\" \"),OPERATORS=[\"!\",\"!=\",\"!==\",\"%\",\"%=\",\"&\",\"&&\",\"&=\",\"&&=\",\"*\",\"**\",\"*=\",\"**=\",\"+\",\"++\",\"+=\",\"-\",\"--\",\"-=\",\"/\",\"/=\",\"<\",\"<<\",\"<=\",\"<<=\",\"=\",\"==\",\"===\",\">\",\">>\",\">>>\",\">=\",\">>=\",\">>>=\",\"^\",\"^=\",\"|\",\"||\",\"|=\",\"||=\",\"~\"],RE_NUMBER_ERROR=/^[0-9.a-fA-F]+n?/,RE_NUMBER_LEADING_ZERO=/^(?:[bB](?:_?[01])+n?|[oO](?:_?[0-7])+n?|[xX](?:_?[0-9a-fA-F])+n?|n|(?:\\.(?:_?[0-9])*)?(?:[eE](?:_?[0-9])+)?)/,RE_POSTNUMBER_ERROR=/^[0-9\\p{ID_Start}]/u;function postNumberCheck(e){return e.match(RE_POSTNUMBER_ERROR)?\"error number\":\"number\"}function tokenJsNumber(e,n){if(n===\"0\"){if(e.match(RE_NUMBER_LEADING_ZERO))return postNumberCheck(e);if(e.eol()||e.peek().match(/^[^0-9\\p{ID_Start}]/u))return postNumberCheck(e)}else if(n===\".\"){if(e.match(/^(?:_?[0-9])+(?:[eE](?:_?[0-9])+)?/))return postNumberCheck(e)}else if(e.match(/^(?:(?:_?[0-9])*(?:\\.(?:_?[0-9])*)?(?:[eE](?:_?[0-9])+)?|(?:_?[0-9])*n)/))return postNumberCheck(e);return e.match(RE_NUMBER_ERROR),\"error number\"}function tokenJs(e,n){if(e.match(/^[!%&*+\\-<=>^|~]+/))return OPERATORS.includes(e.current())?\"operator\":\"error operator\";if(e.match(/^[$_a-zA-Z][$_a-zA-Z0-9]*/))return[\"$\",\"_\"].includes(e.current()[0])?\"variable-3\":KEYWORDS.includes(e.current())?\"keyword\":\"variable\";const r=e.next();if(r>=\"0\"&&r<=\"9\"||r===\".\"&&e.peek()>=\"0\"&&e.peek()<=\"9\")return tokenJsNumber(e,r);switch(r){case\"/\":return e.peek()===\"/\"?(e.skipToEnd(),\"comment\"):e.peek()===\"*\"?(e.next(),n.blockComment=!0,\"comment\"):(e.eat(\"=\"),\"operator\");case\"(\":return n.jsNesting.push(\")\"),\"bracket\";case\"{\":return n.jsNesting.push(\"}\"),\"bracket\";case\"[\":return n.jsNesting.push(\"]\"),\"bracket\";case\")\":case\"}\":case\"]\":return r===n.jsNesting[n.jsNesting.length-1]?(n.jsNesting.pop(),n.jsNesting.length===0?(n.js=!1,n.expectMacroBody=!0,e.eatSpace(),\"variable-2\"):\"bracket\"):\"bracket error\";case'\"':return e.match(/^(?:[^\\\\\"]|\\\\[^]])*\"/)?\"string\":(e.skipToEnd(),\"string error\");case\"'\":return e.match(/^(?:[^\\\\']|\\\\[^])*'/)?\"string\":(e.skipToEnd(),\"string error\");default:return e.eatSpace(),null}}function token(e,n){if(n.blockComment)return e.match(/^[^]*?\\*\\//)?n.blockComment=!1:e.skipToEnd(),\"comment\";if(n.js)return tokenJs(e,n);const r=e.next();if(n.expectMacroBody&&(n.expectMacroBody=!1,r===\"{\"))return n.nesting.push(\"}\"),\"bracket\";switch(r){case\"$\":case\"_\":return e.match(/^[$_a-zA-Z]/)?(e.match(/^[$_a-zA-Z0-9]*/),\"variable-3\"):\"error\";case\"/\":return e.peek()===\"/\"?(e.skipToEnd(),\"comment\"):e.peek()===\"*\"?(e.next(),n.blockComment=!0,\"comment\"):null;case\"@\":return e.match(/^[a-zA-Z]*\\s*\\(/)?(n.jsNesting=[\")\"],n.js=!0,\"variable-2\"):e.match(/^[a-zA-Z]*\\s*\\{/)?(e.backUp(1),n.expectMacroBody=!0,\"variable-2\"):\"error\";case\"}\":return n.nesting[n.nesting.length-1]===\"}\"?(n.nesting.pop(),\"bracket\"):null;case\"\\\\\":return e.next()?\"atom\":\"error\";default:return e.match(/^[^$_/@{}\\\\]*/),null}}function mode(){return{startState,token}}this.editorExtensions={twine:{\"^2.0.0\":{codeMirror:{mode}}}};\n","url":"https://github.com/cjneidhart/brick","license":"GPL-3.0"});